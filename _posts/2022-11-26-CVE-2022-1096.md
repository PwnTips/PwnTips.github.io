---
layout: post
title: "CVE-2022-1096 (WIP)"
---

CVE-2022-1096 是 CVE-2021-30551 的变种。

## 准备环境

阅读 [Google P0 的分析报告](https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1096.html) 得知修复的版本是 99.0.4844.84，搜到对应的[发布记录](https://chromereleases.googleblog.com/2022/03/stable-channel-update-for-desktop_25.html)，依照时间找到上一个版本是 [99.0.4844.82](https://chromereleases.googleblog.com/2022/03/stable-channel-update-for-desktop_20.html)，使用 [获取旧版本的 Chrome](2022-05-31-get-old-version-chrome-binary.md) 中的方法构建出对应的二进制文件。

## 分析成因

将 POC 代码稍加修改，方便调试：

```javascript
alert(1);
style = document.createElement('p').style;
style.prop = { toString: () => {
  style.prop = 1;
}};
alert(2)
```

根据之前调试 CVE-2021-30551 积累的经验，漏洞是在 v8/src/objects/objects.cc：`Object::SetProperty` 函数执行过程中触发的，在 alert(1) 弹出后，在 Object::SetProperty 函数开头下断点，然后点掉弹窗，让程序断下后开始调试。

```cpp
Maybe<bool> Object::SetProperty(LookupIterator* it, Handle<Object> value,
                                StoreOrigin store_origin,
                                Maybe<ShouldThrow> should_throw) {
  if (it->IsFound()) {
    bool found = true;
    Maybe<bool> result =
        SetPropertyInternal(it, value, should_throw, store_origin, &found);
    if (found) return result;
  }

  if (!CheckContextualStoreToJSGlobalObject(it, should_throw)) {
    return Nothing<bool>();
  }
  return AddDataProperty(it, value, NONE, should_throw, store_origin);
}
```

大体和 CVE-2021-30551 的流程一致，虽然 style 对象还没有名为 prop 的属性，但是由于 style 是 DOM 对象已经设置了 INTERCEPTOR， 属性的查找结果是找到了 INTERCEPTOR，it->IsFound() 条件满足，程序走到 SetPropertyInternal 中。

## 实现利用

