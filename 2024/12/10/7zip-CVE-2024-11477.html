<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>分析 7zip 漏洞 CVE-2024-11147(WIP) | PwnTips</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="分析 7zip 漏洞 CVE-2024-11147(WIP)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="分析一下 7zip 漏洞 CVE-2024-11477/ZDI-24-1532，查看 ZDI 公告 提取到关键点： 24.07 修复，之前的版本有问题：那么我们 DIFF 24.07 和 24.06 的代码 漏洞出现在 Zstandard 解压的代码中" />
<meta property="og:description" content="分析一下 7zip 漏洞 CVE-2024-11477/ZDI-24-1532，查看 ZDI 公告 提取到关键点： 24.07 修复，之前的版本有问题：那么我们 DIFF 24.07 和 24.06 的代码 漏洞出现在 Zstandard 解压的代码中" />
<link rel="canonical" href="https://pwntips.github.io/2024/12/10/7zip-CVE-2024-11477.html" />
<meta property="og:url" content="https://pwntips.github.io/2024/12/10/7zip-CVE-2024-11477.html" />
<meta property="og:site_name" content="PwnTips" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="分析 7zip 漏洞 CVE-2024-11147(WIP)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-10T00:00:00+08:00","datePublished":"2024-12-10T00:00:00+08:00","description":"分析一下 7zip 漏洞 CVE-2024-11477/ZDI-24-1532，查看 ZDI 公告 提取到关键点： 24.07 修复，之前的版本有问题：那么我们 DIFF 24.07 和 24.06 的代码 漏洞出现在 Zstandard 解压的代码中","headline":"分析 7zip 漏洞 CVE-2024-11147(WIP)","mainEntityOfPage":{"@type":"WebPage","@id":"https://pwntips.github.io/2024/12/10/7zip-CVE-2024-11477.html"},"url":"https://pwntips.github.io/2024/12/10/7zip-CVE-2024-11477.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://pwntips.github.io/feed.xml" title="PwnTips" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-LDS6Z1TT65"></script>
<script>
  window['ga-disable-G-LDS6Z1TT65'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LDS6Z1TT65');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">PwnTips</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">分析 7zip 漏洞 CVE-2024-11147(WIP)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-12-10T00:00:00+08:00" itemprop="datePublished">
        Dec 10, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>分析一下 7zip 漏洞 CVE-2024-11477/ZDI-24-1532，查看 <a href="https://www.zerodayinitiative.com/advisories/ZDI-24-1532/">ZDI 公告</a> 提取到关键点：</p>
<ul>
  <li>24.07 修复，之前的版本有问题：那么我们 DIFF 24.07 和 24.06 的代码</li>
  <li>漏洞出现在 <a href="https://en.wikipedia.org/wiki/Zstd">Zstandard</a> 解压的代码中</li>
</ul>

<p>DIFF</p>

<p><a href="https://sourceforge.net/projects/sevenzip/files/7-Zip/24.06/7z2406-src.7z/download">2406</a>
<a href="https://sourceforge.net/projects/sevenzip/files/7-Zip/24.07/7z2407-src.7z/download">2407</a></p>

<p>用 beyond compare 对比以后找到 C\ZstdDec.c 这个文件有如下修改:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">diff</span><span class="w"> </span><span class="nx">D:\Downloads\7z-compare\2406\C\ZstdDec.c</span><span class="w"> </span><span class="nx">D:\Downloads\7z-compare\2407\C\ZstdDec.c</span><span class="w">
</span><span class="n">diff</span><span class="w"> </span><span class="nt">--git</span><span class="w"> </span><span class="s2">"a/D:\\Downloads\\7z-compare\\2406\\C\\ZstdDec.c"</span><span class="w"> </span><span class="s2">"b/D:\\Downloads\\7z-compare\\2407\\C\\ZstdDec.c"</span><span class="w">
</span><span class="n">index</span><span class="w"> </span><span class="nx">fd0dbda..ef9eca3</span><span class="w"> </span><span class="nx">100644</span><span class="w">
</span><span class="o">---</span><span class="w"> </span><span class="s2">"a/D:\\Downloads\\7z-compare\\2406\\C\\ZstdDec.c"</span><span class="w">
</span><span class="o">+++</span><span class="w"> </span><span class="s2">"b/D:\\Downloads\\7z-compare\\2407\\C\\ZstdDec.c"</span><span class="w">
</span><span class="err">@@</span><span class="w"> </span><span class="nt">-1</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="err">@@</span><span class="w">
 </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">ZstdDec.c</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">Zstd</span><span class="w"> </span><span class="nx">Decoder</span><span class="w">
</span><span class="nt">-2024-05-26</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">developed</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">Igor</span><span class="w"> </span><span class="nx">Pavlov</span><span class="p">,</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Zstandard</span><span class="w"> </span><span class="nx">format</span><span class="w">
</span><span class="o">+</span><span class="mi">2024</span><span class="nt">-06-18</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">developed</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">Igor</span><span class="w"> </span><span class="nx">Pavlov</span><span class="p">,</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Zstandard</span><span class="w"> </span><span class="nx">format</span><span class="w">
              </span><span class="n">specification</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">original</span><span class="w"> </span><span class="nx">zstd</span><span class="w"> </span><span class="nx">decoder</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">reference</span><span class="w"> </span><span class="nx">code.</span><span class="w">
 </span><span class="n">original</span><span class="w"> </span><span class="nx">zstd</span><span class="w"> </span><span class="nx">decoder</span><span class="w"> </span><span class="nx">code:</span><span class="w"> </span><span class="nx">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">Facebook</span><span class="p">,</span><span class="w"> </span><span class="nx">Inc.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">
 </span><span class="n">This</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">licensed</span><span class="w"> </span><span class="nx">under</span><span class="w"> </span><span class="nx">BSD</span><span class="w"> </span><span class="nx">3-Clause</span><span class="w"> </span><span class="nx">License.</span><span class="w">
</span><span class="err">@@</span><span class="w"> </span><span class="nt">-1308</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="o">+</span><span class="mi">1308</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="err">@@</span><span class="w"> </span><span class="n">FSE_Decode_SeqTable</span><span class="p">(</span><span class="n">CFseRecord</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">table</span><span class="p">,</span><span class="w">
   </span><span class="n">in-</span><span class="err">&gt;</span><span class="nx">len--</span><span class="p">;</span><span class="w">
   </span><span class="p">{</span><span class="w">
     </span><span class="n">const</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="o">*</span><span class="nx">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in-</span><span class="err">&gt;</span><span class="nx">ptr</span><span class="p">;</span><span class="w">
</span><span class="o">-</span><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="nx">sym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">sym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">
     </span><span class="n">in-</span><span class="err">&gt;</span><span class="nx">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">1</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="w"> </span><span class="n">numSymbolsMax</span><span class="p">)</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="kr">return</span><span class="w"> </span><span class="n">SZ_ERROR_DATA</span><span class="p">;</span><span class="w">
     </span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FastInt32</span><span class="p">)</span><span class="n">sym</span><span class="w">
       </span><span class="c">#if defined(Z7_ZSTD_DEC_USE_ML_PLUS3)</span><span class="w">
         </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">numSymbolsMax</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NUM_ML_SYMBOLS</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="nx">MATCH_LEN_MIN</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>根据这个修改我们可以大胆推测，这里是从字节流中读出 1 字节的某个结构的数量，之前没有验证这个数量是否超出了正常的范围，所以产生了漏洞。
接下来我们要验证这个的猜测，并且构造一个 POC 出来。</p>

<p>先要了解一下 .zst 文件格式的信息，可以搜到一个 facebook 官方的<a href="https://github.com/facebook/zstd/blob/dev/doc/zstd_compression_format.md">文档</a> ，阅读后得知：</p>
<ul>
  <li>.zst 文件是由多个 frame 组成的, frame 以魔法数 0xFD2FB528 开头</li>
  <li>每个 frame 可以包含 1-n 个 data_block，data_block 有多种类型，储存压缩数据的是 Compressed_Block</li>
  <li>Compressed_Block 包含 Literals Section 和 Sequence Section 两部分</li>
</ul>

<p>再来结合代码，被修改的函数是 <code class="language-plaintext highlighter-rouge">FSE_Decode_SeqTable</code>, 仅在 <code class="language-plaintext highlighter-rouge">ZstdDec1_DecodeBlock</code> 函数中有 3 处引用，且这三处引用相邻，应该是解码 data_block 的一个步骤。结合文档分析代码，发现函数 <code class="language-plaintext highlighter-rouge">ZstdDec1_DecodeBlock</code>  实际上在处理 Compressed_Block，函数 <code class="language-plaintext highlighter-rouge">FSE_Decode_SeqTable</code> 在处理 Sequences Section, 被修改的代码行，是在解码 Compressed_mode 为 RLE_Mode 的 sequence 数据，读到 <code class="language-plaintext highlighter-rouge">sym</code> 变量的值是 Literals_Length_Table/Offset_Table/Match_Length_Table 的内容，是攻击者可控的，<code class="language-plaintext highlighter-rouge">table[0] = sym</code> 是将其保存到了一个 <code class="language-plaintext highlighter-rouge">CZstdDecFseTables</code> 结构体，以供后续使用。接下来分析这个值在哪里使用，目前高度怀疑是后面紧接着会调用的 <code class="language-plaintext highlighter-rouge">Decompress_Sequences</code> 函数中，但是此函数用了大量的宏，直接分析起来很不方便，先用 VC 编译器的功能得到一份预处理之后的代码</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;</span><span class="w"> </span><span class="c"># Visual Studio Developer Powershell 中运行，否则可能报错没找到 cl</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="nx">/P</span><span class="w"> </span><span class="nx">c\ZstdDec.c</span><span class="w"> 
</span><span class="err">&gt;</span><span class="w"> </span><span class="c"># 可选步骤，只是格式化代码，如果装 VS 时候没有选装 llvm 可能会缺少 clang-format</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">clang-format</span><span class="w"> </span><span class="nx">ZstdDec.i</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ZstdDec.i.c</span><span class="w"> 
</span></code></pre></div></div>

<p>阅读以后就可以证实，存入 <code class="language-plaintext highlighter-rouge">CZstdDecFseTables</code> 的值，就是在 <code class="language-plaintext highlighter-rouge">Decompress_Sequences</code> 中使用的，Decompress_Sequences 是 tANS/FSE 解码算法的实现，这个算法是 zstd 压缩率能高与其他仅基于 huffman 编码的压缩软件的核心因素，我认为还比较复杂，不过对于我们漏洞分析的目标来说，也不需要了解很多，参考 <a href="https://medium.com/@bredelet/understanding-ans-coding-through-examples-d1bebfc7e076">understanding-ans-coding-through-examples-d1bebfc7e076</a> 可以得到解码的操作重点如下：</p>
<ul>
  <li>解码需要三个输入参数：状态 x、速查表 table、字节流 bitStream</li>
  <li>速查表存储了每个状态对应的：符号 S, 以及状态转移需要的参数 y、k（使用方式例如 table[x].S、table[x].y、table[x].k，但是实际算法是有优化的，S、y、k 三个值被存入了同一个 DWORD 中，用位操作代替了这些成员变量访问)</li>
  <li>解码涉及到多轮迭代，每轮都会：
    <ul>
      <li>根据当前状态从速查表查出解码的符号 S（解压后得到的原始值）</li>
      <li>将 x 转移到新状态：状态转移需要 x、y、k、bitStream 参与运算</li>
    </ul>
  </li>
  <li>回顾一下 Sequence Section 的结构：
    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">Sequences_Section_Header</code></td>
              <td>[<code class="language-plaintext highlighter-rouge">Literals_Length_Table</code>]</td>
              <td>[<code class="language-plaintext highlighter-rouge">Offset_Table</code>]</td>
              <td>[<code class="language-plaintext highlighter-rouge">Match_Length_Table</code>]</td>
              <td>bitStream</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>Xxxxx_Table 存储的就是速查表，因为存储了 Literals_Length、Offset、Match_Length 三种数据，所以是三个速查表</li>
      <li>bitStream，其实是 Literals_Length、Offset、Match_Length 三个数据流交叉存放在一起形成的一个数据流</li>
    </ul>
  </li>
  <li>另外解码时 bitStream 是从最后一个字节开始，反向使用的。因为编码时是将状态信息正向写入的 bitStream，解码的时候要从最后一个状态开始(编码器眼里的最后一个），反向恢复，恢复出的原数据也是反向的</li>
  <li>至于为什么这样解码可以解压数据，x、tab、bitStream、y、k 又都是怎么来的，感兴趣的话大家可以深入去学习 tANS 算法，这里就不展开了，只需要知道这个算法的解码就是在做这些操作即可</li>
</ul>

<hr />
<p>ℹ️ 如果想深入了解 tANS/FSE，如下资料可以参考：</p>
<ul>
  <li>https://www.cnblogs.com/zblade/p/14338758.html</li>
  <li>https://bjlkeng.io/posts/lossless-compression-with-asymmetric-numeral-systems/</li>
  <li>https://kedartatwawadi.github.io/post–ANS/</li>
  <li>https://fastcompression.blogspot.com/2013/12/finite-state-entropy-new-breed-of.html</li>
  <li>http://cbloomrants.blogspot.fr/2014/02/02-18-14-understanding-ans-conclusion.html</li>
</ul>

<hr />

<p>了解了这些，就可以知道，攻击者可控的数据 <code class="language-plaintext highlighter-rouge">sym</code>，就是速查表里存储的内容，解码的时候确实会用到它，不过这里要注意速查表里的元素是 32 比特的，而我们只能控制这 32 位的低 8 位，再结合代码来看，<code class="language-plaintext highlighter-rouge">Decompress_Sequences</code> 函数中的临时变量 <code class="language-plaintext highlighter-rouge">state_ll</code>、<code class="language-plaintext highlighter-rouge">state_of</code>、<code class="language-plaintext highlighter-rouge">state_ml</code> 是从速查表中查到的值，它们的最低字节又会传递到 <code class="language-plaintext highlighter-rouge">of_code</code>、<code class="language-plaintext highlighter-rouge">matchLen</code>、<code class="language-plaintext highlighter-rouge">litLen</code>。（也就是说速查表存储的 32 比特元素，低 8 位存放的是符号 S）而 <code class="language-plaintext highlighter-rouge">of_code</code>、<code class="language-plaintext highlighter-rouge">matchLen</code>、<code class="language-plaintext highlighter-rouge">litLen</code>，又在几处内存访问的地方被当作索引/长度来使用，如果在这些内存访问的地方，也没有检查索引/长度的合理性的话，就会产生内存访问越界了。例如:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//from ZstdDec.i.c
//...
static const UInt32 k_SEQ_LL_BASES[36] = {
    0,     1,     2,     3,     4,      5,      6,      7,      8,
    9,     10,    11,    12,    13,     14,     15,     16,     18,
    20,    22,    24,    28,    32,     40,     48,     64,     0x80,
    0x100, 0x200, 0x400, 0x800, 0x1000, 0x2000, 0x4000, 0x8000, 0x10000};
#line 286 ".\\ZstdDec.c"

static const Byte k_SEQ_LL_EXTRA[36] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0,  0,  0,  0,  1,  1,
    1, 1, 2, 2, 3, 3, 4, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16};

//....

const unsigned extra = k_SEQ_LL_EXTRA[litLen];
litLen = k_SEQ_LL_BASES[litLen];

</code></pre></div></div>

<hr />
<p>ℹ️ 也可以通过阅读原代码，在宏定义中发现速查表中存储的信息的格式：</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define FSE_REC_LEN_OFFSET    8
#define FSE_REC_STATE_OFFSET  16
#define GET_FSE_REC_SYM(st)   ((Byte)(st))
#define GET_FSE_REC_LEN(st)   ((Byte)((st) &gt;&gt; FSE_REC_LEN_OFFSET))
#define GET_FSE_REC_STATE(st) ((st) &gt;&gt; FSE_REC_STATE_OFFSET)
</span></code></pre></div></div>
<hr />

<p>使用 <code class="language-plaintext highlighter-rouge">litLen</code> 作为下标访问了两个数组，两个数组的长度都小于 <code class="language-plaintext highlighter-rouge">litLen</code> 可能的最大取值，很可能可以构造出能触发越界读的样本。</p>

<p>下面我们就结合调试器，构造出对应的样本，触发越界访问。先从源码构建出可执行文件，整个项目包含多个可执行文件，我选择了 7zcl.exe、7z.dll 作为调试目标，用 nmake 来构建，构建 Debug 版本以方便调试，方案是参考 <a href="https://stackoverflow.com/questions/56436451/nmake-how-do-i-force-a-debug-build-7zip">stackoverflow nmake-how-do-i-force-a-debug-build-7zip</a> 。</p>
<ul>
  <li>修改 CPP/7zip/UI/Client7z/Client7z.cpp:64 的代码 <code class="language-plaintext highlighter-rouge">DEFINE_GUID_ARC (CLSID_Format, 0xe)</code>
    <ul>
      <li>0xe 是 zstd 文档对应的 arc ID</li>
      <li>可以在 CPP/7zip/Archive/ZstdHandler.cpp 的 <code class="language-plaintext highlighter-rouge">REGISTER_ARC_IO</code> 宏调用中找到</li>
    </ul>
  </li>
  <li>修改 CPP/Build.mak 的 CFLAGS 和 LFLAGS，以构建调试版的可执行文件以及对应的 .pdb 文件：
    <ul>
      <li>CFLAGS 中的 -O1 -O2 都改成 -Od 禁用优化</li>
      <li>CFLAGS 加入 /Zi 以生成调试符号</li>
      <li>CFLAGS 去掉 -W4 和 -Wall，以解决编译过程中由于警告造成的编译失败</li>
      <li>LFLSGS 加入 /DEBUG</li>
    </ul>
  </li>
  <li>在 VS Developer Powershell 执行构建操作
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">pushd</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="c"># 构建client7z.exe</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="nx">CPP\7zip\UI\Client7z</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">nmake</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">popd</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="c"># 构建 7z.dll</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="nx">CPP\7zip\Bundles\Format7zF</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">nmake</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="c"># 拷贝 7z.dll 7z.pdb 到 client7z.exe 同目录</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">.</span><span class="nx">\o\7z.dll</span><span class="w"> </span><span class="o">..</span><span class="nx">\..\UI\Client7z\o\</span><span class="w">
  </span><span class="err">&gt;</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">.</span><span class="nx">\o\7z.pdb</span><span class="w"> </span><span class="o">..</span><span class="nx">\..\UI\Client7z\o\</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>有了 Client7z.exe 和 7z.dll 就可以调试了，对于有源码的场景，我喜欢用 VS 来调试:</p>
<ul>
  <li>用 VS 的 Open Folder 功能将 7zip 的源码目录作为项目打开</li>
  <li>在 VS 的解决方案浏览器，找到 Client7z.exe （在 CPP/7zip/UI/Client7z/o/Client7z.exe)</li>
  <li>右键菜单 -&gt; Set As Startup Item</li>
  <li>右键菜单 -&gt; Add Debug Configuration -&gt; Default</li>
  <li>在自动打开的 lauch.vs.json 中加入命令行配置 <code class="language-plaintext highlighter-rouge">args</code>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"defaults"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"project"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CPP</span><span class="se">\\</span><span class="s2">7zip</span><span class="se">\\</span><span class="s2">UI</span><span class="se">\\</span><span class="s2">Client7z</span><span class="se">\\</span><span class="s2">o</span><span class="se">\\</span><span class="s2">7zcl.exe"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"projectTarget"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7zcl.exe"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"args"</span><span class="p">:[</span><span class="s2">"7zcl.exe"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"poc.zst"</span><span class="p">],</span><span class="w"> 
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>这样配置好以后，在 VS 中点击开始调试，VS 就会用指定的命令行为我们启动一个 7zcl.exe 并开始调试了。参数中指定了用 7zcl.exe 来解压一个 poc.zst 文件，我们还需要构造出这个 poc 文件。我的构造方式是找到一个小的 .zst 文件，在它的基础上进行修改。所以我安装了压缩程序 zstd 压缩了一个随便找的小文件，得到下面这个 poc.zst 文档(base64 编码的数据)。</p>

<pre><code class="language-base64">KLUv/WSBAJ0HAFJNLiUgjegBs3wDbJDe4r8UR0hA5BmkXH0Jy6Cv+C63gaF/CdCKP4IGzBhJZOKUqtIw7n20LSBY3uBwWZSIl6jJcpCpKCCYttankcF0jCQycelqTFPTw5UYKgg9+Quz+k+L7D+0xU4we2fpP+lo+E9CaGFW3b/pbGySfuPgbfN4At3MIB0AoGin69MidMwSqMkZFESlIF1t4b5wb6c/QtDCf8wG2ulGNJ+E4CNaZ786OsHs3skrTTv9TBoFFQBCO8DJOEBhX52cCLeAtQPAymDVhpcMuG58YyM4JrMaHiov0xxbDWxBoGAlONs9w+AyrI8oe8zKBHY=
</code></pre>

<hr />
<p>ℹ️ 也可以直接使用这个 <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)&amp;input=S0xVdi9XU0JBSjBIQUZKTkxpVWdqZWdCczN3RGJKRGU0cjhVUjBoQTVCbWtYSDBKeTZDditDNjNnYUYvQ2RDS1A0SUd6QmhKWk9LVXF0SXc3bjIwTFNCWTN1QndXWlNJbDZqSmNwQ3BLQ0NZdHRhbmtjRjBqQ1F5Y2VscVRGUFR3NVVZS2dnOStRdXoraytMN0QrMHhVNHdlMmZwUCtsbytFOUNhR0ZXM2IvcGJHeVNmdVBnYmZONEF0M01JQjBBb0dpbjY5TWlkTXdTcU1rWkZFU2xJRjF0NGI1d2I2Yy9RdERDZjh3RzJ1bEdOSitFNENOYVo3ODZPc0hzM3NrclRUdjlUQm9GRlFCQ084REpPRUJoWDUyY0NMZUF0UVBBeW1EVmhwY011RzU4WXlNNEpyTWFIaW92MHh4YkRXeEJvR0FsT05zOXcrQXlySThvZTh6S0JIWT0&amp;oeol=VT">CyberChef 页面</a>下载 .zst 文档</p>

<hr />

<p>接下来我调试了 Client7z.exe 解压 poc.zst 的过程，发现 poc.zst 的 Symbol compression modes (0xC7 偏移处)  全为 0。
<img src="/assets/images/Pasted image 20241210144512.png" alt="" /></p>

<p>为了触发漏洞，我把他改成 <code class="language-plaintext highlighter-rouge">0b01010100</code>，再把后面 3 字节的数据全改成 <code class="language-plaintext highlighter-rouge">0xff</code>。</p>

<p><img src="/assets/images/Pasted image 20241210145918.png" alt="" /></p>

<p>改完后再次调试，发现已经可以触发越界读。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ZstdDec.c:2197</span>
<span class="kt">size_t</span> <span class="n">litLen</span> <span class="o">=</span> <span class="n">GET_FSE_REC_SYM</span><span class="p">(</span><span class="n">STATE_VAR</span><span class="p">(</span><span class="n">ll</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">litLen</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// if (STATE_VAR(ll) &amp; 0x70)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">litLen</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">extra</span> <span class="o">=</span> <span class="n">BASES_TABLE</span><span class="p">(</span><span class="n">SEQ_LL_EXTRA</span><span class="p">)</span> <span class="p">[</span><span class="n">litLen</span><span class="p">];</span> <span class="c1">// 运行到这里 litLen 为 0xff 已经超出了 k_SEQ_LL_EXTRA 数组的边界</span>
	<span class="n">litLen</span> <span class="o">=</span> <span class="n">BASES_TABLE</span><span class="p">(</span><span class="n">SEQ_LL_BASES</span><span class="p">)</span> <span class="p">[</span><span class="n">litLen</span><span class="p">];</span> <span class="c1">// 这里也是</span>
	<span class="cp">#ifdef Z7_ZSTD_DEC_USE_64BIT_LOADS
</span></code></pre></div></div>

<p>虽然可以触发漏洞了，但是由于这两个数组都是 static 数组，存储在 7z.dll 的 .rdata 段的，越界读刚好可以读到其他只读数据，不会触发崩溃，一个不会触发崩溃的 POC，总感觉差点什么，而且公告里说这个漏洞是可以造成一个 underflow 的，和我们分析的情况也明显不一样，所以接下来我们继续分析看怎么才能触发崩溃/ underflow。</p>

<p><strong>未完待续</strong></p>

<h2 id="typo">Typo</h2>

<p>分析漏洞的过程中还在 7z 项目中发现一个 typo，有空去刷一个 COMMIT 🙃</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// CPP/7zip/Archive/ArchiveExports.cpp:50 
static int FindFormatCalssId(const GUID *clsid) // Calss -&gt; Class
</code></pre></div></div>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = '';
      this.page.identifier = 'https://pwntips.github.io/2024/12/10/7zip-CVE-2024-11477.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://PwnTips.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2024/12/10/7zip-CVE-2024-11477.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://pwntips.github.io/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tips &amp; Tricks</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
