<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.139.2">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    
    
      <link href="/posts/index.xml" rel="alternate" type="application/rss+xml" title="My New Hugo Site" />
      <link href="/posts/index.xml" rel="feed" type="application/rss+xml" title="My New Hugo Site" />
      
    

    
      <link rel="canonical" href="http://localhost:1313/posts/">
    

    <meta property="og:url" content="http://localhost:1313/posts/">
  <meta property="og:site_name" content="My New Hugo Site">
  <meta property="og:title" content="Posts">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Posts">
  <meta itemprop="datePublished" content="2024-11-29T16:25:02+08:00">
  <meta itemprop="dateModified" content="2024-11-29T16:25:02+08:00">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Posts">

	
  </head><body class="ma0 avenir bg-near-white development">

    

  <header>
    <div class="pb3-m pb6-l bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My New Hugo Site
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv3 ph3 ph4-ns">
        <h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">
          Posts
        </h1>
        
      </div>
    </div>
  </header>


    <main class="pb7" role="main">
      
  <article class="pa3 pa4-ns nested-copy-line-height">
    <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray"></section>
    <section class="flex-ns flex-wrap justify-around mt5">
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/my-first-post/" class="link black dim">
        My First Post
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      
    </div>
    <a href="/posts/my-first-post/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2023-02-19-common-cpp-std-algorithm/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h3 id="heading"></h3>
    </div>
    <a href="/posts/2023-02-19-common-cpp-std-algorithm/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2023-02-27-v8-builtin-code-addr/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h1 id="获取-v8-builtin-函数的地址">获取 v8 builtin 函数的地址</h1>
<p>v8 的 builtin 函数不是完全用 CPP 实现的，例如 CodeStubAssembler 是由 CPP 生成 tubrofan 的 IR，再由 turbofan 编译出机器码。所以这部分代码肯定不能像普通的 CPP 代码那样进行调试的。</p>
<p>搜索了一些材料以后发现了一些调试方法，这里记录一下：</p>
<ul>
<li>从 isolate-&gt;builtin 数组中找到对应的函数起始地址</li>
<li><a href="https://v8.dev/docs/gdb">https://v8.dev/docs/gdb</a> 记录的内容，这部分代码也是可以下断点</li>
<li></li>
</ul>
    </div>
    <a href="/posts/2023-02-27-v8-builtin-code-addr/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2023-03-12-msvc-stl-std-lock/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>对 std::lock 的规避死锁的方法感兴趣，分析一下相关代码</p>
<p>在 mutex 里找到 lock 的定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock0</span>, <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock1</span>, <span style="color:#66d9ef">class</span><span style="color:#960050;background-color:#1e0010">... </span><span style="color:#a6e22e">_LockN</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> lock(_Lock0<span style="color:#f92672">&amp;</span> _Lk0, _Lock1<span style="color:#f92672">&amp;</span> _Lk1, _LockN<span style="color:#f92672">&amp;</span>... _LkN) { <span style="color:#75715e">// lock multiple locks, without deadlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _Lock_nonmember1(_Lk0, _Lk1, _LkN...);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>_Lock_nonmember1 有两个重载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock0</span>, <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> _Lock_nonmember1(_Lock0<span style="color:#f92672">&amp;</span> _Lk0, _Lock1<span style="color:#f92672">&amp;</span> _Lk1) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// lock 2 locks, without deadlock, special case for better codegen and reduced metaprogramming for common case
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (_Lock_attempt_small(_Lk0, _Lk1) <span style="color:#f92672">&amp;&amp;</span> _Lock_attempt_small(_Lk1, _Lk0)) { <span style="color:#75715e">// keep trying
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock0</span>, <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock1</span>, <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Lock2</span>, <span style="color:#66d9ef">class</span><span style="color:#960050;background-color:#1e0010">... </span><span style="color:#a6e22e">_LockN</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> _Lock_nonmember1(_Lock0<span style="color:#f92672">&amp;</span> _Lk0, _Lock1<span style="color:#f92672">&amp;</span> _Lk1, _Lock2<span style="color:#f92672">&amp;</span> _Lk2, _LockN<span style="color:#f92672">&amp;</span>... _LkN) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// lock 3 or more locks, without deadlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> _Hard_lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (_Hard_lock <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        _Hard_lock <span style="color:#f92672">=</span> _Lock_attempt(_Hard_lock, _Lk0, _Lk1, _Lk2, _LkN...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>先看简单的情况，如果只有两个 mutex 会不断尝试以两种顺序加锁，如直到两个锁都获取到。</p>
    </div>
    <a href="/posts/2023-03-12-msvc-stl-std-lock/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2023-03-19-msvc-stl-future-promise/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>先看 <code>Promise</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span>classs _Ty<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">promise</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	promise()<span style="color:#f92672">:</span> _MyPromise(<span style="color:#66d9ef">new</span> _Associasted_state<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&gt;</span>) {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_Promise<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&gt;</span> _MyPromise;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Ty</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">promise</span><span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&amp;&gt;</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	promise()<span style="color:#f92672">:</span> _MyPromise(<span style="color:#66d9ef">new</span> _Associated_state<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">*&gt;</span>) {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_Promise<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">*&gt;</span> _MyPromise;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">promise</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	promise()<span style="color:#f92672">:</span> _MyPromise(<span style="color:#66d9ef">new</span> _Associate_state<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>) {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> _MyPromise;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Ty</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Promise</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_Promise(_Associate_satte<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&gt;*</span> _State_ptr) <span style="color:#f92672">:</span> _State(_State_ptr, false),  _Future_retrived(false) {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_State_manager<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&gt;</span> _State;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> _Future_retrived;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Ty</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_State_manager</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	_State_manager() <span style="color:#f92672">:</span> _Assoc_state
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>_Associated_state<span style="color:#f92672">&lt;</span>_Ty<span style="color:#f92672">&gt;*</span> _Assoc_state;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> _Get_only_once;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span>classs _Ty<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Associated_state</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
    </div>
    <a href="/posts/2023-03-19-msvc-stl-future-promise/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2023-09-26-cve-2022-4262/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      
    </div>
    <a href="/posts/2023-09-26-cve-2022-4262/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/cve-2023-05-20-v8-entry-frame/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h1 id="v8-栈帧系列1---entryframe">v8 栈帧系列1 - EntryFrame</h1>
<p>v8 中有多种不同的栈帧，了解这些栈帧是我们理解 v8 解释器/Builtin 代码的基础，所以我打算学习一下常用的栈帧的格式，先来最基础的 EntryFrame。</p>
<p>从 CPP 跳到 Javascript 的入口点是 Builtins_JSEntry 函数，这个函数是由汇编实现的，代码在 x64 架构上是在 src/builtins/x64/builtins-x64.cc:Builtins::Generate_JSEntry 函数， 这个函数序言就会在栈上构造一个 EntryFrame。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Builtins<span style="color:#f92672">::</span>Generate_JSEntry(MacroAssembler<span style="color:#f92672">*</span> masm) {
</span></span><span style="display:flex;"><span>  Generate_JSEntryVariant(masm, StackFrame<span style="color:#f92672">::</span>ENTRY,
</span></span><span style="display:flex;"><span>                          Builtins<span style="color:#f92672">::</span>kJSEntryTrampoline);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Called with the native C calling convention. The corresponding function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// signature is either:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   using JSEntryFunction = GeneratedCode&lt;Address(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//       Address root_register_value, Address new_target, Address target,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//       Address receiver, intptr_t argc, Address** argv)&gt;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   using JSEntryFunction = GeneratedCode&lt;Address(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//       Address root_register_value, MicrotaskQueue* microtask_queue)&gt;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Generate_JSEntryVariant</span>(MacroAssembler<span style="color:#f92672">*</span> masm, StackFrame<span style="color:#f92672">::</span>Type type,
</span></span><span style="display:flex;"><span>                             Builtins<span style="color:#f92672">::</span>Name entry_trampoline) {
</span></span><span style="display:flex;"><span>  Label invoke, handler_entry, exit;
</span></span><span style="display:flex;"><span>  Label not_outermost_js, not_outermost_js_2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {  <span style="color:#75715e">// NOLINT. Scope block confuses linter.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    NoRootArrayScope uninitialized_root_register(masm);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set up frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ pushq(rbp);
</span></span><span style="display:flex;"><span>    __ movq(rbp, rsp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Push the stack frame type.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ Push(Immediate(StackFrame<span style="color:#f92672">::</span>TypeToMarker(type)));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Reserve a slot for the context. It is filled after the root register has
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// been set up.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ AllocateStackSpace(kSystemPointerSize);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Save callee-saved registers (X64/X32/Win64 calling conventions).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ pushq(r12);
</span></span><span style="display:flex;"><span>    __ pushq(r13);
</span></span><span style="display:flex;"><span>    __ pushq(r14);
</span></span><span style="display:flex;"><span>    __ pushq(r15);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef _WIN64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ pushq(rdi);  <span style="color:#75715e">// Only callee save in Win64 ABI, argument in AMD64 ABI.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ pushq(rsi);  <span style="color:#75715e">// Only callee save in Win64 ABI, argument in AMD64 ABI.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ pushq(rbx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef _WIN64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// On Win64 XMM6-XMM15 are callee-save.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ AllocateStackSpace(EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegistersBlockSize);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">0</span>), xmm6);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>), xmm7);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>), xmm8);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>), xmm9);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>), xmm10);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>), xmm11);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>), xmm12);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>), xmm13);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>), xmm14);
</span></span><span style="display:flex;"><span>    __ movdqu(Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span>), xmm15);
</span></span><span style="display:flex;"><span>    STATIC_ASSERT(EntryFrameConstants<span style="color:#f92672">::</span>kCalleeSaveXMMRegisters <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    STATIC_ASSERT(EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegistersBlockSize <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>                  EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>                      EntryFrameConstants<span style="color:#f92672">::</span>kCalleeSaveXMMRegisters);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialize the root register.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// C calling convention. The first argument is passed in arg_reg_1.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __ movq(kRootRegister, arg_reg_1);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Save copies of the top frame descriptor on the stack.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ExternalReference c_entry_fp <span style="color:#f92672">=</span> ExternalReference<span style="color:#f92672">::</span>Create(
</span></span><span style="display:flex;"><span>      IsolateAddressId<span style="color:#f92672">::</span>kCEntryFPAddress, masm<span style="color:#f92672">-&gt;</span>isolate());
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    Operand c_entry_fp_operand <span style="color:#f92672">=</span> masm<span style="color:#f92672">-&gt;</span>ExternalReferenceAsOperand(c_entry_fp);
</span></span><span style="display:flex;"><span>    __ Push(c_entry_fp_operand);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Store the context address in the previously-reserved slot.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ExternalReference context_address <span style="color:#f92672">=</span> ExternalReference<span style="color:#f92672">::</span>Create(
</span></span><span style="display:flex;"><span>      IsolateAddressId<span style="color:#f92672">::</span>kContextAddress, masm<span style="color:#f92672">-&gt;</span>isolate());
</span></span><span style="display:flex;"><span>  __ Load(kScratchRegister, context_address);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> kOffsetToContextSlot <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> kSystemPointerSize;
</span></span><span style="display:flex;"><span>  __ movq(Operand(rbp, kOffsetToContextSlot), kScratchRegister);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If this is the outermost JS call, set js_entry_sp value.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ExternalReference js_entry_sp <span style="color:#f92672">=</span> ExternalReference<span style="color:#f92672">::</span>Create(
</span></span><span style="display:flex;"><span>      IsolateAddressId<span style="color:#f92672">::</span>kJSEntrySPAddress, masm<span style="color:#f92672">-&gt;</span>isolate());
</span></span><span style="display:flex;"><span>  __ Load(rax, js_entry_sp);
</span></span><span style="display:flex;"><span>  __ testq(rax, rax);
</span></span><span style="display:flex;"><span>  __ j(not_zero, <span style="color:#f92672">&amp;</span>not_outermost_js);
</span></span><span style="display:flex;"><span>  __ Push(Immediate(StackFrame<span style="color:#f92672">::</span>OUTERMOST_JSENTRY_FRAME));
</span></span><span style="display:flex;"><span>  __ movq(rax, rbp);
</span></span><span style="display:flex;"><span>  __ Store(js_entry_sp, rax);
</span></span><span style="display:flex;"><span>  Label cont;
</span></span><span style="display:flex;"><span>  __ jmp(<span style="color:#f92672">&amp;</span>cont);
</span></span><span style="display:flex;"><span>  __ bind(<span style="color:#f92672">&amp;</span>not_outermost_js);
</span></span><span style="display:flex;"><span>  __ Push(Immediate(StackFrame<span style="color:#f92672">::</span>INNER_JSENTRY_FRAME));
</span></span><span style="display:flex;"><span>  __ bind(<span style="color:#f92672">&amp;</span>cont);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Jump to a faked try block that does the invoke, with a faked catch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// block that sets the pending exception.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ jmp(<span style="color:#f92672">&amp;</span>invoke);
</span></span><span style="display:flex;"><span>  __ bind(<span style="color:#f92672">&amp;</span>handler_entry);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Store the current pc as the handler offset. It&#39;s used later to create the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// handler table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  masm<span style="color:#f92672">-&gt;</span>isolate()<span style="color:#f92672">-&gt;</span>builtins()<span style="color:#f92672">-&gt;</span>SetJSEntryHandlerOffset(handler_entry.pos());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Caught exception: Store result (exception) in the pending exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// field in the JSEnv and return a failure sentinel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ExternalReference pending_exception <span style="color:#f92672">=</span> ExternalReference<span style="color:#f92672">::</span>Create(
</span></span><span style="display:flex;"><span>      IsolateAddressId<span style="color:#f92672">::</span>kPendingExceptionAddress, masm<span style="color:#f92672">-&gt;</span>isolate());
</span></span><span style="display:flex;"><span>  __ Store(pending_exception, rax);
</span></span><span style="display:flex;"><span>  __ LoadRoot(rax, RootIndex<span style="color:#f92672">::</span>kException);
</span></span><span style="display:flex;"><span>  __ jmp(<span style="color:#f92672">&amp;</span>exit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Invoke: Link this frame into the handler chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ bind(<span style="color:#f92672">&amp;</span>invoke);
</span></span><span style="display:flex;"><span>  __ PushStackHandler();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Invoke the function by calling through JS entry trampoline builtin and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pop the faked function when we return.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Handle<span style="color:#f92672">&lt;</span>Code<span style="color:#f92672">&gt;</span> trampoline_code <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      masm<span style="color:#f92672">-&gt;</span>isolate()<span style="color:#f92672">-&gt;</span>builtins()<span style="color:#f92672">-&gt;</span>builtin_handle(entry_trampoline);
</span></span><span style="display:flex;"><span>  __ Call(trampoline_code, RelocInfo<span style="color:#f92672">::</span>CODE_TARGET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Unlink this frame from the handler chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ PopStackHandler();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  __ bind(<span style="color:#f92672">&amp;</span>exit);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if the current stack frame is marked as the outermost JS frame.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ Pop(rbx);
</span></span><span style="display:flex;"><span>  __ cmpq(rbx, Immediate(StackFrame<span style="color:#f92672">::</span>OUTERMOST_JSENTRY_FRAME));
</span></span><span style="display:flex;"><span>  __ j(not_equal, <span style="color:#f92672">&amp;</span>not_outermost_js_2);
</span></span><span style="display:flex;"><span>  __ Move(kScratchRegister, js_entry_sp);
</span></span><span style="display:flex;"><span>  __ movq(Operand(kScratchRegister, <span style="color:#ae81ff">0</span>), Immediate(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  __ bind(<span style="color:#f92672">&amp;</span>not_outermost_js_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Restore the top frame descriptor from the stack.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    Operand c_entry_fp_operand <span style="color:#f92672">=</span> masm<span style="color:#f92672">-&gt;</span>ExternalReferenceAsOperand(c_entry_fp);
</span></span><span style="display:flex;"><span>    __ Pop(c_entry_fp_operand);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Restore callee-saved registers (X64 conventions).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef _WIN64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// On Win64 XMM6-XMM15 are callee-save
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ movdqu(xmm6, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm7, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm8, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm9, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm10, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm11, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm12, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm13, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm14, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  __ movdqu(xmm15, Operand(rsp, EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegisterSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span>));
</span></span><span style="display:flex;"><span>  __ addq(rsp, Immediate(EntryFrameConstants<span style="color:#f92672">::</span>kXMMRegistersBlockSize));
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  __ popq(rbx);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef _WIN64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Callee save on in Win64 ABI, arguments/volatile in AMD64 ABI.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ popq(rsi);
</span></span><span style="display:flex;"><span>  __ popq(rdi);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ popq(r15);
</span></span><span style="display:flex;"><span>  __ popq(r14);
</span></span><span style="display:flex;"><span>  __ popq(r13);
</span></span><span style="display:flex;"><span>  __ popq(r12);
</span></span><span style="display:flex;"><span>  __ addq(rsp, Immediate(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> kSystemPointerSize));  <span style="color:#75715e">// remove markers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Restore frame pointer and return.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __ popq(rbp);
</span></span><span style="display:flex;"><span>  __ ret(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>EntryFrame 的作用主要是保存 CPP 调用的现场，以便在 Javascript 执行完毕后返回到 上一层的 CPP 的代码中继续执行，保存的内容如下：</p>
    </div>
    <a href="/posts/cve-2023-05-20-v8-entry-frame/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2022-06-08-chromium-build-error/" class="link black dim">
        Chrome 构建错误
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h2 id="lld-link-error-invalid-timestamp--2142000-expected-32-bit-integer">lld-link: error: invalid timestamp: -2142000. Expected 32-bit integer</h2>
<p>build\util\LASTCHANGE.committime 文件内容为 0 导致的。
此文件里记录的应该是从 git 日志中提取的上次 commit 的时间戳，如果获取失败了默认填入 0。
手工改成合理的时间戳( epoch ) 再重新执行 gn 即可。</p>
<h2 id="openssl-config-gailed-error25078067">openssl config gailed: error:25078067</h2>
<pre tabindex="0"><code>FAILED: gen/chrome/browser/resources/settings/vulcanized.html gen/chrome/browser/resources/settings/lazy_load.vulcanized.html gen/chrome/browser/resources/settings/crisper.js gen/chrome/browser/resources/settings/lazy_load.crisper.js
d:/depot_tools/bootstrap-2@3_8_10_chromium_23_bin/python/bin/python.exe ../../chrome/browser/resources/optimize_webui.py --host settings --input gen/chrome/browser/resources/settings/settings_resources.unpak --out_folder gen/chrome/browser/resources/settings --depfile gen/chrome/browser/resources/settings/build.d --js_out_files crisper.js lazy_load.crisper.js --exclude chrome://resources/mojo/chromeos/services/network_config/public/mojom/cros_network_config.mojom.html --html_in_files settings.html lazy_load.html --html_out_files vulcanized.html lazy_load.vulcanized.html --insert_in_head &#34;&lt;base href=\&#34;chrome://settings\&#34;&gt;&#34;
Traceback (most recent call last):
  File &#34;../../chrome/browser/resources/optimize_webui.py&#34;, line 363, in &lt;module&gt;
    main(sys.argv[1:])
  File &#34;../../chrome/browser/resources/optimize_webui.py&#34;, line 346, in main
    manifest_out_path = _optimize(args.input, args)
  File &#34;../../chrome/browser/resources/optimize_webui.py&#34;, line 300, in _optimize
    manifest_out_path, args, excludes)
  File &#34;../../chrome/browser/resources/optimize_webui.py&#34;, line 273, in _bundle_v2
    &#39;--js&#39;, os.path.join(tmp_out_dir, js_out_file)])
  File &#34;..\..\third_party\node\node.py&#34;, line 27, in RunNode
    raise RuntimeError(&#39;%s failed: %s&#39; % (cmd, stderr))
RuntimeError: ..\..\third_party\node\win\node.exe ..\..\third_party\node\node_modules\crisper\bin\crisper --source D:/chromium2/src/out/CVE-2020-6418/gen/chrome/browser/resources/settings/bundled\settings.html --script-in-head false --html D:/chromium2/src/out/CVE-2020-6418/gen/chrome/browser/resources/settings/bundled\vulcanized.html --js D:/chromium2/src/out/CVE-2020-6418/gen/chrome/browser/resources/settings/bundled\crisper.js failed: openssl config failed: error:25078067:DSO support routines:win32_load:could not load the shared library
</code></pre><p>出现这个错误是因为设置了 <code>OPENSSL_CONF</code> 环境变量，把这个环境变量置空可以解决。</p>
    </div>
    <a href="/posts/2022-06-08-chromium-build-error/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2022-06-24-v8-parameters/" class="link black dim">
        Chromium 和 v8 的一些参数（WIP)
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h1 id="v8-参数">V8 参数</h1>
<h2 id="构建参数">构建参数</h2>
<ul>
<li>v8_enable_snapshot_code_comments = false # 编译 builtins 函数时带上相应的注释，有助于我们调试时快速了解 builtins 函数的意义</li>
</ul>
<h2 id="调试函数">调试函数</h2>
<p>v8 提供了一些可以辅助调试的 Runtime 函数，命令行中指定 &ndash;allow-natives-syntax 后就可以在 JavaScript 代码中使用，常用的如下：</p>
<ul>
<li>%DebugPrint()</li>
<li>%SystemBreak()</li>
</ul>
<h3 id="编译中间结果">编译中间结果</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>--print-ast
</span></span><span style="display:flex;"><span>--trace-turbo
</span></span></code></pre></div><h2 id="chrome-命令参数">Chrome 命令参数</h2>
<p>上面的 v8 参数 Chrome 也是支持的，但是用法和给 d8 指定时有些区别：</p>
<ul>
<li>v8 的参数要放到&ndash;js-flags=中，例如 chrome.exe &ndash;js-flags=&quot;&ndash;trace-turbo&quot;</li>
<li>还要额外加上 &ndash;no-sandbox 参数，否则 v8 引擎所在的渲染进程是在沙箱中运行的，没法输出日志到控制台或者文件中</li>
<li>需要指定 &ndash;enable-<em>logging</em>=stderr 参数，这样 chrome 才会把 %DebugPrint() 一类的输出，输出到进程所属控制台</li>
<li>例如：在命令行执行  <code>chrome.exe --no-sandbox --enable-logging=stderr --js-flags=&quot;--help&quot;</code> 之后会看到 v8 命令的帮助</li>
</ul>
    </div>
    <a href="/posts/2022-06-24-v8-parameters/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/2022-04-30-ctf-oob-v8/" class="link black dim">
        CTF oob-v8
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>参照 <a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">starctf-oob-v8-indepth</a> 完成 CTF 题目 oob-v8，学习 v8 漏洞利用。</p>
<h2 id="准备">准备</h2>
<p>参照<a href="https://v8.dev/docs/build">官方文档</a>准备 v8 的构建环境。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 有 Chromium 的构建环境话，把构建命令改成 <code>autoninja -C out\Default\ d8</code> 就可以构建 d8.exe。</p>
<hr>
<h2 id="题目">题目</h2>
<p>题目修改了 v8 源码，给数组添加了一个有漏洞的函数 <code>oob</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc
</span></span><span style="display:flex;"><span>index b027d36..ef1002f 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/bootstrapper.cc
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/bootstrapper.cc
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                           Builtins::kArrayPrototypeCopyWithin, 2, false);
</span></span><span style="display:flex;"><span>     SimpleInstallFunction(isolate_, proto, &#34;fill&#34;,
</span></span><span style="display:flex;"><span>                           Builtins::kArrayPrototypeFill, 1, false);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    SimpleInstallFunction(isolate_, proto, &#34;oob&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+                          Builtins::kArrayOob,2,false);
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>     SimpleInstallFunction(isolate_, proto, &#34;find&#34;,
</span></span><span style="display:flex;"><span>                           Builtins::kArrayPrototypeFind, 1, false);
</span></span><span style="display:flex;"><span>     SimpleInstallFunction(isolate_, proto, &#34;findIndex&#34;,
</span></span><span style="display:flex;"><span>diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span><span style="display:flex;"><span>index 8df340e..9b828ab 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   return *final_length;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> }  // namespace
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+BUILTIN(ArrayOob){
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    uint32_t len = args.length();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    if(len == 1){
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        //read
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    }else{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        //write
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        Handle&lt;Object&gt; value;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        elements.set(length,value-&gt;Number());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>
</span></span><span style="display:flex;"><span> BUILTIN(ArrayPush) {
</span></span><span style="display:flex;"><span>   HandleScope scope(isolate);
</span></span><span style="display:flex;"><span>diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
</span></span><span style="display:flex;"><span>index 0447230..f113a81 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/builtins/builtins-definitions.h
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/builtins/builtins-definitions.h
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -368,6 +368,7 @@ namespace internal {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \
</span></span><span style="display:flex;"><span>   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \
</span></span><span style="display:flex;"><span>   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+  CPP(ArrayOob)                                                                \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>                                                                                \
</span></span><span style="display:flex;"><span>   /* ArrayBuffer */                                                            \
</span></span><span style="display:flex;"><span>   /* ES #sec-arraybuffer-constructor */                                        \
</span></span><span style="display:flex;"><span>diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
</span></span><span style="display:flex;"><span>index ed1e4a5..c199e3a 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/compiler/typer.cc
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/compiler/typer.cc
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       return Type::Receiver();
</span></span><span style="display:flex;"><span>     case Builtins::kArrayUnshift:
</span></span><span style="display:flex;"><span>       return t-&gt;cache_-&gt;kPositiveSafeInteger;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    case Builtins::kArrayOob:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      return Type::Receiver();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>
</span></span><span style="display:flex;"><span>     // ArrayBuffer functions.
</span></span><span style="display:flex;"><span>     case Builtins::kArrayBufferIsView:
</span></span></code></pre></div><p>这段代码定义了 builtins 函数 <code>ArrayOob</code>，把它赋值到 <code>Array.prototype.oob</code>。</p>
    </div>
    <a href="/posts/2022-04-30-ctf-oob-v8/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
    </section>
    <ul class="pagination pagination-default">
      <li class="page-item disabled">
        <a aria-disabled="true" aria-label="First" class="page-link" role="button" tabindex="-1"><span aria-hidden="true">&laquo;&laquo;</span></a>
      </li>
      <li class="page-item disabled">
        <a aria-disabled="true" aria-label="Previous" class="page-link" role="button" tabindex="-1"><span aria-hidden="true">&laquo;</span></a>
      </li>
      <li class="page-item active">
        <a aria-current="page" aria-label="Page 1" class="page-link" role="button">1</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/2/" aria-label="Page 2" class="page-link" role="button">2</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/3/" aria-label="Page 3" class="page-link" role="button">3</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/2/" aria-label="Next" class="page-link" role="button"><span aria-hidden="true">&raquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/page/3/" aria-label="Last" class="page-link" role="button"><span aria-hidden="true">&raquo;&raquo;</span></a>
      </li>
    </ul></article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  My New Hugo Site 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
